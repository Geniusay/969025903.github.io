<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='å­¦ä¹ Java JUCæ‰€ä½œç¬”è®°ï¼Œä»ä½¿ç”¨åˆ°æºç åº”æœ‰å°½æœ‰'><title>JUCå¹¶å‘ç¼–ç¨‹-ä»å…¥é—¨åˆ°å•çº¿ç¨‹</title>

<link rel='canonical' href='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='JUCå¹¶å‘ç¼–ç¨‹-ä»å…¥é—¨åˆ°å•çº¿ç¨‹'>
<meta property='og:description' content='å­¦ä¹ Java JUCæ‰€ä½œç¬”è®°ï¼Œä»ä½¿ç”¨åˆ°æºç åº”æœ‰å°½æœ‰'>
<meta property='og:url' content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/'>
<meta property='og:site_name' content='Genius'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='JUC' /><meta property='article:tag' content='Java' /><meta property='article:published_time' content='2022-09-08T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-09-08T00:00:00&#43;00:00'/><meta property='og:image' content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1.jpg' />
<meta name="twitter:site" content="@genius">
    <meta name="twitter:creator" content="@genius"><meta name="twitter:title" content="JUCå¹¶å‘ç¼–ç¨‹-ä»å…¥é—¨åˆ°å•çº¿ç¨‹">
<meta name="twitter:description" content="å­¦ä¹ Java JUCæ‰€ä½œç¬”è®°ï¼Œä»ä½¿ç”¨åˆ°æºç åº”æœ‰å°½æœ‰"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1.jpg' />
    <link rel="shortcut icon" href="/img/Genius.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Genius_hua95d8fe85c65c73f01d0951a42335663_30321_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¬</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Genius</a></h1>
            <h2 class="site-description">&#34;ç°åœ¨æˆ‘ç”¨æ²‰é™çš„ç›®å…‰è§åˆ° æ°æ˜¯é‚£å°æœºå™¨è„‰å†²çš„é¢¤è·³&#34;</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://gitee.com/sbg-genius'
                        target="_blank"
                        title="Gitee"
                    >
                        
                        
                            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve">  <image id="image0" width="24" height="24" x="0" y="0"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACZ1BMVEUAAAD/AADcABHbABPZ
ABLZABPZABPbABH/AADZABPbABPZABKqAADZABHaABPZBBbaBRjaBRjZBRfbBhjZBhfYABLZARTZ
ABDWAADWAADWAADYABXbAA/dABLbABLaARPnXGjsgInsgYrhLDvcAAvbAxjfAA3ZABLeABLZAhPY
AAvjTFb409bsgInaAADbBhjZABPXAAfthpDVAADaABPdABLcABPZAA/64OLzsLbXAAfdAxXZAxbX
AAHnX2vZABDaABPYABHeABLaBRfZABHZABLaBBjXAAjZAhXaBBfbBRjYABPZBRjlU2HXAATZAxXd
BBf3yczZARHsfonZABTsgov51tnjS1bYAArZARTbAAvhLDzmWWXaARTaABLYABTYABLkABPdABLb
ABLZABPmABPZARPaBRfnBRjbABPWAAPVAADZAADZAAvWAAfaDyHqeYLsf4nrfoj////lWWT9/Pzn
BRncGCb++/v9/v31wMXysLbzs7jysrfzsbbiRFL+/f3++/z+/v7mY27ZDRfZBxraCBraBxnaBxrZ
BxnZBRjUAADqeoT2zM/aCx3XAAvWAAbXAAnXAAjXAAfYABT0vsLaECHWAQjgO0nvlp3vmJ/umJ/v
maDgOEf1wMTbEyTshI7shY7+/Pz98/T++vrrfYfaECLWAAjvlp7xp6788fL9+/v0vcHZCRzYABDX
AArVAAHZBhj2ztH+///qd4H2y8/cGSrYAxLZCBrkU1/99/f+/f7sfoj9+fn1wcbyr7Tysbf0vML8
9vb+/P3ZEBroBBj++fn98vP++fr89vfgOkfqeILaDR+weo5OAAAAYXRSTlMAAixptNjyaQEok/ID
WOX7/f775Vhw+f3+/flvVP3+/P7+/P79VCjn/vz+/v78/ueT/v75Ke/8/f7+/fz7/v7+/vv9/f3Y
/v7+/f3y+/7++/z+/f75/P7+/vz9/v78/nBvjqLsXwAAAAFiS0dEc0EJPc4AAAAHdElNRQfmCQgN
IifODXi5AAAB2ElEQVQoz2NgAAJGBgYmZhZWNjZWFnYmMBcCOBg4ubgTk5JTUpKTErm5OIECYMDD
wMuXmsYvIAgEAkLpGcIiQCGwetHMJDHxLAmJ7GwglpTKyZUG6eFgkJGVk8/LVygoLCosLFQsKlJS
VlEFyaipa2hqaesUI4Cunr4a0AaDVDHDktLiUoSEkXGZAQ+DiamZeblFcUVlVXUNCNTWWdZbWZua
MDAn2tjaNTQ2Nbe0trV3tLd3tnXZOzgmMjOwODl39zQ19fb190+YOAkIJk7un+LixMLgmukmUdhU
PHXa9BkzZ82eM2f2rJlz3T0yXRnYUjyzi4qb5s3vXgCzfGG3VwobUEIgu7C4GC6xaPGSpdmeKd5A
owQlCoE6li0HGjVnxcpVq5sKJdyARrE4CXQDdaxZu279hInrN2zctLlpS7cz0HLmRB8JxeKmrdu2
t7W172jZuWt3g6+fP9C5JqYBknuK9y7atx/ouwMHDx0uDjwSZAb0II/BUePgY8dPQF3UVHzylHtI
KjBIGNT09UIR4bQ5LDwiUkNdDRTsqlHRSkVFisAwLyo8HXMmLzZOVgYSIfG5OVKS2ZCIyhIXS8pM
gEQuD4OIcEa6ECRq+dNS+XghUYs7MWBPPgB7urAPCsOxQQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAy
Mi0wOS0wOFQxMTozNDozOSswMjowMO4S2dMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjItMDktMDhU
MTE6MzQ6MzkrMDI6MDCfT2FvAAAAAElFTkSuQmCC" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/969025903'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äºGenius</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/">
                <img src="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_800x0_resize_q75_box.jpg"
                        srcset="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_800x0_resize_q75_box.jpg 800w, /p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="451" 
                        loading="lazy"
                        alt="Featured image of post JUCå¹¶å‘ç¼–ç¨‹-ä»å…¥é—¨åˆ°å•çº¿ç¨‹" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/java/" style="background-color: #2a9d8f; color: #fff;">
                Java
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/">JUCå¹¶å‘ç¼–ç¨‹-ä»å…¥é—¨åˆ°å•çº¿ç¨‹</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            å­¦ä¹ Java JUCæ‰€ä½œç¬”è®°ï¼Œä»ä½¿ç”¨åˆ°æºç åº”æœ‰å°½æœ‰
        </h3>
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 08, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    91 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h1 id="å¹¶å‘juc">å¹¶å‘JUC</h1>
<h2 id="1-å¹¶å‘ç¼–ç¨‹">1 å¹¶å‘ç¼–ç¨‹</h2>
<h3 id="11-å¹¶å‘ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹">1.1 å¹¶å‘ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹</h3>
<h4 id="ä¼˜ç‚¹">ä¼˜ç‚¹ï¼š</h4>
<ul>
<li>åˆ©ç”¨å¤šæ ¸CPUæé«˜è®¡ç®—èƒ½åŠ›ï¼Œæé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦</li>
<li>å¯ä»¥å°†ä¸€ä¸ªäº‹æƒ…æ‹†æˆå¤šéƒ¨åˆ†ï¼Œäº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥åˆ†åˆ«è¿è¡Œï¼Œæé«˜ä¸šåŠ¡å®Œæˆæ•ˆç‡ï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹">ç¼ºç‚¹ï¼š</h4>
<ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„åŸå­æ€§ç ´å</li>
<li>å†…å­˜æ³„æ¼</li>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>çº¿ç¨‹æ­»é”</li>
</ul>
<h3 id="12-å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ">1.2 å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ </h3>
<h4 id="å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ">å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ </h4>
<ul>
<li>åŸå­æ€§ï¼šå³ä¸€ä¸ªå¾®ç²’ä¸å¯å†åˆ†ï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥</li>
<li>æœ‰åºæ€§ï¼šç¨‹åºæŒ‰ç…§ä»£ç å—é¡ºåºæ‰§è¡Œ</li>
<li>å¯è§æ€§ï¼šå…¶ä»–çº¿ç¨‹å¯ä»¥å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œè¿›è¡ŒåŠæ—¶è§‚æµ‹ã€‚</li>
</ul>
<h4 id="å‡ºç°å®‰å…¨é—®é¢˜çš„åŸå› ">å‡ºç°å®‰å…¨é—®é¢˜çš„åŸå› ï¼š</h4>
<ul>
<li>çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„åŸå­æ€§é—®é¢˜</li>
<li>ç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜</li>
<li>ç¼–è¯‘ä¼˜åŒ–å¸¦æ¥çš„æœ‰åºæ€§é—®é¢˜</li>
</ul>
<h4 id="ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸Šä¸‹æ–‡åˆ‡æ¢</h4>
<p>çº¿ç¨‹éœ€è¦å°†CPUçš„ä½¿ç”¨æƒåŠ›äº¤ç»™å…¶ä»–çº¿ç¨‹æ—¶ï¼Œä¼šå¯¹è‡ªèº«çº¿ç¨‹ä»»åŠ¡ä¿å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶å¯ä»¥å†æ¬¡åŠ è½½è¿™ä¸ªä»»åŠ¡çŠ¶æ€</p>
<h3 id="13-ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹">1.3 ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹</h3>
<p><strong>å¤šçº¿ç¨‹æŒ‡çš„å°±æ˜¯åœ¨ä¸€ä¸ªç¨‹åºåŒ…å«å¤šä¸ªæ‰§è¡Œæµï¼Œå¯ä»¥ç”¨å¤šä¸ªä¸åŒçº¿ç¨‹å®Œæˆå¤šä¸ªä¸åŒäº‹æƒ…</strong></p>
<h2 id="2-è¿›ç¨‹ä¸çº¿ç¨‹çš„ä»‹ç»">2 è¿›ç¨‹ä¸çº¿ç¨‹çš„ä»‹ç»</h2>
<h3 id="21-è¿›ç¨‹ä¸çº¿ç¨‹">2.1 è¿›ç¨‹ä¸çº¿ç¨‹</h3>
<h4 id="è¿›ç¨‹">è¿›ç¨‹</h4>
<ul>
<li>è¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºçš„ä»£ç ä»ç£ç›˜åŠ è½½è‡³å†…å­˜è¿è¡Œçš„è¿‡ç¨‹</li>
<li>ç¨‹åºæ˜¯ç”±æŒ‡ä»¤å’Œæ•°æ®ç»„åˆè€Œæˆçš„ï¼ŒæŒ‡ä»¤æƒ³è¦è¿è¡Œï¼Œæ•°æ®éœ€è¦è¯»å†™ï¼Œå°±éœ€è¦æŠŠæŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚è¿›ç¨‹åˆ™æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†å†…å­˜ï¼Œç®¡ç†IO</li>
<li>è¿›ç¨‹å¯ä»¥è§†ä¸ºç¨‹åºçš„å®ä¾‹ï¼Œä¸€ä¸ªç¨‹åºå¯ä»¥å¯¹åº”å¤šä¸ªè¿›ç¨‹</li>
</ul>
<h4 id="çº¿ç¨‹">çº¿ç¨‹</h4>
<ul>
<li>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹</li>
<li>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼ŒæŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤äº¤ç»™CPUæ¥æ‰§è¡Œ</li>
<li>åœ¨Javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°çš„è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºæœ€å°çš„èµ„æºåˆ†é…å•ä½ï¼Œwindowsä¸­è¿›ç¨‹ä¸æ´»åŠ¨ï¼Œåªä½œä¸ºçº¿ç¨‹çš„å®¹å™¨</li>
</ul>
<h4 id="è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«">è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«</h4>
<p>çº¿ç¨‹å…·æœ‰è®¸å¤šä¼ ç»Ÿè¿›ç¨‹æ‰€å…·æœ‰çš„ç‰¹å¾ï¼Œæ•…åˆç§°ä¸ºè½»å‹è¿›ç¨‹(Lightâ€”Weight Process)æˆ–è¿›ç¨‹å…ƒï¼›è€ŒæŠŠä¼ ç»Ÿçš„è¿›ç¨‹ç§°ä¸ºé‡å‹è¿›ç¨‹(Heavyâ€”Weight Process)ï¼Œå®ƒç›¸å½“äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡ã€‚åœ¨å¼•å…¥äº†çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè‡³å°‘åŒ…å«ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<ul>
<li>
<p>**æ ¹æœ¬åŒºåˆ«ï¼š**è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯å¤„ç†å™¨ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½</p>
</li>
<li>
<p>**èµ„æºå¼€é”€ï¼š**æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œç¨‹åºä¹‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€ï¼›çº¿ç¨‹å¯ä»¥çœ‹åšè½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢çš„å¼€é”€å°ã€‚</p>
</li>
<li>
<p>**åŒ…å«å…³ç³»ï¼š**å¦‚æœä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯ä¸€æ¡çº¿çš„ï¼Œè€Œæ˜¯å¤šæ¡çº¿ï¼ˆçº¿ç¨‹ï¼‰å…±åŒå®Œæˆçš„ï¼›çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»æƒè¿›ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹ã€‚</p>
</li>
<li>
<p>**å†…å­˜åˆ†é…ï¼š**åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æºï¼Œè€Œè¿›ç¨‹ä¹‹é—´çš„åœ°å€ç©ºé—´å’Œèµ„æºæ˜¯ç›¸äº’ç‹¬ç«‹çš„</p>
</li>
<li>
<p>**å½±å“å…³ç³»ï¼š**ä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ•´ä¸ªè¿›ç¨‹éƒ½æ­»æ‰ã€‚æ‰€ä»¥å¤šè¿›ç¨‹è¦æ¯”å¤šçº¿ç¨‹å¥å£®ã€‚</p>
</li>
<li>
<p>**æ‰§è¡Œè¿‡ç¨‹ï¼š**æ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå‡ºå£ã€‚ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ï¼Œä¸¤è€…å‡å¯å¹¶å‘æ‰§è¡Œ</p>
</li>
</ul>
<h4 id="äºŒè€…å¯¹æ¯”">äºŒè€…å¯¹æ¯”</h4>
<ul>
<li>
<p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹ï¼Œçº¿ç¨‹æ˜¯è¿›ç¨‹çš„å­é›†</p>
</li>
<li>
<p>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå†…å­˜ç©ºé—´ï¼Œä¾›è¿›ç¨‹å­é›†ä½¿ç”¨</p>
</li>
<li>
<p>è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡è¾ƒä¸ºå¤æ‚</p>
<ul>
<li>
<p>æœ¬æœºè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ç§°ä¸ºIPC</p>
</li>
<li>
<p>ä¸åŒè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡åˆ™éœ€è¦ä½¿ç”¨ç½‘ç»œï¼Œå¹¶ä¸”éµå®ˆé€šè®¯åè®®ï¼Œä¾‹å¦‚HTTP</p>
</li>
</ul>
</li>
<li>
<p>è¿›ç¨‹ä¹‹é—´é€šä¿¡è¾ƒä¸ºç®€å•ï¼Œå› ä¸ºå…±äº«è¿›ç¨‹ä¸­çš„å†…å­˜ã€‚</p>
</li>
<li>
<p>çº¿ç¨‹æ›´åŠ è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬è¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½(ä¸Šä¸‹æ–‡åˆ‡æ¢éœ€è¦æ¶ˆè€—æ—¶é—´)</p>
</li>
</ul>
<h3 id="22-å¹¶è¡Œå’Œå¹¶å‘">2.2 å¹¶è¡Œå’Œå¹¶å‘</h3>
<h4 id="å¹¶è¡Œ">å¹¶è¡Œ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220312194921322.png"
	
	
	
	loading="lazy"
	
		alt="image-20220312194921322"
	
	
></p>
<p>ä¸¤ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹åŒæ—¶å¼€å§‹ï¼ŒåŒæ—¶æ‰§è¡Œ</p>
<h4 id="å¹¶å‘">å¹¶å‘</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220312194931459.png"
	
	
	
	loading="lazy"
	
		alt="image-20220312194931459"
	
	
></p>
<p>ä¸¤ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹åŒæ—¶å¼€å§‹ï¼ŒæŒ‰ç…§è°ƒåº¦ç®—æ³•è½®æµæ‰§è¡Œ</p>
<h3 id="23-åŒæ­¥ä¸å¼‚æ­¥">2.3 åŒæ­¥ä¸å¼‚æ­¥</h3>
<h4 id="åŒæ­¥">åŒæ­¥</h4>
<p>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</p>
<p>**æ³¨ï¼š**åœ¨å¤šçº¿ç¨‹ä¸­ï¼ŒåŒæ­¥è¿˜æœ‰ä¸€ä¸ªæ„æ€æ˜¯è®©çº¿ç¨‹æ­¥è°ƒä¸€è‡´</p>
<h4 id="å¼‚æ­¥">å¼‚æ­¥</h4>
<p>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</p>
<h3 id="24-æ€è€ƒ">2.4 æ€è€ƒ</h3>
<h4 id="å¤šçº¿ç¨‹ä¸€å®šèƒ½æå‡ç¨‹åºè¿è¡Œæ•ˆç‡å—">å¤šçº¿ç¨‹ä¸€å®šèƒ½æå‡ç¨‹åºè¿è¡Œæ•ˆç‡å—ï¼Ÿ</h4>
<p>1ï¼Œ<strong>å•æ ¸CPUä¸‹</strong>ï¼Œå•æ ¸CPUä¸‹å¤šçº¿ç¨‹å¹¶ä¸èƒ½æå‡ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯èƒ½å¤Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸­è¿›è¡Œåˆ‡æ¢ï¼Œåè€Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¤šçº¿ç¨‹çš„è¿è¡Œæ•ˆç‡æ˜¯ä½äºå•çº¿ç¨‹çš„ï¼ˆå› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯éœ€è¦è€—è´¹æ—¶é—´çš„)</p>
<p>2ï¼Œ<strong>å¤šæ ¸CPUä¸‹</strong>ï¼Œå¤šæ ¸CPUå¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„</p>
<ul>
<li>æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡è¿›è¡Œè®¾è®¡ï¼Œä»»åŠ¡æ‹†åˆ†ï¼Œå¯ä»¥æé«˜è¿è¡Œæ•ˆç‡ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„è®¡ç®—ä»»åŠ¡éƒ½èƒ½è¿›è¡Œæ‹†åˆ†</li>
</ul>
<p>3ï¼ŒIOæ“ä½œä¸å ç”¨CPUï¼Œè¿™æ—¶çš„çº¿ç¨‹æ— éœ€ä½¿ç”¨CPUï¼Œä½†å´è¦ä¸€ç›´ç­‰å¾…IOç»“æŸï¼Œä¸èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ï¼Œä½†æ˜¯å¯ä»¥ç”¨<strong>NIO</strong>ï¼Œä»¥åŠ<strong>AIO</strong>è¿›è¡Œä¼˜åŒ–</p>
<h2 id="3-javaçº¿ç¨‹">3 Javaçº¿ç¨‹</h2>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220908175513859.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="31-åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹">3.1 åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</h3>
<h4 id="threadåˆ›å»º">Threadåˆ›å»º</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByThread</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">name</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runnableåˆ›å»º">Runnableåˆ›å»º</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByRunnable</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lambdaç®€åŒ–">Lambdaç®€åŒ–</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByLambda</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;{</span><span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="futuretaskåˆ›å»º">FutureTaskåˆ›å»º</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">createThreadFutureTask</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>FutureTaskå’ŒCallableæ¥å£ç»“åˆï¼Œå³å¯è¿”å›ä¸€ä¸ªä»»æ„ç±»å‹çš„å€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="n">createThreadFutureTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">,</span><span class="s">&#34;Genius4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;result:{}&#34;</span><span class="o">,</span><span class="n">task</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºFutureTaskä½¿ç”¨äº†runnableæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥å°†taskä½œä¸ºThreadçš„åˆå§‹åŒ–å‚æ•°ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨task.getè·å–è¿”å›çš„å€¼</p>
<h4 id="runnableå’Œcallableçš„åŒºåˆ«">Runnableå’ŒCallableçš„åŒºåˆ«</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to create a thread, starting the thread causes the object&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing
</span></span></span><span class="line"><span class="cl"><span class="cm">     * thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may
</span></span></span><span class="line"><span class="cl"><span class="cm">     * take any action whatsoever.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see     java.lang.Thread#run()
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Computes a result, or throws an exception if unable to do so.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return computed result
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception if unable to compute a result
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Runnableä¸­çš„runæ— è¿”å›å€¼ï¼›Callableæ¥å£ä¸­çš„callä¼šè¿”å›è¿”å›å€¼ï¼Œå¯ä»¥é…åˆFutureTaskå®Œæˆå¼‚æ­¥æ“ä½œã€‚</p>
</li>
<li>
<p>runæ–¹æ³•åªèƒ½æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸æ— æ³•æ•è·å¤„ç†å¼‚å¸¸ï¼Œè€ŒCallableå¯ä»¥è·å–å¼‚å¸¸ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p>Callableä¸­çš„è¿”å›ç»“æœé€šè¿‡FutureTask.get()è·å¾—ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<h3 id="32-threadrunnableæºç åŸç†">3.2 Threadï¼ŒRunnableæºç åŸç†</h3>
<h4 id="new-thread">new Thread()</h4>
<ul>
<li><strong>Thread() -&gt; init() -&gt; this.target = target(runnable)</strong></li>
</ul>
<p>1ï¼Œè‹¥Threadä¸­name ä¸ºç©ºåˆ™ä¼šè°ƒç”¨nextThreadNum()æ ¹æ®å½“å‰çš„çº¿ç¨‹æ•°é‡æ¥å‘½åï¼Œå…¶ä¸­threadInitNumberä¸ºå…¨å±€å˜é‡ä¸”å¯¹nextThreadNum()æ–¹æ³•åŠ é”ï¼Œé˜²æ­¢çº¿ç¨‹é”™è¯¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">AccessControlContext</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="s">&#34;Thread-&#34;</span> <span class="o">+</span> <span class="n">nextThreadNum</span><span class="o">(),</span> <span class="n">0</span><span class="o">,</span> <span class="n">acc</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">threadInitNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">nextThreadNum</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadInitNumber</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ï¼Œé€šè¿‡å¤šæ¬¡init()æ–¹æ³•çš„åµŒå¥—ï¼Œå°†targetèµ‹å€¼ç»™å½“å‰çš„Thread target</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">g</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                      <span class="kt">long</span> <span class="n">stackSize</span><span class="o">,</span> <span class="n">AccessControlContext</span> <span class="n">acc</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                      <span class="kt">boolean</span> <span class="n">inheritThreadLocals</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;name cannot be null&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Determine if it&#39;s an applet or not */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* If there is a security manager, ask the security manager
</span></span></span><span class="line"><span class="cl"><span class="cm">               what to do. */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">g</span> <span class="o">=</span> <span class="n">security</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* If the security doesn&#39;t have a strong opinion of the matter
</span></span></span><span class="line"><span class="cl"><span class="cm">               use the parent thread group. */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">g</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* checkAccess regardless of whether or not threadgroup is
</span></span></span><span class="line"><span class="cl"><span class="cm">           explicitly passed in. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span><span class="o">.</span><span class="na">checkAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Do we have the required permissions?
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isCCLOverridden</span><span class="o">(</span><span class="n">getClass</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">security</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="n">SUBCLASS_IMPLEMENTATION_PERMISSION</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">g</span><span class="o">.</span><span class="na">addUnstarted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">group</span> <span class="o">=</span> <span class="n">g</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">daemon</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">priority</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getPriority</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">isCCLOverridden</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">contextClassLoader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">inheritedAccessControlContext</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">acc</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">acc</span> <span class="o">:</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">setPriority</span><span class="o">(</span><span class="n">priority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">inheritThreadLocals</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">createInheritedMap</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Stash the specified stack size in case the VM cares */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">stackSize</span> <span class="o">=</span> <span class="n">stackSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Set thread ID */</span>
</span></span><span class="line"><span class="cl">        <span class="n">tid</span> <span class="o">=</span> <span class="n">nextThreadID</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ï¼Œé€šè¿‡run()æ–¹æ³•è°ƒç”¨targetä¸­çš„runæ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-javaè¿›ç¨‹æŸ¥çœ‹">3.3 Javaè¿›ç¨‹æŸ¥çœ‹</h3>
<h4 id="windowsè¿›ç¨‹æŸ¥çœ‹å‘½ä»¤">Windowsè¿›ç¨‹æŸ¥çœ‹å‘½ä»¤</h4>
<ul>
<li>tasklist æŸ¥çœ‹æ‰€æœ‰çš„</li>
<li>taskkill /F /PID {pid} æ€æ­»è¿›ç¨‹</li>
<li>jps æŸ¥çœ‹javaè¿›ç¨‹</li>
</ul>
<h4 id="ä½¿ç”¨jconsoleæ¥è¿›è¡Œè¿›ç¨‹æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯">ä½¿ç”¨Jconsoleæ¥è¿›è¡Œè¿›ç¨‹æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220313003942146.png"
	
	
	
	loading="lazy"
	
		alt="image-20220313003942146"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220313003959070.png"
	
	
	
	loading="lazy"
	
		alt="image-20220313003959070"
	
	
></p>
<h3 id="34-çº¿ç¨‹è¿è¡ŒåŸç†">3.4 çº¿ç¨‹è¿è¡ŒåŸç†</h3>
<h4 id="æ ˆå¸§ä¸å¤šè¯´äº†csdnæœ‰ç¬”è®°">æ ˆå¸§ä¸å¤šè¯´äº†ï¼ŒCSDNæœ‰ç¬”è®°</h4>
<p>ä¸åŒçš„çº¿ç¨‹æœ‰ä¸åŒçš„çº¿ç¨‹æ ˆï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
<h4 id="çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢">çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</h4>
<p>å› ä¸ºæŸäº›åŸå› ï¼ŒCPUä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè€Œæ˜¯å»æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼š</p>
<ul>
<li>åƒåœ¾å›æ”¶</li>
<li>çº¿ç¨‹æ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>æœ‰ä¼˜å…ˆçº§æ›´é«˜çº§çš„çº¿ç¨‹éœ€è¦æ‰§è¡Œ</li>
<li>çº¿ç¨‹è°ƒç”¨äº†sleep,yield,wait,join,park,synchronized,lockç­‰æ–¹æ³•</li>
</ul>
<p>å½“Context Switchå‘ç”Ÿæ—¶ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿä¿å­˜çº¿ç¨‹å½“å‰çŠ¶æ€ï¼Œå†javaä¸­å¯¹åº”çš„æ¦‚å¿µåˆ™æ˜¯<strong>ç¨‹åºè®¡æ•°å™¨</strong>ã€‚</p>
<p>é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å½±å“æ€§èƒ½</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314112822680.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314112822680"
	
	
></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“mainçº¿ç¨‹æ—¶é—´ç‰‡ç”¨å®Œï¼Œåˆ™å°†CPUçš„æ“ä½œæƒé™è®©ç»™t1ï¼ŒåŒæ—¶ä¿å­˜mainçº¿ç¨‹ä¸­æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h3 id="35-çº¿ç¨‹æ–¹æ³•è¯¦è§£start--run">3.5 çº¿ç¨‹æ–¹æ³•è¯¦è§£:start &amp; run</h3>
<h4 id="runæ–¹æ³•">runæ–¹æ³•</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span><span class="o">(</span><span class="n">topic</span> <span class="o">=</span> <span class="s">&#34;c.start_run&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">start_run</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t1&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t2&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;main running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314113735349.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314113735349"
	
	
></p>
<h4 id="startæ–¹æ³•">startæ–¹æ³•</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@Slf4j(topic = &#34;c.start_run&#34;)
</span></span><span class="line"><span class="cl">public class start_run {
</span></span><span class="line"><span class="cl">    public static void main(String[] args) {
</span></span><span class="line"><span class="cl">        Thread t1 = new Thread(&#34;t1&#34;){
</span></span><span class="line"><span class="cl">            @Override
</span></span><span class="line"><span class="cl">            public void run(){
</span></span><span class="line"><span class="cl">                log.debug(&#34;running&#34;);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        };
</span></span><span class="line"><span class="cl">        Thread t2 = new Thread(&#34;t2&#34;){
</span></span><span class="line"><span class="cl">            @Override
</span></span><span class="line"><span class="cl">            public void run(){
</span></span><span class="line"><span class="cl">                log.debug(&#34;running2&#34;);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        };
</span></span><span class="line"><span class="cl">        t1.start();
</span></span><span class="line"><span class="cl">        t2.start();
</span></span><span class="line"><span class="cl">        log.debug(&#34;main running&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314113803454.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314113803454"
	
	
></p>
<p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œå½“è°ƒç”¨runæ–¹æ³•æ—¶ï¼Œçº¿ç¨‹å¤„ç†å®é™…ä¸Šæ˜¯mainçº¿ç¨‹ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ€§èƒ½æå‡ã€‚</p>
<p>myThread.start() -&gt; ç»§æ‰¿è‡ªThreadç±»çš„start()æ–¹æ³• -&gt; start0() -&gt; private native void start0() -&gt; cppåº•å±‚å»æ‰¾å½“å‰çº¿ç¨‹ç±»çš„runæ–¹æ³• -&gt; myThreadçš„runæ–¹æ³•</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191902410.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191902410"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191853071.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191853071"
	
	
></p>
<p>ç”±ä¸Šä¾‹çš„è¾“å‡ºå¯çŸ¥ï¼Œè°ƒç”¨runæ–¹æ³•çº¿ç¨‹å¹¶æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè€Œåªæ˜¯è°ƒç”¨javaï¼Œmainå‡½æ•°ä¸­çš„æ–¹æ³•</p>
<h4 id="start0åº•å±‚æºç "><strong>start0åº•å±‚æºç </strong></h4>
<p>[Thread.c] start0() -&gt; [Jvm.cpp] JVM_StartThread -&gt;new JavaThread -&gt; thread_entry -&gt;vmSymbols run_method_name() -&gt; &ldquo;run&rdquo;</p>
<p>æ‰¾åˆ°openJdkä¸­çš„Thread.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Copyright (c) 1994, 2012, Oracle and/or its affiliates. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This code is free software; you can redistribute it and/or modify it
</span></span></span><span class="line"><span class="cl"><span class="cm"> * under the terms of the GNU General Public License version 2 only, as
</span></span></span><span class="line"><span class="cl"><span class="cm"> * published by the Free Software Foundation.  Oracle designates this
</span></span></span><span class="line"><span class="cl"><span class="cm"> * particular file as subject to the &#34;Classpath&#34; exception as provided
</span></span></span><span class="line"><span class="cl"><span class="cm"> * by Oracle in the LICENSE file that accompanied this code.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This code is distributed in the hope that it will be useful, but WITHOUT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
</span></span></span><span class="line"><span class="cl"><span class="cm"> * version 2 for more details (a copy is included in the LICENSE file that
</span></span></span><span class="line"><span class="cl"><span class="cm"> * accompanied this code).
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * You should have received a copy of the GNU General Public License version
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2 along with this work; if not, write to the Free Software Foundation,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
</span></span></span><span class="line"><span class="cl"><span class="cm"> * or visit www.oracle.com if you need additional information or have any
</span></span></span><span class="line"><span class="cl"><span class="cm"> * questions.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*-
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      Stuff for dealing with threads.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      originally in threadruntime.c, Sun Sep 22 12:09:39 1991
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;jni.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;jvm.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;java_lang_Thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define THD &#34;Ljava/lang/Thread;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OBJ &#34;Ljava/lang/Object;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STE &#34;Ljava/lang/StackTraceElement;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STR &#34;Ljava/lang/String;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ARRAY_LENGTH(a) (sizeof(a)/sizeof(a[0]))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;start0&#34;</span><span class="p">,</span>           <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_StartThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;stop0&#34;</span><span class="p">,</span>            <span class="s">&#34;(&#34;</span> <span class="n">OBJ</span> <span class="s">&#34;)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_StopThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;isAlive&#34;</span><span class="p">,</span>          <span class="s">&#34;()Z&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_IsThreadAlive</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;suspend0&#34;</span><span class="p">,</span>         <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SuspendThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;resume0&#34;</span><span class="p">,</span>          <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_ResumeThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;setPriority0&#34;</span><span class="p">,</span>     <span class="s">&#34;(I)V&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SetThreadPriority</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;yield&#34;</span><span class="p">,</span>            <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Yield</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;sleep&#34;</span><span class="p">,</span>            <span class="s">&#34;(J)V&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Sleep</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;currentThread&#34;</span><span class="p">,</span>    <span class="s">&#34;()&#34;</span> <span class="n">THD</span><span class="p">,</span>     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_CurrentThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;countStackFrames&#34;</span><span class="p">,</span> <span class="s">&#34;()I&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_CountStackFrames</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;interrupt0&#34;</span><span class="p">,</span>       <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Interrupt</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;isInterrupted&#34;</span><span class="p">,</span>    <span class="s">&#34;(Z)Z&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_IsInterrupted</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;holdsLock&#34;</span><span class="p">,</span>        <span class="s">&#34;(&#34;</span> <span class="n">OBJ</span> <span class="s">&#34;)Z&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_HoldsLock</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;getThreads&#34;</span><span class="p">,</span>        <span class="s">&#34;()[&#34;</span> <span class="n">THD</span><span class="p">,</span>   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_GetAllThreads</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;dumpThreads&#34;</span><span class="p">,</span>      <span class="s">&#34;([&#34;</span> <span class="n">THD</span> <span class="s">&#34;)[[&#34;</span> <span class="n">STE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_DumpThreads</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;setNativeName&#34;</span><span class="p">,</span>    <span class="s">&#34;(&#34;</span> <span class="n">STR</span> <span class="s">&#34;)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SetNativeThreadName</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#undef THD
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef OBJ
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef STE
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef STR
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
</span></span><span class="line"><span class="cl"><span class="nf">Java_java_lang_Thread_registerNatives</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">RegisterNatives</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">ARRAY_LENGTH</span><span class="p">(</span><span class="n">methods</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹æ­¤æˆ‘ä»¬å¯çŸ¥start0çš„æºç åœ¨Jvm.cppæ–‡ä»¶ä¸­ï¼ŒJVM_StartThreadæºç å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">JVM_ENTRY</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">JVM_StartThread</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">jthread</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_StartThread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span><span class="n">native_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//åˆ›å»ºä¸€ä¸ªå¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// We cannot hold the Threads_lock when we throw an exception,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// due to rank ordering issues. Example:  we might need to grab the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Heap_lock while we construct the exception.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">throw_illegal_thread_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// We must release the Threads_lock before we can post a jvmti event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// in Thread::start.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ensure that the C++ Thread and OSThread structures aren&#39;t freed before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we operate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MutexLocker</span> <span class="nf">mu</span><span class="p">(</span><span class="n">Threads_lock</span><span class="p">);</span> <span class="c1">//åŠ äº†ä¸€æŠŠçº¿ç¨‹é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Since JDK 5 the java.lang.Thread threadStatus is used to prevent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// re-starting an already started thread, so we should usually find
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that the JavaThread is null. However for a JNI attached thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// there is a small window between the Thread object being created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (with its JavaThread set) and the update to its threadStatus, so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// have to check for this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Thread</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve_non_null</span><span class="p">(</span><span class="n">jthread</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw_illegal_thread_state</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//æŠ›å¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>   <span class="c1">//ä¸‹é¢çš„æ˜¯é‡ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// We could also check the stillborn flag to see if this thread was already stopped, but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// for historical reasons we let the thread detect that itself when it starts running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 	  <span class="c1">// è®¡ç®—åˆ›å»ºçº¿ç¨‹æ‰€éœ€è¦çš„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">jlong</span> <span class="n">size</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">             <span class="n">java_lang_Thread</span><span class="o">::</span><span class="n">stackSize</span><span class="p">(</span><span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve_non_null</span><span class="p">(</span><span class="n">jthread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Allocate the C++ Thread structure and create the native thread.  The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// stack size retrieved from java is signed, but the constructor takes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// size_t (an unsigned type), so avoid passing negative values which would
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// result in really large stacks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="nl">size</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//ç”Ÿæˆä¸€ä¸ªJavaThreadçš„å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">native_thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaThread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_entry</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// At this point it may be possible that no osthread was created for the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// JavaThread due to lack of memory. Check for this situation and throw
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// an exception if necessary. Eventually we may want to change this so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// that we only grab the lock if the thread was created successfully -
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// then we can also do this check and throw the exception in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// JavaThread constructor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">native_thread</span><span class="o">-&gt;</span><span class="n">osthread</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Note: the current thread is not being used within &#34;prepare&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">native_thread</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">jthread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸€å¥new JavaThread()è‡³å…³é‡è¦</p>
<p>å…¶ä¸­thread_entryæ˜¯JavaThreadçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œthread_entryæºç å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">thread_entry</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">HandleMark</span> <span class="n">hm</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span> <span class="n">obj</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaValue</span> <span class="n">result</span><span class="p">(</span><span class="n">T_VOID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaCalls</span><span class="o">::</span><span class="n">call_virtual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">KlassHandle</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">SystemDictionary</span><span class="o">::</span><span class="n">Thread_klass</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">vmSymbols</span><span class="o">::</span><span class="n">run_method_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">vmSymbols</span><span class="o">::</span><span class="n">void_method_signature</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨thread_entryé‡Œé¢æœ‰ä¸€ä¸ªrun_method_name()æ–¹æ³•</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨vmSymbolsä¸­çœ‹åˆ°è¯¥æ–¹æ³•å¯¹åº”çš„javaå</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191245041.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191245041"
	
	
></p>
<p>å¯¹åº”çš„å°±æ˜¯javaä¸­çš„runæ–¹æ³•</p>
<h3 id="36-çº¿ç¨‹æ–¹æ³•è¯¦è§£-sleepä¸yield">3.6 çº¿ç¨‹æ–¹æ³•è¯¦è§£: sleepä¸yield</h3>
<h4 id="sleep-æºç è§£æ">sleep æºç è§£æ</h4>
<ul>
<li>è°ƒç”¨sleepä¼šä»<strong>running</strong>çŠ¶æ€è¿›å…¥<strong>Timed Waiting</strong>çŠ¶æ€</li>
<li>ç¡çœ åçš„çº¿ç¨‹æœªå¿…ç›´æ¥è¿è¡Œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span><span class="k">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="s">&#34;t1&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">@</span><span class="n">Override</span>
</span></span><span class="line"><span class="cl">            <span class="k">public</span> <span class="kt">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;running&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;wake up....&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="n">getState</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="p">.</span><span class="n">interrupt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TimeUnitæ›¿ä»£Thread.sleep</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t1&#34;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;wake up....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314231632577.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314231632577"
	
	
></p>
<p>è°ƒç”¨Interruptä¼šæ‰“æ–­sleeping åŒæ—¶æŠ›å‡ºå¼‚å¸¸</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314212243181.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314212243181"
	
	
></p>
<h4 id="yield-æºç è§£æ">yield æºç è§£æ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">JVM_ENTRY</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">JVM_Yield</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">threadClass</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_Yield&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">dont_yield</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef USDT2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">HS_DTRACE_PROBE0</span><span class="p">(</span><span class="n">hotspot</span><span class="p">,</span> <span class="n">thread__yield</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else </span><span class="cm">/* USDT2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">HOTSPOT_THREAD_YIELD</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* USDT2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">// When ConvertYieldToSleep is off (default), this matches the classic VM use of yield.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Critical for similar threading behaviour
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertYieldToSleep</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">MinSleepInterval</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">os</span><span class="o">::</span><span class="n">YieldResult</span> <span class="n">os</span><span class="o">::</span><span class="n">NakedYield</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Use either SwitchToThread() or Sleep(0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Consider passing back the return value from SwitchToThread().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">Kernel32Dll</span><span class="o">::</span><span class="n">SwitchToThreadAvailable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">SwitchToThread</span><span class="p">()</span> <span class="o">?</span> <span class="n">os</span><span class="o">::</span><span class="nl">YIELD_SWITCHED</span> <span class="p">:</span> <span class="n">os</span><span class="o">::</span><span class="n">YIELD_NONEREADY</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">os</span><span class="o">::</span><span class="n">YIELD_UNKNOWN</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">os</span><span class="o">::</span><span class="n">yield</span><span class="p">()</span> <span class="p">{</span>  <span class="n">os</span><span class="o">::</span><span class="n">NakedYield</span><span class="p">();</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒThread.yield()è°ƒç”¨è¿‡ç¨‹ä¸º yield()-&gt;JVM_Yield()-&gt;NakedYield()</p>
<p>åŒæ—¶åœ¨è¿™é‡Œä½¿ç”¨äº†SwitchToThread å’Œ Sleep(0) ä¸¤ä¸ªæ–¹æ³•</p>
<p>**Sleep(0)ï¼š**åªä¼šå°†æ—¶é—´ç‰‡è®©ç»™ä¼˜å…ˆçº§ç›¸åŒæˆ–è€…æ›´é«˜çš„çº¿ç¨‹</p>
<p>â€‹    å¯¹äºC++ä¸­Sleep(timeout)æ–¹æ³•å¯ä»¥è¿™ä¹ˆç†è§£ï¼š
â€‹    <strong>å½“timeout = 0æ—¶</strong>ï¼šä¼šå°†è¯¥çº¿ç¨‹è®©ç»™æ¯”è‡ªå·±ä¼˜å…ˆçº§æ›´é«˜æˆ–è€…ç›¸ç­‰çš„çº¿ç¨‹å»è¿è¡Œ</p>
<p>â€‹    <strong>å½“timeout &gt; 0æ—¶</strong>ï¼šä¼šå¼•å‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè°ƒç”¨çº¿ç¨‹ä¼šä»çº¿ç¨‹è°ƒåº¦å™¨çš„å¯è¿è¡Œé˜Ÿåˆ—ç§»é™¤ä¸€æ®µæ—¶é—´</p>
<p>**SwitchToThread()ï¼š**åªè¦æœ‰å¯è°ƒåº¦çš„çº¿ç¨‹ï¼Œæ— è®ºä¼˜å…ˆçº§ï¼Œéƒ½ä¼šè®©å…¶è°ƒåº¦ï¼Œå¹¶ä¸”è¿”å›é0å€¼ï¼Œè‹¥æ— çº¿ç¨‹å¯è°ƒåº¦åˆ™è¿”å›False</p>
<h4 id="åœ¨javaä¸­sleepå’Œyieldçš„åŒºåˆ«"><strong>åœ¨Javaä¸­Sleepå’Œyieldçš„åŒºåˆ«</strong></h4>
<ul>
<li>sleepä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œyieldä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>yieldå°†CPUçš„ä½¿ç”¨æƒè®©ç»™æ¯”è‡ªå·±ä¼˜å…ˆçº§æ›´é«˜æˆ–è€…ç›¸åŒçš„çº¿ç¨‹ï¼Œsleepæ˜¯è¯¥çº¿ç¨‹ä»å¯è¿è¡Œé˜Ÿåˆ—ç§»é™¤ä¸€æ®µæ—¶é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>sleepè¿›å…¥Time_waitçŠ¶æ€ï¼Œè€Œyieldè¿›å…¥å°±ç»ªæ€ã€‚</li>
<li>sleep()æ–¹æ³•æ¯”yield()æ–¹æ³•ï¼ˆè·Ÿæ“ä½œç³»ç»ŸCPUè°ƒåº¦ç›¸å…³ï¼‰å…·æœ‰æ›´å¥½çš„å¯ç§»æ¤æ€§ã€‚</li>
</ul>
<h4 id="çº¿ç¨‹ä¼˜å…ˆçº§">çº¿ç¨‹ä¼˜å…ˆçº§</h4>
<p>å½“CPUè¾ƒä¸ºç¹å¿™ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šæ—¶é—´ç‰‡ï¼ŒCPUè¾ƒä¸ºç©ºé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨ï¼Œä¼˜å…ˆçº§ä»…ä»…åªæ˜¯ä¸€ä¸ªæç¤º</p>
<h3 id="37-æ¡ˆä¾‹-é˜²æ­¢cpuå ç”¨100">3.7 æ¡ˆä¾‹-é˜²æ­¢CPUå ç”¨100%</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥ç”¨sleepè®©å‡ºcpuä½¿ç”¨æƒï¼Œé˜²æ­¢ç©ºè½¬CPUï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨waitæˆ–æ¡ä»¶å˜é‡è¾¾åˆ°(éœ€è¦åŠ é”,é€‚ç”¨äºåŒæ­¥åœºæ™¯)ï¼Œsleepä¸éœ€è¦åŠ é”</p>
<h3 id="38-join">3.8 Join</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315201613121.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315201613121"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315201620643.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315201620643"
	
	
></p>
<p>ç”±ä¸Šå›¾å¯ä»¥å¾—çŸ¥ï¼Œå› ä¸ºä¸»æ–¹æ³•å’Œçº¿ç¨‹t1æ˜¯å¹¶è¡Œçš„ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹t1.sleepåï¼Œrå°±å·²ç»è¢«ä¸»çº¿ç¨‹è¾“å‡ºäº†ã€‚</p>
<h4 id="èƒ½ä¸èƒ½ç”¨sleepä¸ºä»€ä¹ˆ">èƒ½ä¸èƒ½ç”¨sleepï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</h4>
<p>èƒ½ï¼Œä½†æ˜¯å¦‚æœmillisæ˜¯å˜é‡é‚£å…·ä½“t1çº¿ç¨‹è¦ä»€ä¹ˆsleepå¤šå°‘æ—¶é—´æ˜¯ä¸çŸ¥é“çš„</p>
<h4 id="join">Join</h4>
<p>**æè¿°ï¼š**ç­‰å¾…æŸä¸€çº¿ç¨‹è¿è¡Œå®Œï¼Œæ‰å¼€å§‹è¿è¡Œ(åŒæ­¥)</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315205621335.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315205621335"
	
	
></p>
<h4 id="joinåŸç†">JoinåŸç†</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">millis</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;timeout value is negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">millis</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">millis</span> <span class="o">-</span> <span class="n">now</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait</span><span class="o">(</span><span class="n">delay</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>join<strong>é‡‡ç”¨çš„æ˜¯ä¿æŠ¤æ€§æš‚åœè®¾è®¡æ¨¡å¼çš„åŸç†</strong>ï¼Œ<strong>å¦‚æœmillis = 0 å°±ä¼šä¸€ç›´ç­‰å¾…è¯¥çº¿ç¨‹æ‰§è¡Œç»“æŸåæ‰ä¼šåœæ­¢å¾ªç¯ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯waitæ–¹æ³•</strong>ï¼Œsynchronziedä¸ºéœ€è¦ç­‰å¾…å®Œæˆçš„thisçº¿ç¨‹è¿›è¡ŒåŠ é”ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨joinæ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥è¯¥åŒæ­¥ä»£ç å—ï¼Œå¹¶ä¸”è°ƒç”¨waitæ–¹æ³•ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ<strong>åŒæ—¶thisçº¿ç¨‹ä¹Ÿä¼šå˜ä¸ºé‡é‡çº§é”ã€‚</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">JUC.a_JavaThread.join$1 object internals:
</span></span><span class="line"><span class="cl">OFF  SZ                                        TYPE DESCRIPTION                             VALUE
</span></span><span class="line"><span class="cl">  0   4                                             (object header: mark)                   0x026ccfe6 (fat lock: 0x026ccfe6)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="39-interrupt-æ–¹æ³•è¯¦è§£">3.9 interrupt æ–¹æ³•è¯¦è§£</h3>
<h4 id="æ‰“æ–­sleepwaitjoinçº¿ç¨‹">æ‰“æ–­sleepï¼Œwaitï¼Œjoinçº¿ç¨‹</h4>
<p><strong>é˜»å¡æ‰“æ–­ï¼š</strong></p>
<p>æ‰“æ–­sleepçš„çº¿ç¨‹ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨æŠ›å‡ºå¼‚å¸¸åç«‹å³å°†çº¿ç¨‹ä¸­æ–­æ ‡ç¤ºä½æ¸…æ¥šï¼Œé‡æ–°è®¾ç½®ä¸ºfalseï¼ŒæŠ›å‡ºå¼‚å¸¸æ˜¯ä¸ºäº†è®©çº¿ç¨‹ä»é˜»å¡çŠ¶æ€é†’è¿‡æ¥ï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹ç»“æŸå‰è®©ç¨‹åºå‘˜æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥å¤„ç†ä¸­æ–­è¯·æ±‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;sleep...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;interrupt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{}&#34;</span><span class="o">,</span><span class="n">t1</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315211854345.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315211854345"
	
	
></p>
<p><strong>è¿è¡Œæ‰“æ–­ï¼š</strong></p>
<p>æ‰“æ–­è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼Œè¿”å›false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t2 {}&#34;</span><span class="o">,</span><span class="n">t1</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315214537725.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315214537725"
	
	
></p>
<h3 id="310-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼">3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3>
<p>å¦‚ä½•åœ¨T1çº¿ç¨‹ä¸­ä¼˜é›…çš„ç»ˆæ­¢çº¿ç¨‹T2ï¼Ÿ</p>
<h4 id="é”™è¯¯æ€è·¯">é”™è¯¯æ€è·¯</h4>
<ul>
<li><strong>ä½¿ç”¨stop()æ–¹æ³•åœæ­¢çº¿ç¨‹</strong></li>
</ul>
<p>stopæ–¹æ³•ä¼šæ€æ­»çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœçº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹æ°¸è¿œæ— æ³•è·å–é”</p>
<ul>
<li><strong>ä½¿ç”¨System.exit(init) æ–¹æ³•åœæ­¢çº¿ç¨‹</strong></li>
</ul>
<p>è¿™ä¸ªæ–¹æ³•ä¼šè®©ç¨‹åºåœæ­¢</p>
<h4 id="æ­£ç¡®æ€è·¯">æ­£ç¡®æ€è·¯</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315215652051.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315215652051"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">TwoPhaseInterrput</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ–™ç†åäº‹&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç›‘æ§ä¸­&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">current</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span> <span class="c1">//ç”±äºsleepä¼šæ¸…é™¤Interruptæ ‡è®°,é‡æ–°æ‰“æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SneakyThrows</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitor</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseInterrput</span> <span class="n">twoPhaseInterrput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseInterrput</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130132899.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130132899"
	
	
></p>
<p>åœ¨sleepä¸­ï¼Œæ‰“æ–­æ ‡è®°ä¼šè¢«æ¸…é™¤ï¼Œæ‰€ä»¥åº”è¯¥åœ¨catchä¸­å†æ‰“æ–­ä¸€æ¬¡</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130712873.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130712873"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130719256.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130719256"
	
	
></p>
<h3 id="311-parkunpark">3.11 Park&amp;UnPark</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;start..&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;park...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;resume...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">18:43:35.503 [t1] DEBUG JUC.a_JavaThread.parkThread - start..
</span></span><span class="line"><span class="cl">18:43:36.507 [main] DEBUG JUC.a_JavaThread.parkThread - unpark....
</span></span><span class="line"><span class="cl">18:43:37.518 [t1] DEBUG JUC.a_JavaThread.parkThread - park...
</span></span><span class="line"><span class="cl">18:43:37.518 [t1] DEBUG JUC.a_JavaThread.parkThread - resume...
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h4>
<p><strong>ä¸Objectçš„wait&amp;notifyç›¸æ¯”ï¼š</strong></p>
<ul>
<li>parkå’Œunparkæ— éœ€åœ¨åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨,waitï¼Œnotifyå’ŒnotifyAllå¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨</li>
<li>park &amp; unpark æ˜¯ä»¥çº¿ç¨‹å•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œnotifyåªèƒ½éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯”notifyæ›´åŠ ç²¾ç¡®</li>
<li>park &amp; unpark å¯ä»¥å…ˆ unparkï¼Œä½†æ˜¯ wait &amp; notifyä¸èƒ½å…ˆnotify</li>
</ul>
<p>è¯¥æ–¹æ³•ä¼šä½¿çº¿ç¨‹åœæ­¢ï¼Œå¯ä»¥ç”¨interruptæ‰“æ–­parkçŠ¶æ€ï¼Œä½†æ­¤æ—¶æ‰“æ–­æ ‡è®°ä¸ºtureï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨parkæ–¹æ³•ä¼šæ ¹æ®æ‰“æ–­æ ‡è®°æ˜¯å¦ä¸ºfalseæ¥åˆ¤æ–­æ˜¯å¦åœæ­¢çº¿ç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;park...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ‰“æ–­çŠ¶æ€:{}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ‰“æ–­çŠ¶æ€:{}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316132557295.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316132557295"
	
	
></p>
<h4 id="åŸç†">åŸç†</h4>
<h5 id="park">park()</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">park</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNSAFE</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="parkobject-blocker">park(Object blocker)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">park</span><span class="o">(</span><span class="n">Object</span> <span class="n">blocker</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">setBlocker</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">blocker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNSAFE</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setBlocker</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ–¹æ³•åˆ†æï¼š</strong></p>
<ul>
<li>è¿™é‡Œçš„blocker æ˜¯æŒ‡è¢«é˜»å¡çš„å¯¹è±¡ï¼Œç”¨äºä¹‹åçš„çº¿ç¨‹ç›‘æ§å’Œåˆ†æå·¥å…·æ¥å®šä½</li>
</ul>
<h5 id="public-native-void-parkboolean-isabsolute-long-time">public native void park(boolean isAbsolute, long time)</h5>
<ul>
<li>isAbsolut = trueï¼šmså®šæ—¶,isAbsolut=falseï¼šnså®šæ—¶</li>
</ul>
<p>åœ¨Linuxç³»ç»Ÿä¸‹ï¼Œæ˜¯ç”¨çš„Posixçº¿ç¨‹åº“pthreadç§çš„mutex(äº’æ–¥é‡)ï¼Œcondition(æ¡ä»¶å˜é‡) æ¥å®ç°çš„ã€‚</p>
<p><strong>mutexå’Œconditionä¿æŠ¤äº†ä¸€ä¸ª_counterçš„å˜é‡ï¼Œå½“parkæ—¶ï¼Œè¿™ä¸ªå˜é‡è¢«è®¾ç½®ä¸º0ï¼Œå½“unparkæ—¶ï¼Œè¿™ä¸ªå˜é‡è¢«è®¾ç½®ä¸º1ã€‚</strong></p>
<p><strong>conditionæ¡ä»¶</strong>å˜é‡è¢«ç”¨æ¥é˜»å¡ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹å¾€å¾€è§£å¼€ç›¸åº”çš„äº’æ–¥é”å¹¶ç­‰å¾…æ¡ä»¶å‘ç”Ÿå˜åŒ–ã€‚ä¸€æ—¦å…¶ä»–çš„æŸä¸ªçº¿ç¨‹æ”¹å˜äº†æ¡ä»¶å˜é‡ï¼Œå®ƒå°†é€šçŸ¥ç›¸åº”çš„æ¡ä»¶å˜é‡å”¤é†’ä¸€ä¸ªæˆ–å¤šä¸ªæ­£è¢«æ­¤æ¡ä»¶å˜é‡é˜»å¡çš„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å°†é‡æ–°é”å®šäº’æ–¥é”å¹¶é‡æ–°æµ‹è¯•æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚</p>
<p><strong>æ¯ä¸ªJavaçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªParkerå®ä¾‹ï¼ŒParkerç±»æ˜¯è¿™æ ·å®šä¹‰çš„</strong></p>
<h5 id="parkç±»å®šä¹‰">Parkç±»å®šä¹‰</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/* In the future we&#39;ll want to think about eliminating Parker and using
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ParkEvent instead.  There&#39;s considerable duplication between the two
</span></span></span><span class="line"><span class="cl"><span class="cm"> * services.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">*å°†æ¥æˆ‘ä»¬ä¼šè€ƒè™‘é™¤æ‰Parkerï¼Œç”¨ParkEventä»£æ›¿ã€‚ä¸¤è€…ä¹‹é—´æœ‰ç›¸å½“å¤šçš„é‡å¤æœåŠ¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Parker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">os</span><span class="o">::</span><span class="n">PlatformParker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">_counter</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Parker</span> <span class="o">*</span> <span class="n">FreeNext</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span> <span class="n">AssociatedWith</span> <span class="p">;</span> <span class="c1">// Current association
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">Parker</span><span class="p">()</span> <span class="o">:</span> <span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_counter</span>       <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FreeNext</span>       <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AssociatedWith</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">~</span><span class="n">Parker</span><span class="p">()</span> <span class="p">{</span> <span class="n">ShouldNotReachHere</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// For simplicity of interface with Java, all forms of park (indefinite,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// relative, and absolute) are multiplexed into one call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">park</span><span class="p">(</span><span class="kt">bool</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">unpark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Lifecycle operators
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">static</span> <span class="n">Parker</span> <span class="o">*</span> <span class="nf">Allocate</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">void</span> <span class="nf">Release</span> <span class="p">(</span><span class="n">Parker</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="n">Parker</span> <span class="o">*</span> <span class="k">volatile</span> <span class="n">FreeList</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">ListLock</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="os-platformparker">os:: PlatformParker</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PlatformParker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CHeapObj</span><span class="o">&lt;</span><span class="n">mtInternal</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">REL_INDEX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ABS_INDEX</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">_cur_index</span><span class="p">;</span>  <span class="c1">// which cond is in use: -1, 0, 1  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_mutex_t</span> <span class="n">_mutex</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_cond_t</span>  <span class="n">_cond</span>  <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">;</span> <span class="c1">// one for relative times and one for abs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>       <span class="c1">// TODO-FIXME: make dtor private
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">~</span><span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span> <span class="n">guarantee</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">)</span> <span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">REL_INDEX</span><span class="p">],</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">condAttr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_init rel&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">ABS_INDEX</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_init abs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_init</span> <span class="p">(</span><span class="n">_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;mutex_init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_cur_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// mark as unused
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="parkæºç ">Parkæºç </h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Parker</span><span class="o">::</span><span class="n">park</span><span class="p">(</span><span class="kt">bool</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//åŸå­äº¤æ¢ï¼Œå¦‚æœ_counter &gt; 0,åˆ™å°†_counterç½®ä¸º0ï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™_counterä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">xchg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è·å–å½“å‰çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">::</span><span class="n">current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;Must be JavaThread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//ä¸‹è½¬å‹ä¸ºjavaçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">JavaThread</span> <span class="o">*</span><span class="n">jt</span> <span class="o">=</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span><span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœå½“å‰çº¿ç¨‹è®¾ç½®äº†ä¸­æ–­æ ‡å¿—ï¼Œè°ƒç”¨parkåˆ™ç›´æ¥è¿”å›ï¼Œæ‰€ä»¥å¦‚æœåœ¨parkä¹‹å‰è°ƒç”¨äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//interruptå°±ä¼šç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">is_interrupted</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">// é«˜ç²¾åº¦ç»å¯¹æ—¶é—´å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">timespec</span> <span class="n">absTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœtimeå°äº0ï¼Œæˆ–è€…isAbsoluteæ˜¯trueå¹¶ä¸”timeç­‰äº0åˆ™ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">isAbsolute</span> <span class="o">&amp;&amp;</span> <span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// don&#39;t wait at all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœtimeå¤§äº0ï¼Œåˆ™æ ¹æ®æ˜¯å¦æ˜¯é«˜ç²¾åº¦å®šæ—¶è®¡ç®—å®šæ—¶æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unpackTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">absTime</span><span class="p">,</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//è¿›å…¥å®‰å…¨ç‚¹é¿å…æ­»é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ThreadBlockInVM</span> <span class="nf">tbivm</span><span class="p">(</span><span class="n">jt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœå½“å‰çº¿ç¨‹è®¾ç½®äº†ä¸­æ–­æ ‡å¿—ï¼Œæˆ–è€…è·å–mutexäº’æ–¥é”å¤±è´¥åˆ™ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ç”±äºParkeræ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰çš„ï¼Œæ‰€ä»¥_counter cond mutexéƒ½æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰çš„ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ä¸æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„æ‰€ä»¥åŠ é”å¤±è´¥åªæœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€parkå·²ç»åŠ é”è¿™æ—¶åªéœ€è¦è¿”å›å³å¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ç¬¬äºŒè°ƒç”¨è°ƒç”¨pthread_mutex_trylockå‡ºé”™ã€‚å¯¹äºç¬¬ä¸€ç§æƒ…å†µå°±ç±»ä¼¼æ˜¯unparkå…ˆè°ƒç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">is_interrupted</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span> <span class="n">pthread_mutex_trylock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">status</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœ_counterå¤§äº0ï¼Œè¯´æ˜unparkå·²ç»è°ƒç”¨å®Œæˆäº†å°†_counterç½®ä¸ºäº†1ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ç°åœ¨åªéœ€å°†_counterç½®0ï¼Œè§£é”ï¼Œè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span> <span class="c1">// no wait needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">OSThreadWaitState</span> <span class="nf">osts</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">osthread</span><span class="p">(),</span> <span class="nb">false</span> <span class="cm">/* not Object.wait() */</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">jt</span><span class="o">-&gt;</span><span class="n">set_suspend_equivalent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_cur_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœtimeç­‰äº0ï¼Œè¯´æ˜æ˜¯ç›¸å¯¹æ—¶é—´ä¹Ÿå°±æ˜¯isAbsoluteæ˜¯fasle(å¦åˆ™å‰é¢å°±ç›´æ¥è¿”å›äº†),åˆ™ç›´æ¥æŒ‚èµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cur_index</span> <span class="o">=</span> <span class="n">REL_INDEX</span><span class="p">;</span> <span class="c1">// arbitrary choice when not timed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">_mutex</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//å¦‚æœtimeé0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//åˆ¤æ–­isAbsoluteæ˜¯falseè¿˜æ˜¯trueï¼Œfalseçš„è¯ä½¿ç”¨_cond[0]ï¼Œå¦åˆ™ç”¨_cond[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_cur_index</span> <span class="o">=</span> <span class="n">isAbsolute</span> <span class="o">?</span> <span class="nl">ABS_INDEX</span> <span class="p">:</span> <span class="n">REL_INDEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä½¿ç”¨æ¡ä»¶å˜é‡ä½¿å¾—å½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">safe_cond_timedwait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">_mutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">absTime</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœæŒ‚èµ·å¤±è´¥åˆ™é”€æ¯å½“å‰çš„æ¡ä»¶å˜é‡é‡æ–°åˆå§‹åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">WorkAroundNPTLTimedWaitHang</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_cond_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">])</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_cond_init</span>    <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">isAbsolute</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">condAttr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//å¦‚æœpthread_cond_waitæˆåŠŸåˆ™ä»¥ä¸‹ä»£ç éƒ½æ˜¯çº¿ç¨‹è¢«å”¤é†’åæ‰§è¡Œçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_cur_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">EINTR</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span> <span class="o">==</span> <span class="n">ETIME</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_timedwait&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldsigs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">//å°†_counterå˜é‡é‡æ–°ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ä½¿ç”¨å†…å­˜å±éšœä½¿_counterå¯¹å…¶å®ƒçº¿ç¨‹å¯è§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœåœ¨parkçº¿ç¨‹æŒ‚èµ·çš„æ—¶å€™è°ƒç”¨äº†stopæˆ–è€…suspendåˆ™è¿˜éœ€è¦å°†çº¿ç¨‹æŒ‚èµ·ä¸èƒ½è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">jt</span><span class="o">-&gt;</span><span class="n">handle_special_suspend_equivalent_condition</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">jt</span><span class="o">-&gt;</span><span class="n">java_suspend_self</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®é™…ä¸ŠParkerç±»ç”¨Posixçš„mutexï¼Œconditionæ¥å®ç°çš„é˜»å¡å”¤é†’ã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºmutexå°±æ˜¯Javaé‡Œçš„synchronizedï¼Œconditionå°±æ˜¯Objecté‡Œçš„wait/notifyæ“ä½œã€‚</p>
<p>parkæ–¹æ³•é‡Œè°ƒç”¨pthread_mutex_trylockæ–¹æ³•ï¼Œå°±ç›¸å½“äºJavaçº¿ç¨‹è¿›å…¥Javaçš„åŒæ­¥ä»£ç å—ï¼Œç„¶åå†æ¬¡åˆ¤æ–­_counteræ˜¯å¦å¤§äºé›¶ï¼Œå¦‚æœå¤§äºé›¶åˆ™å°†_counterè®¾ç½®ä¸ºé›¶ã€‚æœ€åè°ƒç”¨pthread_mutex_unlockè§£é”ï¼Œç›¸å½“äºJavaæ‰§è¡Œå®Œé€€å‡ºåŒæ­¥ä»£ç å—ã€‚å¦‚æœ_counterä¸å¤§äºé›¶ï¼Œåˆ™ç»§ç»­å¾€ä¸‹æ‰§è¡Œpthread_cond_waitæ–¹æ³•ï¼Œå®ç°å½“å‰çº¿ç¨‹çš„é˜»å¡ã€‚</p>
<ul>
<li>å½“è°ƒç”¨parkæ—¶ï¼Œå…ˆå°è¯•ç›´æ¥æ˜¯å¦èƒ½æ‹¿åˆ°_counter,å³counter&gt;0ï¼Œå¦‚æœæˆåŠŸåˆ™counter=0,è¿”å›</li>
<li>å¦åˆ™ï¼Œå†åˆ¤æ–­ç­‰å¾…æ—¶é—´ï¼Œç„¶åå†è°ƒç”¨pthread_cond_waitå‡½æ•°ç­‰å¾…ï¼Œå¦‚æœç­‰å¾…è¿”å›ï¼Œåˆ™æŠŠcounterè®¾ç½®ä¸º0ï¼Œunlock mutexè¿”å›</li>
</ul>
<blockquote>
<p><strong>æµç¨‹ï¼š</strong></p>
<p>1, AtomåŸå­åˆ¤æ–­ _count&gt;0  (count=0å¾€ä¸‹)</p>
<p>2, åˆ¤æ–­æ—¶é—´æ˜¯å¦ä¸ºç»å¯¹æ—¶é—´ï¼Œä»¥åŠæ—¶é—´æ˜¯å¦åˆæ³• (åˆæ³•å¾€ä¸‹)</p>
<p>3, åˆ¤æ–­çº¿ç¨‹ä¸­é€”æ˜¯å¦è¢«æ‰“æ–­ï¼Œè°ƒç”¨pthread_mutex_trylockè¿›å…¥åŒæ­¥ä»£ç å—ï¼Œå¹¶åŠ é”ï¼Œåˆ¤æ–­æ˜¯å¦count&gt;0 (æ²¡è¢«æ‰“æ–­ï¼Œcount=0 å¾€ä¸‹)</p>
<p>4, å¦‚æœcount&gt;0 å°†count=0 åŒæ—¶è°ƒç”¨pthread_cond_unlock è§£é”ï¼Œé€€å‡ºåŒæ­¥ä»£ç å— (count=0 å¾€ä¸‹)</p>
<p>5, è°ƒç”¨pthread_cond_wait()è®¾ç½®çº¿ç¨‹çŠ¶æ€ä¸ºç­‰å¾…ï¼Œå°†çº¿ç¨‹é˜»å¡è¿›å…¥cond</p>
</blockquote>
<h5 id="threadblockinvm-tbivmjt">ThreadBlockInVM tbivm(jt)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ThreadBlockInVM</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ThreadStateTransition</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">ThreadBlockInVM</span><span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">:</span> <span class="n">ThreadStateTransition</span><span class="p">(</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Once we are blocked vm expects stack to be walkable    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">frame_anchor</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">make_walkable</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//æŠŠçº¿ç¨‹ç”±è¿è¡ŒçŠ¶æ€è½¬æˆé˜»å¡çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">trans_and_fence</span><span class="p">(</span><span class="n">_thread_in_vm</span><span class="p">,</span> <span class="n">_thread_blocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="unpark">unpark</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Parker</span><span class="o">::</span><span class="n">unpark</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">s</span><span class="o">,</span> <span class="n">status</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//åŠ äº’æ–¥é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="o">=</span> <span class="n">_counter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_counter</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="c1">//å°†_counterç½®1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//å¦‚æœ_counteræ˜¯0åˆ™è¯´æ˜è°ƒç”¨äº†parkæˆ–è€…æ²¡è°ƒç”¨(åˆå§‹ä¸ºcounter0ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//è¿™ä¹Ÿè¯´æ˜parkå’Œunparkè°ƒç”¨æ²¡æœ‰å…ˆåé¡ºåºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯´æ˜å½“å‰parkerå¯¹åº”çš„çº¿ç¨‹æŒ‚èµ·äº†ï¼Œå› ä¸º_cur_indexåˆå§‹æ˜¯-1ï¼Œå¹¶ä¸”ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹è¢«å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//åä¹Ÿä¼šå°†_cur_indexé‡ç½®-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">_cur_index</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//å¦‚æœè®¾ç½®äº†WorkAroundNPTLTimedWaitHangå…ˆè°ƒç”¨signalå†è°ƒç”¨unlockï¼Œå¦åˆ™ç›¸å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//è¿™ä¸¤ä¸ªå…ˆåé¡ºåºéƒ½å¯ä»¥ï¼Œåœ¨hotspotåœ¨Linuxä¸‹é»˜è®¤ä½¿ç”¨è¿™ç§æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//å³å…ˆè°ƒç”¨signalå†è°ƒç”¨unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">WorkAroundNPTLTimedWaitHang</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_signal</span> <span class="o">(&amp;</span><span class="n">_cond</span><span class="o">[</span><span class="n">_cur_index</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_signal</span> <span class="o">(&amp;</span><span class="n">_cond</span><span class="o">[</span><span class="n">_cur_index</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">//å¦‚æœ_cur_index == -1è¯´æ˜çº¿ç¨‹æ²¡åœ¨ç­‰å¾…æ¡ä»¶å˜é‡ï¼Œåˆ™ç›´æ¥è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//å¦‚æœ_counter == 1,è¯´æ˜çº¿ç¨‹è°ƒç”¨äº†ä¸€æ¬¡æˆ–å¤šæ¬¡unparkä½†æ˜¯æ²¡è°ƒç”¨parkï¼Œåˆ™ç›´æ¥è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**unparkå®é™…ä¸Šå°±æ˜¯å°†_counterè®¾ä¸º1ï¼Œ**å¦‚æœs&lt;1&amp;&amp;_cur_index!=-1(é»˜è®¤cur_index=1)åˆ™è®¤ä¸ºçº¿ç¨‹æœ‰é˜»å¡ ,ä¾¿å°†çº¿ç¨‹å”¤é†’ï¼Œsï¼1åˆ™ç›´æ¥é€€å‡º</p>
<h4 id="æµç¨‹å›¾">æµç¨‹å›¾</h4>
<h5 id="è°ƒç”¨park">è°ƒç”¨park()</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326232855163.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326232855163"
	
	
></p>
<ul>
<li>è°ƒç”¨Unsafe.parkæ–¹æ³•</li>
<li>åˆ¤æ–­_counteræ˜¯å¦ä¸º0</li>
<li>å¦‚æœ_counterä¸º0åˆ™å°†çº¿ç¨‹æ”¾å…¥ _condä¸­é˜»å¡</li>
<li>å¹¶ä¸”å†æ¬¡è®¾ç½®_counter=0</li>
</ul>
<h5 id="è°ƒç”¨unpark">è°ƒç”¨unpark</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326233050805.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326233050805"
	
	
></p>
<ul>
<li>è°ƒç”¨Unsafe.unparkæ–¹æ³•</li>
<li>å°† _counterè®¾ç½®ä¸º1</li>
<li>æŸ¥çœ‹condä¸­ çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡</li>
<li>å¦‚æœè¢«é˜»å¡åˆ™å”¤é†’è¿è¡Œ å¹¶ä¸”å°†_counterè®¾ä¸º0</li>
</ul>
<h5 id="å…ˆè°ƒç”¨unparkå†è°ƒç”¨park">å…ˆè°ƒç”¨unparkå†è°ƒç”¨park</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326233538199.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326233538199"
	
	
></p>
<ul>
<li>å°†çº¿ç¨‹çš„counterè®¾ç½®ä¸º1</li>
<li>parkæŸ¥çœ‹çº¿ç¨‹çš„counteræ˜¯å¦ä¸º1</li>
<li>å¦‚æœä¸º1åˆ™è®¾ç½®ä¸º0</li>
<li>Thread-0ç»§ç»­è¿è¡Œ</li>
</ul>
<h3 id="312-å®ˆæŠ¤çº¿ç¨‹">3.12 å®ˆæŠ¤çº¿ç¨‹</h3>
<h6 id="å®ˆæŠ¤æŸä¸€ä¸ªçº¿ç¨‹å½“è¢«å®ˆæŠ¤çš„çº¿ç¨‹ç»“æŸåå®ˆæŠ¤çº¿ç¨‹æ— æ¡ä»¶ç»ˆæ­¢ä¸ä¼šç­‰å¾…å…¶å¤„ç†å®Œ">å®ˆæŠ¤æŸä¸€ä¸ªçº¿ç¨‹ï¼Œå½“è¢«å®ˆæŠ¤çš„çº¿ç¨‹ç»“æŸåï¼Œå®ˆæŠ¤çº¿ç¨‹æ— æ¡ä»¶ç»ˆæ­¢ï¼Œä¸ä¼šç­‰å¾…å…¶å¤„ç†å®Œã€‚</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;end!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">     <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;main end!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316134148187.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316134148187"
	
	
></p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li>
<li>Tomcatä¸­çš„Acceptorå’ŒPollerçº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹</li>
</ul>
</blockquote>
<h4 id="å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢">å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</h4>
<ul>
<li>
<p>**ç”¨æˆ· (User) çº¿ç¨‹ï¼š**è¿è¡Œåœ¨å‰å°ï¼Œæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ï¼Œå¦‚ç¨‹åºçš„ä¸»çº¿ç¨‹ã€è¿æ¥ç½‘ç»œçš„å­çº¿ç¨‹ç­‰éƒ½æ˜¯ç”¨æˆ·çº¿ç¨‹</p>
</li>
<li>
<p>**å®ˆæŠ¤ (Daemon) çº¿ç¨‹ï¼š**è¿è¡Œåœ¨åå°ï¼Œä¸ºå…¶ä»–å‰å°çº¿ç¨‹æœåŠ¡ã€‚ä¹Ÿå¯ä»¥è¯´å®ˆæŠ¤çº¿ç¨‹æ˜¯ JVM ä¸­éå®ˆæŠ¤çº¿ç¨‹çš„ â€œä½£äººâ€ã€‚ä¸€æ—¦æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½ç»“æŸè¿è¡Œï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šéš JVM ä¸€èµ·ç»“æŸå·¥ä½œ</p>
</li>
</ul>
<p>main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å•Šï¼Œmain å‡½æ•°å¯åŠ¨çš„åŒæ—¶åœ¨ JVM å†…éƒ¨åŒæ—¶è¿˜å¯åŠ¨äº†å¥½å¤šå®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€‚</p>
<p>æ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«ä¹‹ä¸€æ˜¯ç”¨æˆ·çº¿ç¨‹ç»“æŸï¼ŒJVM é€€å‡ºï¼Œä¸ç®¡è¿™ä¸ªæ—¶å€™æœ‰æ²¡æœ‰å®ˆæŠ¤çº¿ç¨‹è¿è¡Œã€‚è€Œå®ˆæŠ¤çº¿ç¨‹ä¸ä¼šå½±å“ JVM çš„é€€å‡ºã€‚</p>
<h3 id="313-çº¿ç¨‹çŠ¶æ€">3.13 çº¿ç¨‹çŠ¶æ€</h3>
<h4 id="äº”ç§çŠ¶æ€">äº”ç§çŠ¶æ€</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316135550576.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316135550576"
	
	
></p>
<p><strong>åˆå§‹æ€ï¼Œå°±ç»ªæ€ï¼Œè¿è¡Œæ€ï¼Œé˜»å¡ï¼Œç»ˆæ­¢</strong></p>
<ul>
<li>ã€åˆå§‹çŠ¶æ€ã€‘ä»…åœ¨è¯­è¨€å±‚é¢ä¸Šåˆ›å»ºäº†å¯¹è±¡ï¼Œè¿˜æ²¡å’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</li>
<li>ã€å°±ç»ªçŠ¶æ€ã€‘çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼Œå¯ä»¥ç”±CPUè°ƒåº¦æ‰§è¡Œ</li>
<li>ã€è¿è¡ŒçŠ¶æ€ã€‘è·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€
<ul>
<li>å½“æ—¶é—´ç‰‡ç”¨å®Œå°±ä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢ä¸ºã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
</li>
<li>ã€é˜»å¡çŠ¶æ€ã€‘</li>
</ul>
<h4 id="å…­ç§çŠ¶æ€">å…­ç§çŠ¶æ€</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316190519924.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316190519924"
	
	
></p>
<p>**æ³¨ï¼š**RUNNABLEæ¶µç›–äº†æ“ä½œç³»ç»Ÿä¸­çš„ã€è¿è¡ŒçŠ¶æ€ï¼Œé˜»å¡çŠ¶æ€ï¼Œå¯è¿è¡ŒçŠ¶æ€ã€‘</p>
<p>æ“ä½œç³»ç»Ÿçš„é˜»å¡çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ“ä½œç³»ç»Ÿçº¿ç¨‹æ‰§è¡ŒBIOï¼Œæ­¤æ—¶çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹çŠ¶æ€æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯åœ¨Javaä¸­è¿˜æ˜¯ä¿æŒè¿è¡Œçš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t1 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// NEW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t1 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//TERMINATED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t2 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//RUNNABLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">ThreadState</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//TIME_WAITING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">ThreadState</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10000000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t4</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//BLOCKED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t5</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//WAITING
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a thread which has not yet started.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">NEW</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a runnable thread.  A thread in the runnable
</span></span></span><span class="line"><span class="cl"><span class="cm">     * state is executing in the Java virtual machine but it may
</span></span></span><span class="line"><span class="cl"><span class="cm">     * be waiting for other resources from the operating system
</span></span></span><span class="line"><span class="cl"><span class="cm">     * such as processor.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUNNABLE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a thread blocked waiting for a monitor lock.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread in the blocked state is waiting for a monitor lock
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to enter a synchronized block/method or
</span></span></span><span class="line"><span class="cl"><span class="cm">     * reenter a synchronized block/method after calling
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Object#wait() Object.wait}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLOCKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a waiting thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread is in the waiting state due to calling one of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * following methods:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;A thread in the waiting state is waiting for another thread to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * perform a particular action.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * on an object is waiting for another thread to call
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is waiting for a specified thread to terminate.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAITING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a waiting thread with a specified waiting time.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread is in the timed waiting state due to calling one of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the following methods with a specified positive waiting time:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TIMED_WAITING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a terminated thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The thread has completed execution.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TERMINATED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±javaæºç å¯ä»¥å‘ç°ï¼ŒJava APIä¸­å¯¹çº¿ç¨‹çŠ¶æ€çš„æè¿°æœ‰6ç§</p>
<h5 id="javaè®¡ç®—çº¿ç¨‹çŠ¶æ€">Javaè®¡ç®—çº¿ç¨‹çŠ¶æ€</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">toThreadState</span><span class="o">(</span><span class="kt">int</span> <span class="n">var0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">4</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">RUNNABLE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">1024</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">BLOCKED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">16</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">WAITING</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">32</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">TIMED_WAITING</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">TERMINATED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="n">State</span><span class="o">.</span><span class="na">NEW</span> <span class="o">:</span> <span class="n">State</span><span class="o">.</span><span class="na">RUNNABLE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>JavaThreadçš„çŠ¶æ€å¯¹åº”Jvmçš„çŠ¶æ€</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Java Thread Status for JVMTI and M&amp;M use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This thread status info is saved in threadStatus field of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// java.lang.Thread java class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">enum</span> <span class="n">ThreadStatus</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NEW</span>                      <span class="o">=</span> <span class="n">0</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUNNABLE</span>                 <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// runnable / running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_RUNNABLE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SLEEPING</span>                 <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Thread.sleep()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_SLEEPING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN_OBJECT_WAIT</span>           <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Object.wait()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_INDEFINITELY</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_IN_OBJECT_WAIT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN_OBJECT_WAIT_TIMED</span>     <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Object.wait(long)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_IN_OBJECT_WAIT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PARKED</span>                   <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// LockSupport.park()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_INDEFINITELY</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_PARKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PARKED_TIMED</span>             <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// LockSupport.park(long)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_PARKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLOCKED_ON_MONITOR_ENTER</span> <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// (re-)entering a synchronization block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TERMINATED</span>               <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_TERMINATED</span>
</span></span><span class="line"><span class="cl">  <span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">Thread State Flags</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Constant</td>
<td style="text-align:left">Value</td>
<td style="text-align:left">Description</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_ALIVE</code></td>
<td style="text-align:left">0x0001</td>
<td style="text-align:left">Thread is alive. Zero if thread is new (not started) or terminated.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_TERMINATED</code></td>
<td style="text-align:left">0x0002</td>
<td style="text-align:left">Thread has completed execution.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_RUNNABLE</code></td>
<td style="text-align:left">0x0004</td>
<td style="text-align:left">Thread is runnable.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER</code></td>
<td style="text-align:left">0x0400</td>
<td style="text-align:left">Thread is waiting to enter a synchronization block/method or, after an <code>Object.wait()</code>, waiting to re-enter a             synchronization block/method.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING</code></td>
<td style="text-align:left">0x0080</td>
<td style="text-align:left">Thread is waiting.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING_INDEFINITELY</code></td>
<td style="text-align:left">0x0010</td>
<td style="text-align:left">Thread is waiting without a timeout.   For example, <code>Object.wait()</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</code></td>
<td style="text-align:left">0x0020</td>
<td style="text-align:left">Thread is waiting with a maximum time to wait specified.             For example, <code>Object.wait(long)</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_SLEEPING</code></td>
<td style="text-align:left">0x0040</td>
<td style="text-align:left">Thread is sleeping &ndash; <code>Thread.sleep(long)</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_IN_OBJECT_WAIT</code></td>
<td style="text-align:left">0x0100</td>
<td style="text-align:left">Thread is waiting on an object monitor &ndash; <code>Object.wait</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_PARKED</code></td>
<td style="text-align:left">0x0200</td>
<td style="text-align:left">Thread is parked, for example: <code>LockSupport.park</code>,             <code>LockSupport.parkUtil</code> and <code>LockSupport.parkNanos</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_SUSPENDED</code></td>
<td style="text-align:left">0x100000</td>
<td style="text-align:left">Thread suspended.        <code>java.lang.Thread.suspend()</code>        or a JVM TI suspend function             (such as <a class="link" href="file:///home/alanjin/gitspace/jdk10/hotspot/src/share/vm/prims/jvmti.xml#SuspendThread" ><code>SuspendThread</code></a>)             has been called on the thread. If this bit         is set, the other bits refer to the thread state before suspension.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_INTERRUPTED</code></td>
<td style="text-align:left">0x200000</td>
<td style="text-align:left">Thread has been interrupted.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_IN_NATIVE</code></td>
<td style="text-align:left">0x400000</td>
<td style="text-align:left">Thread is in native code&ndash;that is, a native method is running             which has not called back into the VM or Java programming             language code.                          This flag is not set when running VM compiled Java programming             language code nor is it set when running VM code or   VM support code. Native VM interface functions, such as JNI and             JVM TI functions, may be implemented as VM code.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_1</code></td>
<td style="text-align:left">0x10000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_2</code></td>
<td style="text-align:left">0x20000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_3</code></td>
<td style="text-align:left">0x40000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
</tbody>
</table></div>
<p><strong>ä»c++å±‚é¢çœ‹c++çº¿ç¨‹çš„çŠ¶æ€</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">JavaThreadState</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_thread_uninitialized</span>     <span class="o">=</span>  <span class="n">0</span><span class="o">,</span> <span class="c1">// should never happen (missing initialization)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_new</span>               <span class="o">=</span>  <span class="n">2</span><span class="o">,</span> <span class="c1">// just starting up, i.e., in process of being initialized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_new_trans</span>         <span class="o">=</span>  <span class="n">3</span><span class="o">,</span> <span class="c1">// corresponding transition state (not used, included for completness)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_native</span>         <span class="o">=</span>  <span class="n">4</span><span class="o">,</span> <span class="c1">// running in native code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_native_trans</span>   <span class="o">=</span>  <span class="n">5</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_vm</span>             <span class="o">=</span>  <span class="n">6</span><span class="o">,</span> <span class="c1">// running in VM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_vm_trans</span>       <span class="o">=</span>  <span class="n">7</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_Java</span>           <span class="o">=</span>  <span class="n">8</span><span class="o">,</span> <span class="c1">// running in Java or in stub code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_Java_trans</span>     <span class="o">=</span>  <span class="n">9</span><span class="o">,</span> <span class="c1">// corresponding transition state (not used, included for completness)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_blocked</span>           <span class="o">=</span> <span class="n">10</span><span class="o">,</span> <span class="c1">// blocked in vm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_blocked_trans</span>     <span class="o">=</span> <span class="n">11</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_max_state</span>         <span class="o">=</span> <span class="n">12</span>  <span class="c1">// maximum thread state+1 - used for statistics allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>_thread_new:</strong> æ–°åˆ›å»ºçš„çº¿ç¨‹</p>
<p><strong>_thread_in_Java:</strong> åœ¨è¿è¡ŒJavaä»£ç </p>
<p><strong>_thread_in_vm:</strong> åœ¨è¿è¡ŒJVMæœ¬èº«çš„ä»£ç </p>
<p><strong>_thread_in_native:</strong> åœ¨è¿è¡Œnativeä»£ç </p>
<p><strong>_thread_blocked:</strong> çº¿ç¨‹è¢«é˜»å¡äº†ï¼ŒåŒ…æ‹¬ç­‰å¾…ä¸€ä¸ªé”ï¼Œç­‰å¾…ä¸€ä¸ªæ¡ä»¶ï¼Œsleepï¼Œæ‰§è¡Œä¸€ä¸ªé˜»å¡çš„IOç­‰</p>
<h4 id="javaé‡‡ç”¨çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•">Javaé‡‡ç”¨çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•</h4>
<p>**ä¸¤ç§è°ƒåº¦æ¨¡å‹ï¼š**åˆ†æ—¶è°ƒåº¦æ¨¡å‹å’ŒæŠ¢å å¼è°ƒåº¦æ¨¡å‹</p>
<p><strong>javaé‡‡ç”¨çš„æ˜¯æŠ¢å å¼è°ƒåº¦æ¨¡å‹ï¼Œå³ä¼˜å…ˆçº§è¶Šé«˜çš„çº¿ç¨‹å ç”¨CPU</strong></p>
<h4 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨thread-schedulerå’Œæ—¶é—´åˆ†ç‰‡time-slicing-">ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨(Thread Scheduler)å’Œæ—¶é—´åˆ†ç‰‡(Time Slicing )ï¼Ÿ</h4>
<p>çº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»ŸæœåŠ¡ï¼Œå®ƒè´Ÿè´£ä¸º Runnable çŠ¶æ€çš„çº¿ç¨‹åˆ†é… CPU æ—¶é—´ã€‚ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶å¯åŠ¨å®ƒï¼Œå®ƒçš„æ‰§è¡Œä¾¿ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨çš„å®ç°ã€‚</p>
<p>æ—¶é—´åˆ†ç‰‡æ˜¯æŒ‡å°†å¯ç”¨çš„ CPU æ—¶é—´åˆ†é…ç»™å¯ç”¨çš„ Runnable çº¿ç¨‹çš„è¿‡ç¨‹ã€‚åˆ†é… CPU æ—¶é—´å¯ä»¥åŸºäºçº¿ç¨‹ä¼˜å…ˆçº§æˆ–è€…çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´ã€‚</p>
<p>çº¿ç¨‹è°ƒåº¦å¹¶ä¸å—åˆ° Java è™šæ‹Ÿæœºæ§åˆ¶ï¼Œæ‰€ä»¥ç”±åº”ç”¨ç¨‹åºæ¥æ§åˆ¶å®ƒæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸è¦è®©ä½ çš„ç¨‹åºä¾èµ–äºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼‰ã€‚</p>
<h2 id="4-å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹">4 å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</h2>
<h3 id="41-ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜">4.1 ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</h3>
<p>å½“è®©ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹ static int a = 0 åš a++,a&ndash;;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">contextSwitch</span><span class="o">()</span><span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t0</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‚£é“ç†æœ€åçš„ç»“æœaåº”è¯¥ä¸º0ä½†æ˜¯ å´å‡ºç°äº†è¿™ç§æƒ…å†µ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316231530549.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316231530549"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316230546613.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316230546613"
	
	
></p>
<p>åœ¨çº¿ç¨‹1è¿˜æ²¡æ‰§è¡Œistroe_1æ—¶è¢«çº¿ç¨‹2æŠ¢å ï¼Œç”±äºi++æ˜¯å…ˆæ”¹å˜å˜é‡è¡¨ä¸­çš„å€¼ï¼Œåœ¨è¿”å›æ“ä½œæ•°æ ˆçš„åŸæœ¬å€¼ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ²¡è¿”å›å€¼çº¿ç¨‹2å–èµ°äº†åŸæœ¬å˜é‡è¡¨ä¸­çš„å€¼ç„¶åè¿›è¡Œæ“ä½œå°±ä¼šå¯¼è‡´åŸæœ¬ä¸º0çš„å€¼æ”¹å˜ã€‚</p>
<h3 id="42-ä¸´ç•ŒåŒºcritical-section">4.2 ä¸´ç•ŒåŒºCritical Section</h3>
<ul>
<li>
<p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„</p>
</li>
<li>
<p>é—®é¢˜å‡ºç°åœ¨çº¿ç¨‹è®¿é—®çš„<strong>å…±äº«èµ„æº</strong></p>
<p>å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è¯»å†™æ“ä½œå‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p>
</li>
<li>
<p>ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹<strong>å…±äº«èµ„æº</strong>çš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸º<strong>ä¸´ç•ŒåŒº</strong></p>
</li>
</ul>
<h4 id="ç«æ€æ¡ä»¶">ç«æ€æ¡ä»¶</h4>
<p>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„<strong>æ‰§è¡Œåºåˆ—ä¸åŒ</strong>è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œå°±å«åšç«æ€æ¡ä»¶</p>
<h3 id="43-synchronized-è§£å†³æ–¹æ¡ˆ">4.3 synchronized è§£å†³æ–¹æ¡ˆ</h3>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock</li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li>
</ul>
<p>synchronizedä¿—ç§°ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶ä»–çº¿ç¨‹æƒ³è·å–è¯¥å¯¹è±¡æ—¶ä¼šè¢«é˜»å¡ä½ã€‚è¿™æ ·å°±å¯ä»¥ä¸ç”¨æ‹…å¿ƒä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºä¸­çš„èµ„æºã€‚y</p>
<p>synchronizedä»£ç æ ¼å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">synchronized</span> <span class="o">(</span><span class="c1">//é”å¯¹è±¡) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//ä»£ç å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">synchronization</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span><span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t1</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">RUNNABLE
</span></span><span class="line"><span class="cl">RUNNABLE
</span></span><span class="line"><span class="cl">0æˆ–1
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€æ³¨ã€‘ï¼šè¿™<strong>é‡Œç»“æœä¸ºä»€ä¹ˆä¼šæœ‰1å‘¢ï¼Œå› ä¸ºè·å–1çš„æ—¶å€™æ²¡æœ‰åŠ é”</strong>ï¼Œ<strong>çº¿ç¨‹è·å–å¯¹è±¡é”å¹¶ä¸æ˜¯èƒ½ä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œå½“çº¿ç¨‹çš„æ—¶é—´ç‰‡ä½¿ç”¨å®Œæ—¶ï¼Œä»–è¿˜æ˜¯ä¼šè¢«è¸¢å‡ºCPUæˆ¿é—´</strong>ï¼Œä½†æ˜¯æ‰‹ä¸­ä¸€ç›´æ‹¿ç€æˆ¿é—´é’¥åŒ™ï¼Œæ²¡æœ‰é’¥åŒ™çš„äººæ˜¯æ— æ³•è¿›å…¥è¿è¡Œä¸”æ— æ³•è¢« ï¼Œå½“ä¸‹æ¬¡è½®åˆ°è¯¥çº¿ç¨‹æ—¶ï¼Œå³å¯è¿›å…¥çº¿ç¨‹ç»§ç»­å·¥ä½œï¼Œåªæœ‰å½“ä»£ç å—æ‰§è¡Œå®Œæ—¶ï¼Œæ‰ä¼šæŠŠé”è®©å‡ºï¼Œå”¤é†’é˜»å¡çº¿ç¨‹ã€‚</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319174358728.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319174358728"
	
	
></p>
<p>synchronized å®é™…æ˜¯ç”¨<strong>å¯¹è±¡é”</strong>ä¿è¯äº†<strong>ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§</strong>ï¼Œä¸´ç•ŒåŒºçš„ä»£ç æ˜¯å¯¹å¤–ä¸å¯åˆ†çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚</p>
<p>**æ€è€ƒ **</p>
<ul>
<li><strong>å¦‚æœæŠŠsynchronized(obj)æ”¾åœ¨forå¾ªç¯å¤–ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ</strong></li>
</ul>
<blockquote>
<p>â€‹         è¿˜æ˜¯å¤„äºåŠ é”çŠ¶æ€ï¼Œä¸ä¼šå‡ºç°ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</p>
</blockquote>
<ul>
<li><strong>å¦‚æœt1 synchronized(obj1) è€Œ t2 synchronized(obj2) ä¼šæ€ä¹ˆæ ·ï¼Ÿ</strong></li>
</ul>
<blockquote>
<p>ç”±äºt1å’Œt2è·å–çš„æ˜¯ä¸åŒçš„é”ï¼Œæ˜¯ç»™ä¸åŒçš„å¯¹è±¡åŠ é”ï¼Œæ‰€ä»¥ä¼šå‡ºç°ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</p>
</blockquote>
<ul>
<li><strong>å¦‚æœt1 synchronized(obj) è€Œ t2æ²¡æœ‰åŠ é”ä¼šæ€ä¹ˆæ ·ï¼Ÿ</strong></li>
</ul>
<blockquote>
<p>ç”±äºt2æ²¡æœ‰è·å–å¯¹è±¡é”ï¼Œæ‰€ä»¥ä¸ä¼šè¢«é˜»å¡ï¼Œè¿˜æ˜¯ä¼šè¿›å…¥CPUè¿è¡Œï¼Œä¼šå‡ºç°ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</p>
</blockquote>
<h5 id="synchronized-ä½¿ç”¨åœ¨æ–¹æ³•ä¸Š">synchronized ä½¿ç”¨åœ¨æ–¹æ³•ä¸Š</h5>
<p>ç”¨åœ¨staticä¸Šé¢æ˜¯é”ä½å½“å‰classçš„å­—èŠ‚ç æ–‡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//ç­‰ä»·äº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//ç­‰ä»·äº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">Test</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="44-å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ">4.4 å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</h3>
<p><strong>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></p>
<ul>
<li>å¦‚æœæ— å…±äº«ï¼Œåˆ™çº¿ç¨‹ååˆ†å®‰å…¨</li>
<li>å¦‚æœæœ‰å…±äº«ï¼Œæ ¹æ®çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜æ¥åˆ†ä¸¤ç§æƒ…å†µ</li>
</ul>
<blockquote>
<p>â€‹     å¦‚æœåªæœ‰åªè¯»æ“ä½œï¼Œåˆ™å®‰å…¨</p>
<p>â€‹     å¦‚æœæœ‰åªè¯»å’Œåªå†™æ“ä½œï¼Œåˆ™çº¿ç¨‹ä¸å®‰å…¨</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ä¸ä¸€å®šå®‰å…¨</li>
</ul>
<blockquote>
<p>â€‹      å½“å±€éƒ¨å˜é‡ä¸­çš„å¼•ç”¨å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹å…±äº«ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨ä¸€ä¸ªå±€éƒ¨å˜é‡æ—¶ï¼Œå°±ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
</blockquote>
<h4 id="å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ">å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ä¸Šé¢è¿™ä¸ªæ–¹æ³•ä¸­çš„iæ˜¯ä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„</strong></p>
<blockquote>
<p>å› ä¸ºåœ¨Jvmè™šæ‹Ÿæœºä¸­ï¼Œæ¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å°±ä¼šç”Ÿæˆä¸€ä¸ªæ ˆå¸§ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹ä¸­çš„æ ˆå¸§æ˜¯äº’ä¸å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ä¼šåœ¨è‡ªå·±çš„javaè™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨ç”Ÿæˆä¸€ä¸ªå˜é‡i</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319221818683.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319221818683"
	
	
></p>
<p><strong>æ¡ˆä¾‹ï¼š</strong></p>
<p>æˆå‘˜å˜é‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadUnsafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadUnsafe</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exception in thread &#34;Thread1&#34; java.lang.IndexOutOfBoundsException: Index: 0, Size: 1
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.rangeCheck(ArrayList.java:653)
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.remove(ArrayList.java:492)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadUnsafe.method3(ThreadSecurity.java:48)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadUnsafe.method1(ThreadSecurity.java:42)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadSecurity.lambda$test2$0(ThreadSecurity.java:18)
</span></span><span class="line"><span class="cl">	at java.lang.Thread.run(Thread.java:748)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äºæ‰€æœ‰çº¿ç¨‹éƒ½åªè®¿é—®å †ä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå¯¼è‡´èµ„æºå…±äº«ï¼Œæ‰€ä»¥ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜è€ŒæŠ¥é”™</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319223343207.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319223343207"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321200950432.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321200950432"
	
	
></p>
<p>å±€éƒ¨å˜é‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadSafe</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadSafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319223453960.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319223453960"
	
	
></p>
<p><strong>å±€éƒ¨å˜é‡çº¿ç¨‹ä¸å®‰å…¨æ¡ˆä¾‹</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadsubSafeClass</span> <span class="kd">extends</span> <span class="n">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test4</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadsubSafeClass</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadsubSafeClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exception in thread &#34;Thread-18115&#34; java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.rangeCheck(ArrayList.java:653)
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.remove(ArrayList.java:492)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadsubSafeClass.lambda$method3$0(ThreadSecurity.java:77)
</span></span><span class="line"><span class="cl">	at java.lang.Thread.run(Thread.java:748)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡º åœ¨å­ç±»ThreadsubSafeClassä¸­ï¼Œé‡å†™äº†çˆ¶ç±»çš„method3æ–¹æ³•ï¼Œå¹¶ä¸”å¼€è¾Ÿäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ­¤æ—¶è¿™ä¸ªæ–°çš„çº¿ç¨‹ä¸test4æ–¹æ³•å¼€è¾Ÿçš„çº¿ç¨‹å…±äº«ä¸€ä¸ªlistå±€éƒ¨å˜é‡ï¼Œè¿™å°±ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ã€‚</p>
<p>ã€æ³¨ã€‘ï¼šæ–¹æ³•ä¿®é¥°ç¬¦ï¼Œæ˜¯å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé˜²æ­¢çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ï¼Œæ¯”å¦‚private,finalæ–¹æ³•å°±å¯ä»¥è®©å­ç±»æ— æ³•é‡å†™å‡ºç°å®‰å…¨é—®é¢˜ã€‚</p>
<h3 id="45-å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»">4.5 å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»</h3>
<ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>Hashtable</li>
<li>java.util.comcurrentåŒ…ä¸‹çš„ç±»</li>
</ul>
<p>è¿™é‡Œçš„çº¿ç¨‹å®‰å…¨æŒ‡çš„æ˜¯ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„ï¼Œä½†æ˜¯å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„</strong></p>
<h4 id="ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§">ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§</h4>
<blockquote>
<p>Stringï¼ŒIntegerç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œæ‰€ä»¥æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</blockquote>
<p>ä¾‹å¦‚ï¼šString.class æœ‰ finalå­—ç¬¦ä¿®é¥° æ¥è¡¨ç¤ºStringå­—ç¬¦ä¸²ä¸å¯å˜ã€‚</p>
<p>String.substring()æ–¹æ³• ä¹Ÿæ˜¯åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„å­—ç¬¦ä¸²å˜é‡</strong>ï¼Œè€Œä¸æ˜¯ä¿®æ”¹è‡ªèº«å€¼å±æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">substring</span><span class="o">(</span><span class="kt">int</span> <span class="n">beginIndex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">beginIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">subLen</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">beginIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">subLen</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">beginIndex</span><span class="o">,</span> <span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="46-æ¡ˆä¾‹">4.6 æ¡ˆä¾‹</h3>
<h4 id="é“¶è¡Œè½¬é’±">é“¶è¡Œè½¬é’±</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.b_shareProblems</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bank</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">a</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">randomAmount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">b</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">randomAmount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ€»é‡‘é¢:{}&#34;</span><span class="o">,</span><span class="n">a</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">b</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">randomAmount</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">5</span><span class="o">)+</span><span class="n">1</span><span class="o">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Account</span><span class="o">(</span><span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">=</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMoney</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMoney</span><span class="o">(</span><span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">=</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Account</span> <span class="n">target</span><span class="o">,</span><span class="kt">int</span> <span class="n">money</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">&gt;</span> <span class="n">money</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">money</span><span class="o">-</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:28:02.747 [main] DEBUG JUC.b_shareProblems.bank - æ€»é‡‘é¢:938
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±è¾“å‡ºå¯ä»¥çœ‹å‡º åŸæœ¬åº”è¯¥æ€»é‡‘é¢ä¸º1000ï¼Œç°åœ¨åè€Œè¿˜å‡å°‘äº†ï¼Œè¯´æ˜ç”±äºçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢å‡ºç°é—®é¢˜ã€‚</p>
<p>å¦‚æœåŠ é”æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠ ï¼Ÿ</p>
<ul>
<li><strong>å¯¹transferæ–¹æ³•åŠ ä¸Šsynchronizedï¼Ÿ</strong></li>
</ul>
<p>å¦‚æœæˆ‘ä»¬å¯¹transferæ–¹æ³•åŠ ä¸Šsynchronizedä¿®é¥°ç¬¦ï¼Œåªä¼šå¯¹ç±»å®ä¾‹æœ¬èº«è¿›è¡ŒåŠ é”(this)ï¼Œç”±äºè´¦æˆ·Aå’Œè´¦æˆ·Bæ˜¯ä¸åŒçš„ç±»ï¼Œæ‰€ä»¥æ— æ³•æ”¾åœ¨çº¿ç¨‹A,Bçš„ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<ul>
<li><strong>å¯¹Account.classåŠ é”ï¼Ÿ</strong></li>
</ul>
<p>å¯ä»¥é˜²æ­¢çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ä¼šæ˜¯çš„æ•´ä¸ªç±»è¢«å°é”ï¼Œè€Œå¯¼è‡´æ€§èƒ½ä¸‹é™</p>
<h3 id="47-monitoræ¦‚å¿µ">4.7 Monitoræ¦‚å¿µ</h3>
<h4 id="javaå¯¹è±¡å¤´">Javaå¯¹è±¡å¤´</h4>
<p>Integer : 8(å¯¹è±¡å¤´)+4(å€¼)+2(è¡¥ä½ è¦æ±‚8ä½æ•°çš„å€æ•°)</p>
<p>int: 4</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213336713.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213336713"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213446004.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213446004"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213554440.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213554440"
	
	
></p>
<h4 id="monitoré”">Monitor(é”)</h4>
<p>Monitoræ˜¯æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªç›‘ç®¡è€…</p>
<blockquote>
<p>ä¸€ä¸ªmonitorå¯¹è±¡åŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ªå…³é”®å­—æ®µï¼šcxqï¼ˆä¸‹å›¾ä¸­çš„ContentionListï¼‰ï¼ŒEntryList ï¼ŒWaitSetï¼Œownerã€‚</p>
<p>å…¶ä¸­cxq ï¼ŒEntryList ï¼ŒWaitSetéƒ½æ˜¯ç”±ObjectWaiterçš„é“¾è¡¨ç»“æ„ï¼ŒowneræŒ‡å‘æŒæœ‰é”çš„çº¿ç¨‹ã€‚</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220712184945639.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="ä¸Šé”æµç¨‹">ä¸Šé”æµç¨‹</h5>
<ul>
<li>å½“æœ‰ä¸€ä¸ªä¸´ç•ŒåŒºä»£ç è¢«ä¸Šé”æ—¶ï¼Œä¸Šé”å¯¹è±¡objä¸­çš„MarkWordå°†æ”¹å˜ä¸º<strong>HeavyLockçŠ¶æ€</strong>ï¼Œå¹¶ä¸”æŒ‡å‘ä¸€ä¸ªMonitoré”</li>
<li>å½“Thread-2 è¦ä½¿ç”¨ä¸´ç•ŒåŒºä»£ç æ—¶ï¼Œ<strong>ä¼šæŸ¥çœ‹è¢«ä¸Šé”çš„å¯¹è±¡objå¯¹åº”çš„Monitoré”</strong>ï¼ŒæŸ¥çœ‹Owneræ˜¯å¦ä¸ºç©ºï¼Œ<strong>å¦‚æœä¸ºç©ºåˆ™æˆä¸ºMonitorçš„Ownerå¹¶ä½¿ç”¨ä¸´ç•ŒåŒºä»£ç </strong></li>
<li>å½“Thread-1æ¥è®¿é—®ä¸´ç•ŒåŒºä»£ç æ—¶ï¼Œä¼šæŸ¥çœ‹è¢«ä¸Šé”çš„å¯¹è±¡objå¯¹åº”çš„Monitoré”ï¼ŒæŸ¥çœ‹Owneræ˜¯å¦ä¸ºç©ºï¼Œ<strong>æ­¤æ—¶Ownerä¸ä¸ºç©ºçš„è¯ï¼Œå°†Thread-1æ”¾å…¥EntryListä¸­ï¼Œå¹¶ä¸”å°†çŠ¶æ€è®¾ç½®ä¸ºBLOCKED</strong></li>
<li>å½“Thread-3 æ¥è®¿é—®ä¸´ç•ŒåŒºä»£ç æ—¶ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œå¹¶ä¸”æ”¾å…¥Thread-1ä¹‹å(é“¾è¡¨ç»“æ„)</li>
<li>å½“Thread-2ä½¿ç”¨å®Œä¸´ç•ŒåŒºä»£ç æ—¶ï¼Œ<strong>å°†å”¤é†’EntryListä¸­çš„BLOCKEDé˜Ÿåˆ—å¹¶ä¸”è¿›è¡Œé”ç«äº‰ï¼ˆéå…¬å¹³ï¼‰ï¼Œæ¥æˆä¸ºMonitorçš„Owner</strong></li>
<li>å¦‚æœThread-1ä¹‹å‰è·å–è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³åˆ™è¿›å…¥WatingçŠ¶æ€</li>
</ul>
<h4 id="synchronizedå­—èŠ‚ç è§£æ">synchronizedå­—èŠ‚ç è§£æ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Monitor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">counter</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321221508374.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321221508374"
	
	
></p>
<p>åœ¨synchronizedåŠ é”çš„ä»£ç å—ä¸­ã€‚</p>
<p><strong>0: getstatic</strong> è·å–lockä»£ç çš„å¼•ç”¨</p>
<p><strong>1: astore_1</strong> å¹¶å°†lockä»£ç çš„å¼•ç”¨åŠ å…¥å¯¼å±€éƒ¨å˜é‡æ§½ä¸­</p>
<p><strong>5: monitorenter</strong> å°†lockå¯¹è±¡MarkWordå˜ä¸ºMonitoræŒ‡é’ˆ</p>
<p><strong>14:</strong> <strong>aload_1</strong> å°†lockå¼•ç”¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸­</p>
<p><strong>15: monitorexit</strong> å°†lockå¯¹è±¡MarkWordé‡ç½®ï¼Œå”¤é†’EntryList</p>
<p><strong>19~23</strong> ä»£ç æ˜¯å½“synchronizedä¸­çš„ä»£ç å—å‡ºç°å¼‚å¸¸æ—¶ï¼Œè¿›è¡Œå¼‚å¸¸æŠ›å‡ºå¹¶ä¸”é‡ç½®é”å¯¹è±¡</p>
<h3 id="48-è½»é‡çº§é”">4.8 è½»é‡çº§é”</h3>
<p>**è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼š**å¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯çº¿ç¨‹è®¿é—®æ—¶é—´é”™å¼€ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;LightWeightLock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åˆ›å»ºé”è®°å½•(Lock Record)å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å¯¹è±¡çš„MarkWord</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322204732367.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322204732367"
	
	
></p>
<ul>
<li>è®©é”è®°å½•ä¸­çš„Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶ä¸”è®©cas æ›¿æ¢ Object çš„ Mark Wordï¼Œå°†Mark Wordçš„å€¼å­˜å…¥é”è®°å½•</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322211122103.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322211122103"
	
	
></p>
<ul>
<li>å¦‚æœcasæ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†<strong>é”è®°å½•åœ°å€å’ŒçŠ¶æ€00</strong>ï¼Œè¡¨ç¤ºæœ‰è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212151746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212151746"
	
	
></p>
<ul>
<li>å¦‚æœcaså¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</li>
</ul>
<p>â€‹    1,å¦‚æœæ˜¯å…¶å®ƒçš„çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€</p>
<p>â€‹     2,å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡Lock recordä½œä¸ºé‡å…¥çš„è®¡æ•°</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212943855.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212943855"
	
	
></p>
<ul>
<li>è§£é”è¿‡ç¨‹ï¼Œå¦‚æœThread-0ä¸­æœ‰è®°å½•ä¸ºnullçš„é”è®°å½•ï¼Œåˆ™è¡¨ç¤ºæœ‰é‡å…¥ï¼Œå°†é”è®°å½•ç§»é™¤ï¼Œå¹¶å°†é‡å…¥-1ï¼›</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212151746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212151746"
	
	
></p>
<ul>
<li>
<p>å½“é€€å‡ºé”è¿‡ç¨‹ä¸­ï¼ŒLock Recordè®°å½•ä¸­ä¸ä¸ºNullï¼Œåˆ™åˆ©ç”¨caså°†MarkWordå¯¹è±¡æ¢å¤</p>
<p>1ï¼ŒæˆåŠŸï¼Œè§£é”æˆåŠŸ</p>
<p>2ï¼Œå¤±è´¥ï¼Œè¯´æ˜é”è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</p>
</li>
</ul>
<h3 id="49-é”è†¨èƒ€">4.9 é”è†¨èƒ€</h3>
<p>å¦‚æœå†å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶çš„ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶ä»–çš„çº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”(æœ‰ç«äº‰)ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”</p>
<ul>
<li>å½“Thread-1 è®¿é—®Objectå¯¹è±¡æ—¶ï¼Œè¿›è¡Œcasäº¤æ¢ï¼Œå‘ç°Objectå¯¹è±¡å·²ç»è¢«èµ‹ä¸Šè½»é‡çº§é”ï¼Œåˆ™è¿›å…¥é”è†¨èƒ€</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322220646392.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322220646392"
	
	
></p>
<ul>
<li>Thread-1åŠ é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹</li>
</ul>
<p>â€‹    1ï¼Œä¸ºObjectå¯¹è±¡ç”³è¯·Monitorï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€</p>
<p>â€‹    2ï¼Œç„¶åè‡ªå·±è¿›å…¥Monitorçš„EntryList BLOCKED</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322221533904.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322221533904"
	
	
></p>
<ul>
<li>å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨caså°†MarkWordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§Monitoråœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œè®¾ç½®Ownerä¸ºNullï¼Œå”¤é†’EntryListä¸­çš„BLOCKEDçº¿ç¨‹</li>
</ul>
<h3 id="410-è‡ªæ—‹ä¼˜åŒ–å¤šæ ¸cpu">4.10 è‡ªæ—‹ä¼˜åŒ–(å¤šæ ¸CPU)</h3>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚(å¯ä»¥é˜²æ­¢ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæé«˜æ€§èƒ½)</p>
<p><strong>è‡ªæ—‹æˆåŠŸçš„æƒ…å†µ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322223354746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322223354746"
	
	
></p>
<p><strong>è‡ªæ—‹å¤±è´¥çš„æƒ…å†µ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323195519375.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323195519375"
	
	
></p>
<ul>
<li>åœ¨Java6ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚åˆšåˆšå¯¹è±¡è‡ªæ—‹æˆåŠŸçš„è¯ï¼Œå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å‡å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹</li>
<li><strong>è‡ªé€‚åº”è‡ªæ—‹è§£å†³çš„æ˜¯â€œé”ç«äº‰æ—¶é—´ä¸ç¡®å®šâ€çš„é—®é¢˜</strong></li>
<li>è‡ªæ—‹ä¼šå ç”¨CPUæ—¶é—´ï¼Œå•æ ¸CPUè‡ªæ—‹ç­‰äºæµªè´¹æ—¶é—´</li>
</ul>
<h3 id="411-åå‘é”">4.11 åå‘é”</h3>
<p>è½»é‡çº§é”åœ¨æ— å®é™…é”ç«äº‰æ—¶ï¼Œæ¯æ¬¡çš„é”é‡å…¥éƒ½è¦è¿›è¡Œæ— æ„ä¹‰çš„casæ“ä½œï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>Java 6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼›åªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡çš„MarkWordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–°CASï¼Œä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰ã€‚</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323200911602.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323200911602"
	
	
></p>
<h4 id="åå‘é”è·å–è¿‡ç¨‹">åå‘é”è·å–è¿‡ç¨‹</h4>
<p>åŒ¿ååå‘çŠ¶æ€ï¼Œå³MarkWordï¼ŒThreadIdéƒ¨åˆ†ä¸º0ï¼Œè¡¨é¢å¤„äºåå‘çŠ¶æ€ï¼Œä½†æ˜¯ä¸ºåå‘ä»»ä½•é”ã€‚</p>
<ul>
<li>çº¿ç¨‹Aè¿›å…¥åŒæ­¥ä»£ç å—ï¼Œé¦–å…ˆæ£€æŸ¥markword å¤´éƒ¨åˆ†æ˜¯å¦ä¸º 01 å³åå‘é”æˆ–æ— é”çŠ¶æ€ï¼Œè‹¥æ˜¯åˆ™è¿›å…¥ä¸‹ä¸€æ­¥</li>
<li>çº¿ç¨‹AæŸ¥çœ‹biased_lockçš„æ•°å€¼ï¼Œå¦‚æœä¸º0ï¼Œåˆ™ä»£è¡¨è¯¥å¯¹è±¡ç¦ç”¨åå‘é”ï¼Œä¸CASç›´æ¥è¿›è¡Œé”å‡çº§ï¼Œå¦‚æœä¸º1ï¼Œåˆ™è¿›å…¥åå‘é”åŠ é”ç¯å¢ƒ</li>
<li>æ­¤æ—¶çº¿ç¨‹AæŸ¥çœ‹ThreadIdçš„æ•°å€¼</li>
</ul>
<blockquote>
<ul>
<li>ä¸ºè‡ªèº«IDï¼Œåˆ™ä¸è¿›è¡ŒCASï¼Œè€Œæ˜¯ç›´æ¥åœ¨æ ˆå¸§ä¸­åŠ ä¸€æ¡è‡ªå·±çš„é”è®°å½•</li>
<li>ä¸ä¸ºè‡ªèº«IDï¼ŒIDä¸º0ï¼Œåˆ™ä»£è¡¨æ— åå‘ï¼Œæ­¤æ—¶è¿›è¡ŒCASï¼ŒCASæˆåŠŸåˆ™åå‘æˆåŠŸ</li>
<li>ä¸ä¸ºè‡ªèº«IDï¼ŒIDä¸ºå…¶ä»–å€¼ï¼Œåˆ™ä»£è¡¨å·²ç»æœ‰åå‘ï¼Œæ­¤æ—¶è¿›è¡ŒCASå¤±è´¥ï¼Œå‡çº§ä¸ºè½»é‡çº§é”</li>
</ul>
</blockquote>
<h4 id="åå‘çŠ¶æ€">åå‘çŠ¶æ€</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323203531014.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323203531014"
	
	
></p>
<p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p>
<ul>
<li>(java 17)é»˜è®¤ç¦ç”¨åå‘é”ï¼Œå¦‚æœé»˜è®¤å¼€å¯åå‘é”(é»˜è®¤å¼€å¯)ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºå,markwordå€¼ä¸º0x05å³æœ€åä¸‰ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„Thread,epoch,ageéƒ½è®¾ç½®ä¸º0</li>
<li>åå‘é”æ˜¯é»˜è®¤å»¶è¿Ÿçš„ï¼Œä¸ä¼šå†ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œè‹¥æƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ VMå‚æ•°</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-XX:BiasedLockingStarupDelay=0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>åŸå› æ˜¯ JVM å†…éƒ¨çš„ä»£ç æœ‰å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†synchronizedï¼Œå¦‚æœç›´æ¥å¼€å¯åå‘ï¼Œäº§ç”Ÿç«äº‰å°±è¦æœ‰é”å‡çº§ï¼Œä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥å°±æœ‰äº†å»¶è¿Ÿç­–ç•¥ã€‚</p>
</blockquote>
<p><img src="http://inews.gtimg.com/newsapp_bt/0/14383522992/641"
	
	
	
	loading="lazy"
	
		alt="å›¾ç‰‡"
	
	
></p>
<p>**æ³¨ï¼š**å½“æœªå¼€å¯æ— å»¶è¿Ÿçš„åå‘é”æ—¶ï¼Œä¸€å¼€å§‹çš„é”å¯¹è±¡ä¸ºnon-biasable; è°ƒç”¨synchronizedä¼šç›´æ¥å˜æˆthin Lock</p>
<ul>
<li>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordçš„å€¼ä¸º0x01å³æœ€å3ä½ä¸º001ï¼Œ<strong>è¿™æ—¶ä»–çš„hashcodeï¼Œageéƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼</strong></li>
<li>**Java17ç§»é™¤åŸå› ï¼š**åå‘é”ç»™ JVM å¢åŠ äº†å·¨å¤§çš„å¤æ‚æ€§ï¼Œåªæœ‰å°‘æ•°éå¸¸æœ‰ç»éªŒçš„ç¨‹åºå‘˜æ‰èƒ½ç†è§£æ•´ä¸ªè¿‡ç¨‹ï¼Œç»´æŠ¤æˆæœ¬å¾ˆé«˜ï¼Œå¤§å¤§é˜»ç¢äº†å¼€å‘æ–°ç‰¹æ€§çš„è¿›ç¨‹</li>
</ul>
<p><strong>å½“æˆ‘ä»¬çš„é¡¹ç›®æœ¬èº«æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹é«˜ç«äº‰çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å†ä½¿ç”¨åå‘é”ä¼šå¯¼è‡´æ€§èƒ½é™ä½ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿è¦ç¦ç”¨åå‘é”</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-XX:-UserBiasedLocking
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åå‘é”æ’¤é”€">åå‘é”æ’¤é”€</h4>
<p><strong>åå‘é”çš„æ’¤é”€ï¼Œè¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹æ‰èƒ½è¿›è¡Œï¼Œåˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹Bä¹Ÿåœæ­¢äº†</strong></p>
<ul>
<li>æŸ¥çœ‹çº¿ç¨‹Bæ˜¯å¦è¿˜å­˜æ´»ä¸”è¿˜åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç å—çš„ä»£ç </li>
</ul>
<blockquote>
<ul>
<li><strong>çº¿ç¨‹Bå­˜æ´»</strong>ï¼Œåˆ™å°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œå¹¶ä¸”ç»§ç»­æŒæœ‰é”å‘ä¸‹æ‰§è¡Œ</li>
<li><strong>çº¿ç¨‹Bä¸å­˜æ´»</strong>ï¼Œåˆ™æŸ¥çœ‹åå‘é”æ˜¯å¦å…è®¸é‡åå‘</li>
</ul>
<blockquote>
<ul>
<li>å…è®¸é‡åå‘ï¼Œåˆ™è®¾ç½®é”ä¸ºåŒ¿åçŠ¶æ€ï¼Œçº¿ç¨‹Aè¿›è¡ŒCASè·å–åå‘é”</li>
<li>ä¸å…è®¸é‡åå‘ï¼Œåˆ™è®¾ç½®é”ä¸ºæ— é”çŠ¶æ€ï¼Œè¿›è¡Œé”å‡çº§ï¼ŒCASç«äº‰é”</li>
</ul>
</blockquote>
</blockquote>
<h5 id="1æ’¤é”€-è°ƒç”¨hashcode">1ï¼Œæ’¤é”€-è°ƒç”¨hashcode</h5>
<blockquote>
<p>å½“å¯¹å¯¹è±¡ä½¿ç”¨HashCodeæ—¶ï¼Œä¼šç¦ç”¨åå‘é”ï¼Œå› ä¸ºhashcodeè¦†ç›–äº†çº¿ç¨‹çš„åœ°å€</p>
<p><strong>ä¸ºä»€ä¹ˆè½»é‡çº§é”å’Œé‡é‡çº§é”è°ƒç”¨HashCodeä¸ä¼šæ’¤é”€é”çŠ¶æ€å‘¢?</strong></p>
<ul>
<li>å› ä¸ºè½»é‡çº§é”çš„markwordæ˜¯ä¿å­˜åœ¨åŠ é”çº¿ç¨‹ä¸Šçš„</li>
<li>è€Œé‡é‡çº§é”çš„markwordæ˜¯ä¿å­˜è‡³monitorä¸­çš„</li>
</ul>
</blockquote>
<h5 id="2æ’¤é”€-å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡">2ï¼Œæ’¤é”€-å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡</h5>
<p>å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</p>
<h5 id="3æ’¤é”€-è°ƒç”¨waitnotify">3ï¼Œæ’¤é”€-è°ƒç”¨wait/notify</h5>
<h4 id="æ‰¹é‡é‡åå‘">æ‰¹é‡é‡åå‘</h4>
<p>Thread-1å¯¹ObjåŠ ä¸Šåå‘é”ï¼Œå½“Thread-2è®¿é—®Objæ—¶ï¼Œä¼šæ’¤é”€åå‘é”ï¼Œè½¬åŒ–ä¸ºè½»é‡çº§é”ï¼Œä½†æ˜¯å½“ä¹‹åObjç”±Thread-2å¤šæ¬¡è®¿é—®æ—¶(é˜ˆå€¼20æ¬¡)ï¼ŒJVMå°±ä¼šè€ƒè™‘æ˜¯å¦åŠ é”™åå‘é”ï¼Œäºæ˜¯å¯¹Objçš„åå‘æŒ‡å‘Thread-2ã€‚</p>
<p><strong>æ‰¹é‡é‡åå‘æ˜¯æŒ‡ï¼Œå½“æœ‰30ä¸ªå¯¹è±¡è¢«Thread-1åŠ é”ï¼Œé‚£å½“Thread-2è®¿é—®è¿™30ä¸ªå¯¹è±¡æ—¶ï¼Œå‰19ä¸ªå¯¹è±¡ä¼šè¢«å‡çº§ä¸ºè½»é‡çº§é”ï¼Œå11ä¸ªå¯¹è±¡(è¯¥ç±»ç›´æ¥é‡åå‘)ç¼–ç¨‹åå‘Thread-2çš„åå‘é”</strong></p>
<h4 id="æ‰¹é‡æ’¤é”€">æ‰¹é‡æ’¤é”€</h4>
<p>å½“æ’¤é”€åå‘é”çš„é˜ˆå€¼è¶…è¿‡40æ¬¡åï¼Œjvmä¼šæ€€ç–‘äººç”Ÿï¼Œå†³å®šè‡ªå·±ä¸åº”è¯¥åå‘è°ï¼Œäºæ˜¯å°±ä¸åå‘ï¼ŒæŠŠæ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½è®¾ä¸ºä¸å¯åå‘ï¼Œ<strong>æ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘</strong></p>
<h3 id="412-é”ç²—åŒ–">4.12 é”ç²—åŒ–</h3>
<blockquote>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯å¤šçº¿ç¨‹é—´çš„æœ‰æ•ˆå¹¶å‘ï¼Œä¼šè¦æ±‚æ¯ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½†æ˜¯å¤§æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç¨‹åºå¯¹åŒä¸€ä¸ªé”ä¸é—´æ–­ã€é«˜é¢‘åœ°è¯·æ±‚ã€åŒæ­¥ä¸é‡Šæ”¾ï¼Œä¼šæ¶ˆè€—æ‰ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œå› ä¸ºé”çš„è®²æ±‚ã€åŒæ­¥ä¸é‡Šæ”¾æœ¬èº«ä¼šå¸¦æ¥æ€§èƒ½æŸè€—ï¼Œè¿™æ ·é«˜é¢‘çš„é”è¯·æ±‚å°±åè€Œä¸åˆ©äºç³»ç»Ÿæ€§èƒ½çš„ä¼˜åŒ–äº†ï¼Œè™½ç„¶å•æ¬¡åŒæ­¥æ“ä½œçš„æ—¶é—´å¯èƒ½å¾ˆçŸ­ã€‚<strong>é”ç²—åŒ–å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬ä»»ä½•äº‹æƒ…éƒ½æœ‰ä¸ªåº¦ï¼Œæœ‰äº›æƒ…å†µä¸‹æˆ‘ä»¬åè€Œå¸Œæœ›æŠŠå¾ˆå¤šæ¬¡é”çš„è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚ï¼Œä»¥é™ä½çŸ­æ—¶é—´å†…å¤§é‡é”è¯·æ±‚ã€åŒæ­¥ã€é‡Šæ”¾å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingMethod</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do some thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿™æ˜¯è¿˜æœ‰ä¸€äº›ä»£ç ï¼Œåšå…¶å®ƒä¸éœ€è¦åŒæ­¥çš„å·¥ä½œï¼Œä½†èƒ½å¾ˆå¿«æ‰§è¡Œå®Œæ¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do other thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä»£ç æ˜¯æœ‰ä¸¤å—éœ€è¦åŒæ­¥æ“ä½œçš„ï¼Œä½†åœ¨è¿™ä¸¤å—éœ€è¦åŒæ­¥æ“ä½œçš„ä»£ç ä¹‹é—´ï¼Œéœ€è¦åšä¸€äº›å…¶å®ƒçš„å·¥ä½œï¼Œè€Œè¿™äº›å·¥ä½œåªä¼šèŠ±è´¹å¾ˆå°‘çš„æ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™äº›å·¥ä½œä»£ç æ”¾å…¥é”å†…ï¼Œå°†ä¸¤ä¸ªåŒæ­¥ä»£ç å—åˆå¹¶æˆä¸€ä¸ªï¼Œä»¥é™ä½å¤šæ¬¡é”è¯·æ±‚ã€åŒæ­¥ã€é‡Šæ”¾å¸¦æ¥çš„ç³»ç»Ÿæ€§èƒ½æ¶ˆè€—ï¼Œåˆå¹¶åçš„ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingMethod</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do some thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ä¸€äº›å¾ˆå¿«å°±èƒ½æ‰§è¡Œå®Œçš„ä»£ç </span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do other thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦ä¸€ç§éœ€è¦é”ç²—åŒ–çš„æç«¯çš„æƒ…å†µæ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä»£ç æ¯æ¬¡å¾ªç¯éƒ½ä¼šè¿›è¡Œé”çš„è¯·æ±‚ã€åŒæ­¥ä¸é‡Šæ”¾ï¼Œçœ‹èµ·æ¥è²Œä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¸”åœ¨jdkå†…éƒ¨ä¼šå¯¹è¿™ç±»ä»£ç é”çš„è¯·æ±‚åšä¸€äº›ä¼˜åŒ–ï¼Œä½†æ˜¯è¿˜ä¸å¦‚æŠŠåŠ é”ä»£ç å†™åœ¨å¾ªç¯ä½“çš„å¤–é¢ï¼Œè¿™æ ·ä¸€æ¬¡é”çš„è¯·æ±‚å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„è¦æ±‚ï¼Œé™¤éæœ‰ç‰¹æ®Šçš„éœ€è¦ï¼šå¾ªç¯éœ€è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œä½†å…¶å®ƒçº¿ç¨‹ç­‰ä¸èµ·ï¼Œè¦ç»™å®ƒä»¬æ‰§è¡Œçš„æœºä¼šã€‚</p>
<p>é”ç²—åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="413-é”æ¶ˆé™¤">4.13 é”æ¶ˆé™¤</h3>
<p>å½“ä½ çš„é”å¯¹è±¡å¤„äºä¸€ä¸ªæ— æ³•è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°çš„çŠ¶æ€æ—¶ï¼Œå°±ä¼šé»˜è®¤è¯¥åŠ é”æ— æ„ä¹‰ï¼Œäºæ˜¯åœ¨JITå³æ—¶ç¼–è¯‘æ—¶ä¾¿ä¼šä½¿ç”¨é”æ¶ˆé™¤ï¼Œå³é»˜è®¤ä½ æ²¡æœ‰åŠ é”ï¼Œä»¥æå‡æ€§èƒ½æ•ˆç‡ï¼ˆä½†æ˜¯æˆ‘æ²¡æµ‹è¯•å‡ºæ¥ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">num</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;test3 time {}ms&#34;</span><span class="o">,</span><span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test4</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">num</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">obj</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;test4 time {}ms&#34;</span><span class="o">,</span><span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å¦‚æœæ²¡æœ‰ä½¿ç”¨é”æ¶ˆé™¤æ€§èƒ½å·®åˆ«ååˆ†ä¹‹å¤§</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">23:10:33.602 [main] DEBUG JUC.c_monitor.LockClear - test3 time 1ms
</span></span><span class="line"><span class="cl">23:10:33.625 [main] DEBUG JUC.c_monitor.LockClear - test4 time 17ms
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="414-æ´»è·ƒæ€§">4.14 æ´»è·ƒæ€§</h3>
<h4 id="æ­»é”">æ­»é”</h4>
<p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•ç»§ç»­è¿è¡Œã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">deadLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">static</span> <span class="n">Object</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="kd">static</span> <span class="n">Object</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">a</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">a</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å“²å­¦å®¶é—®é¢˜">å“²å­¦å®¶é—®é¢˜</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220328230132533.png"
	
	
	
	loading="lazy"
	
		alt="image-20220328230132533"
	
	
></p>
<h5 id="å“²å­¦å®¶é—®é¢˜è§£å†³">å“²å­¦å®¶é—®é¢˜è§£å†³</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.e_ReentrantLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">JUC.util.Sleeper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">famliyEating</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;çˆ¸çˆ¸&#34;</span><span class="o">,</span><span class="n">c1</span><span class="o">,</span><span class="n">c2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;å¦ˆå¦ˆ&#34;</span><span class="o">,</span><span class="n">c2</span><span class="o">,</span><span class="n">c3</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;å„¿å­&#34;</span><span class="o">,</span><span class="n">c3</span><span class="o">,</span><span class="n">c4</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;çˆ·çˆ·&#34;</span><span class="o">,</span><span class="n">c4</span><span class="o">,</span><span class="n">c5</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;å¥¶å¥¶&#34;</span><span class="o">,</span><span class="n">c5</span><span class="o">,</span><span class="n">c1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Famliy</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Chopstick</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Chopstick</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Famliy</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Chopstick</span> <span class="n">left</span><span class="o">,</span> <span class="n">Chopstick</span> <span class="n">right</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Chopstick</span> <span class="nf">getLeft</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Chopstick</span> <span class="nf">getRight</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eat</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;[{}]æ­£åœ¨åƒé¥­&#34;</span><span class="o">,</span><span class="n">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Sleeper.sleep(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>             <span class="k">if</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">tryLock</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                 <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">//log.debug(&#34;[{}] æ‹¿åˆ°å·¦æ‰‹ç­·å­[{}]&#34;,getName(),getLeft().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="k">if</span><span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">tryLock</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                         <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                             <span class="c1">//log.debug(&#34;[{}] æ‹¿åˆ°å³æ‰‹ç­·å­[{}]&#34;,getName(),getRight().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                             <span class="n">eat</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                         <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                             <span class="c1">//log.debug(&#34;[{}] æ”¾ä¸‹å³æ‰‹ç­·å­[{}]&#34;,getName(),getRight().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                             <span class="n">right</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                         <span class="o">}</span>
</span></span><span class="line"><span class="cl">                     <span class="o">}</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">//log.debug(&#34;[{}] æ”¾ä¸‹å·¦æ‰‹ç­·å­[{}]&#34;,getName(),getLeft().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="n">left</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Chopstick</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Chopstick</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ´»é”">æ´»é”</h4>
<p>æ´»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºèµ„æºå…±äº«ï¼Œä¸æ–­æ›´æ”¹å…¶ä»–çº¿ç¨‹çš„ç»“æŸæ¡ä»¶ï¼Œè™½ç„¶çŠ¶æ€å¯ä»¥æ”¹å˜ï¼Œå´æ²¡æœ‰å®è´¨çš„è¿›å±•ï¼Œå¯¼è‡´çº¿ç¨‹ä¸€ç›´è¿è¡Œä¸‹å»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">aliveLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;i:{}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">20</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;i:{}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é¥¥é¥¿">é¥¥é¥¿</h4>
<p>ç”±äºçº¿ç¨‹ä¼˜å…ˆçº§åˆ†é…ä¸åˆç†ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æ— é™åœ°ç­‰å¾…å¦å¤–ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç›¸äº’ä¼ é€’ä½¿ç”¨å¹¶ä¸”ç”¨ä¸ä¼šé‡Šæ”¾çš„èµ„æºã€‚</p>
<h3 id="415-ä»æºç å»çœ‹synchronized">4.15 ä»æºç å»çœ‹synchronized</h3>
<h4 id="monitorç»“æ„">monitorç»“æ„</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ObjectMonitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">ObjectMonitor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_header</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//markOopå¯¹è±¡å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_count</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="n">_waiters</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">//ç­‰å¾…çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">//é‡å…¥æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_object</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">_owner</span>        <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//è·å¾—ObjectMonitorå¯¹è±¡çš„çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_WaitSet</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°waitSet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_WaitSetLock</span>  <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_succ</span>         <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cxq</span>          <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FreeNext</span>      <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_EntryList</span>    <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="c1">//å¤„äºç­‰å¾…é”BLOCKEDçŠ¶æ€çš„çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_SpinFreq</span>     <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>   
</span></span><span class="line"><span class="cl">    <span class="n">_SpinClock</span>    <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OwnerIsThread</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_previous_owner_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//ç›‘è§†å™¨å‰ä¸€ä¸ªæ‹¥æœ‰çº¿ç¨‹çš„ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>synchronizedä¸Šé”æ—¶åˆ†åˆ«è°ƒç”¨äº† monitorenterï¼Œmonitorexitä¸¤ä¸ªå‡½æ•°ï¼Œç”±æ­¤æˆ‘ä»¬é€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°æ¥æ¢ç´¢synchronized</strong></p>
<h4 id="monitorenterinterpeterruntimecpp">monitorenter(interpeterRuntime.cpp)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IRT_ENTRY_NO_ASYNC</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">InterpreterRuntime</span><span class="o">::</span><span class="n">monitorenter</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">BasicObjectLock</span><span class="o">*</span> <span class="n">elem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">PrintBiasedLockingStatistics</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Atomic</span><span class="o">::</span><span class="n">inc</span><span class="p">(</span><span class="n">BiasedLocking</span><span class="o">::</span><span class="n">slow_path_entry_count_addr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span> <span class="nf">h_obj</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">UseBiasedLocking</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Retry fast entry if bias is revoked to avoid unnecessary inflation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">);</span><span class="c1">//åå‘é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">slow_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="n">CHECK</span><span class="p">);</span><span class="c1">//è½»é‡çº§é” 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">heap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_in_reserved_or_null</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;must be NULL or an object&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">IRT_END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å½“å¼€å¯åå‘é”æ—¶ï¼Œè¿›å…¥fast_enterï¼Œåå‘é”åŠ é”æµç¨‹</p>
<p>å½“æœªå¼€å¯åå‘é”ï¼Œè¿›å…¥slow_enterï¼Œè½»é‡çº§é”åŠ é”æµç¨‹</p>
</blockquote>
<h4 id="åå‘é”ç¯èŠ‚">åå‘é”ç¯èŠ‚</h4>
<h5 id="fast_enter">fast_enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_enter</span><span class="p">(</span><span class="n">Handle</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">attempt_rebias</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">UseBiasedLocking</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//åˆ¤æ–­æ˜¯å¦å¼€å¯äº†åå‘é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//å¦‚æœä¸å¤„äºå…¨å±€å®‰å…¨ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//é€šè¿‡`revoke_and_rebias`è¿™ä¸ªå‡½æ•°å°è¯•è·å–åå‘é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">Condition</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_and_rebias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attempt_rebias</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">BIAS_REVOKED_AND_REBIASED</span><span class="p">)</span> <span class="p">{</span><span class="c1">//å¦‚æœæ˜¯æ’¤é”€ä¸é‡åå‘ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//å¦‚æœåœ¨å®‰å…¨ç‚¹ï¼Œæ’¤é”€åå‘é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">attempt_rebias</span><span class="p">,</span> <span class="s">&#34;can not rebias toward VM thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_at_safepoint</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;biases should be revoked by now&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">slow_enter</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ï¼Œåˆ¤æ–­æ˜¯å¦å¼€å¯åå‘é”</p>
<p>2ï¼Œåˆ¤æ–­è¯¥ç‚¹æ˜¯å¦ä¸ºå…¨å±€å®‰å…¨ç‚¹</p>
<p>3ï¼Œå¦ï¼Œè¿›è¡Œæ’¤é”€å¹¶é‡æ–°åå‘ï¼ŒæˆåŠŸåˆ™è¿”å›ï¼Œä¸æ˜¯åˆ™è½»é‡çº§é”è·å–</p>
<p>4ï¼Œæ˜¯ï¼Œåˆ™æ’¤é”€åå‘é”ï¼Œå¹¶ä¸”è¿›è¡Œè½»é‡çº§é”è·å–</p>
</blockquote>
<h5 id="revoke_at_safepoint">revoke_at_safepoint</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_at_safepoint</span><span class="p">(</span><span class="n">Handle</span> <span class="n">h_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;must only be called while at safepoint&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">oop</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">h_obj</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ›´æ–°æ’¤é”€åå‘é”è®¡æ•°ï¼Œå¹¶è¿”å›åå‘é”æ’¤é”€æ¬¡æ•°å’Œåå‘æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">HeuristicsResult</span> <span class="n">heuristics</span> <span class="o">=</span> <span class="n">update_heuristics</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_SINGLE_REVOKE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//å¯åå‘ä¸”æœªè¾¾åˆ°æ‰¹é‡å¤„ç†çš„é˜ˆå€¼(ä¸‹é¢ä¼šå•ç‹¬è§£é‡Š)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">revoke_bias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">//æ’¤é”€åå‘é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REBIAS</span><span class="p">)</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REVOKE</span><span class="p">))</span> <span class="p">{</span><span class="c1">//å¦‚æœæ˜¯å¤šæ¬¡æ’¤é”€æˆ–è€…å¤šæ¬¡åå‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//æ‰¹é‡æ’¤é”€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bulk_revoke_or_rebias_at_safepoint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REBIAS</span><span class="p">),</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">clean_up_cached_monitor_info</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>JVMå†…éƒ¨ä¸ºæ¯ä¸ªç±»ç»´æŠ¤äº†ä¸€ä¸ªåå‘é”revokeè®¡æ•°å™¨ï¼Œå¯¹åå‘é”æ’¤é”€è¿›è¡Œè®¡æ•°ï¼Œå½“è¿™ä¸ªå€¼è¾¾åˆ°æŒ‡å®šé˜ˆå€¼æ—¶ï¼ŒJVMä¼šè®¤ä¸ºè¿™ä¸ªç±»çš„åå‘é”æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°åå‘(rebias),å¯¹æ‰€æœ‰å±äºè¿™ä¸ªç±»çš„å¯¹è±¡è¿›è¡Œé‡åå‘çš„æ“ä½œæˆä¸º æ‰¹é‡é‡åå‘(bulk rebias)ã€‚åœ¨åšbulk rebiasæ—¶ï¼Œä¼šå¯¹è¿™ä¸ªç±»çš„epochçš„å€¼åšé€’å¢ï¼Œè¿™ä¸ªepochä¼šå­˜å‚¨åœ¨å¯¹è±¡å¤´ä¸­çš„epochå­—æ®µã€‚åœ¨åˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦è·å¾—åå‘é”çš„æ¡ä»¶æ˜¯:markwordçš„ biased_lock:1ã€lock:01ã€threadidå’Œå½“å‰çº¿ç¨‹idç›¸ç­‰ã€epochå­—æ®µå’Œæ‰€å±ç±»çš„epochå€¼ç›¸åŒï¼Œå¦‚æœepochçš„å€¼ä¸ä¸€æ ·ï¼Œè¦ä¹ˆå°±æ˜¯æ’¤é”€åå‘é”ã€è¦ä¹ˆå°±æ˜¯rebiasï¼› å¦‚æœè¿™ä¸ªç±»çš„revokeè®¡æ•°å™¨çš„å€¼ç»§ç»­å¢åŠ åˆ°ä¸€ä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆjvmä¼šè®¤ä¸ºè¿™ä¸ªç±»ä¸é€‚åˆåå‘é”ï¼Œå°±éœ€è¦è¿›è¡Œbulk revokeæ“ä½œ</p>
</blockquote>
<h4 id="è½»é‡çº§é”ç¯èŠ‚">è½»é‡çº§é”ç¯èŠ‚</h4>
<h5 id="slow_enter">slow_enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">slow_enter</span><span class="p">(</span><span class="n">Handle</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;should not see bias pattern here&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//å¦‚æœå½“å‰å¯¹è±¡ä¸ºæ— é”çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="n">mark</span><span class="p">);</span> <span class="c1">//å¤åˆ¶ä¸€ä»½lock record åŒ…å« markword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">obj</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">((</span><span class="n">markOop</span><span class="p">)</span> <span class="n">lock</span><span class="p">,</span> <span class="n">mark</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// è¿›è¡ŒCASå¹¶å°†lock recordæ”¾å…¥æ ˆå¸§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">slow_enter</span><span class="p">:</span> <span class="n">release</span> <span class="n">stacklock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">             <span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">//å¦‚æœå½“å‰å¯¹è±¡å·²ç»æœ‰é”ï¼Œä¸”é”å¯¹è±¡ä¸ºè‡ªå·±ï¼Œåˆ™è¿›è¡Œé”é‡å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">(),</span> <span class="s">&#34;must not re-lock the same lock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BasicLock</span><span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">(),</span> <span class="s">&#34;don&#39;t relock with same BasicLock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">//å¤åˆ¶ä¸€ä»½ null çš„ lock record æ”¾å…¥æ ˆå¸§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">unused_mark</span><span class="p">());</span> <span class="c1">//å°†mark wordåä¸‰ä½è®¾ç½®ä¸º GC å›æ”¶æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è¿›å…¥é”è†¨èƒ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">obj</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">inflate_cause_monitor_enter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enter</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>è½»é‡çº§é”çš„é‡Šæ”¾è¿‡ç¨‹</em></p>
<p><em>monitorexit-&gt;slow_exit-&gt;fast_exitï¼Œè¿™é‡Œè·³è¿‡å‰ä¸¤ä¸ªæ­¥éª¤ç›´æ¥å±•ç¤ºfast_exit</em></p>
<h5 id="fast_exit">fast_exit</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_exit</span><span class="p">(</span><span class="n">oop</span> <span class="n">object</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;should not see bias pattern here&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">dhw</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">displaced_header</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœä¸ºé‡å…¥é”åˆ™ä»€ä¹ˆéƒ½ä¸åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dhw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef PRODUCT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">!=</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">             <span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">()),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_monitor</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(((</span><span class="n">oop</span><span class="p">)(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()))</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">mark</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">is_entered</span><span class="p">(</span><span class="n">THREAD</span><span class="p">),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//å¦‚æœmarkword == displaced mark wordå³è½»é‡çº§é”ï¼Œcasæ›¿æ¢å¯¹è±¡å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="p">(</span><span class="n">markOop</span><span class="p">)</span> <span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">dhw</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">dhw</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span> <span class="o">==</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">fast_exit</span><span class="p">:</span> <span class="n">release</span> <span class="n">stack</span><span class="o">-</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">inflate_cause_vm_internal</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é‡é‡çº§é”ç¯èŠ‚">é‡é‡çº§é”ç¯èŠ‚</h4>
<h5 id="inflate">inflate</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">ObjectMonitor</span><span class="o">*</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">Thread</span> <span class="o">*</span> <span class="n">Self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">oop</span> <span class="n">object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="k">const</span> <span class="n">InflateCause</span> <span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">verify_in_progress</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EventJavaMonitorInflate</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The mark can be in one of the following states:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Inflated     - just return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Stack-locked - coerce it to inflated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  INFLATING    - busy wait for conversion to complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Neutral      - aggressively inflate the object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  BIASED       - Illegal.  We should never see this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœæ”¹å¯¹è±¡å·²ç»ä¸ºé‡é‡çº§é”ï¼Œåˆ™ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_monitor</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">inf</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()</span> <span class="o">==</span> <span class="n">object</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">verify_objmon_isinpool</span><span class="p">(</span><span class="n">inf</span><span class="p">),</span> <span class="s">&#34;monitor is invalid&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">inf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœæ”¹å¯¹è±¡æ­£åœ¨è†¨èƒ€ï¼Œåˆ™è‡ªæ—‹ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">spin</span> <span class="k">while</span> <span class="n">INFLATING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¯¥æ–¹æ³•ä¸­è¿›è¡Œè‡ªæ—‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ReadStableMark</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœå·²ç»æ‹¥æœ‰é”ï¼Œå³è½»é‡çº§é”çŠ¶æ€ï¼Œåˆ™åˆå§‹åŒ–monitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åˆ›å»ºmonitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">omAlloc</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è®¾ç½®é‡å…¥æ¬¡æ•°ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_SpinDuration</span> <span class="o">=</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">Knob_SpinLimit</span><span class="p">;</span>   <span class="c1">// Consider: maintain by type/class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†markå¤´è®¾ç½®ä¸ºæ­£åœ¨è†¨èƒ€ï¼ŒINFLAGTING(0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">markOop</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">(),</span> <span class="n">mark</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">omRelease</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>       <span class="c1">// Interference -- just retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æ ˆä¸­çš„displaced_mark_word
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">markOop</span> <span class="n">dmw</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">displaced_mark_helper</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">dmw</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è®¾ç½®monitorå­—æ®µï¼ŒæŠŠå¯¹è±¡markwordä¿¡æ¯ä¿å­˜åœ¨ monitorä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_header</span><span class="p">(</span><span class="n">dmw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æŠŠmarkä¸­çš„çº¿ç¨‹lock recordè®¾ç½®ä¸ºownerï¼Œæ‰€ä»¥è¿™é‡ŒowneræŒ‡å‘çš„æ˜¯çº¿ç¨‹ä¸­çš„lock recordæˆ–è€… çº¿ç¨‹æœ¬èº«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è®¾ç½® monitorå¯¹è±¡ä¸ºåŠ é”å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">guarantee</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†é”å¯¹è±¡è®¾ç½®ä¸ºé‡é‡çº§é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">object</span><span class="o">-&gt;</span><span class="n">release_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">Inflations</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">overwrite</span> <span class="n">stacklock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">log_is_enabled</span><span class="p">(</span><span class="n">Debug</span><span class="p">,</span> <span class="n">monitorinflation</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">is_instance</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">ResourceMark</span> <span class="n">rm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">log_debug</span><span class="p">(</span><span class="n">monitorinflation</span><span class="p">)(</span><span class="s">&#34;Inflating object &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , mark &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , type %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="p">),</span> <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">object</span><span class="o">-&gt;</span><span class="n">klass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">external_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">should_commit</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_monitor_inflate_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">object</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//æ— çŠ¶æ€é”ï¼Œä¹Ÿæ˜¯ç›´æ¥åˆå§‹åŒ–é”ï¼Œè¿›è¡Œé”è†¨èƒ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">omAlloc</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_header</span><span class="p">(</span><span class="n">mark</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_SpinDuration</span> <span class="o">=</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">Knob_SpinLimit</span><span class="p">;</span>       <span class="c1">// consider: keep metastats by type/class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å°†é”æ”¹ä¸ºé‡é‡çº§é”ï¼Œå¦‚æœå¤±è´¥è¯´æ˜æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å†inflateï¼Œåˆ™é‡Šæ”¾monitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">mark</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">omRelease</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">Inflations</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">overwrite</span> <span class="n">neutral</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">log_is_enabled</span><span class="p">(</span><span class="n">Debug</span><span class="p">,</span> <span class="n">monitorinflation</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">is_instance</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResourceMark</span> <span class="n">rm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug</span><span class="p">(</span><span class="n">monitorinflation</span><span class="p">)(</span><span class="s">&#34;Inflating object &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , mark &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , type %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="p">),</span> <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">object</span><span class="o">-&gt;</span><span class="n">klass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">external_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">should_commit</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">post_monitor_inflate_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">object</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>inflate</code>ä¸­æ˜¯ä¸€ä¸ªforå¾ªç¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¤„ç†å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨inflateçš„æƒ…å†µã€‚ç„¶åä¼šæ ¹æ®é”å¯¹è±¡çš„çŠ¶æ€è¿›è¡Œä¸åŒçš„å¤„ç†ï¼š</p>
<blockquote>
<p>1.å·²ç»æ˜¯é‡é‡çº§çŠ¶æ€ï¼Œè¯´æ˜è†¨èƒ€å·²ç»å®Œæˆï¼Œç›´æ¥è¿”å›</p>
<p>2.å¦‚æœæ˜¯è½»é‡çº§é”åˆ™éœ€è¦è¿›è¡Œè†¨èƒ€æ“ä½œ</p>
<p>3.å¦‚æœæ˜¯è†¨èƒ€ä¸­çŠ¶æ€ï¼Œåˆ™è¿›è¡Œå¿™ç­‰å¾…</p>
<p>4.å¦‚æœæ˜¯æ— é”çŠ¶æ€åˆ™éœ€è¦è¿›è¡Œè†¨èƒ€æ“ä½œ5 wait notify</p>
</blockquote>
<p><strong>è½»é‡çº§é”è†¨èƒ€</strong></p>
<blockquote>
<p>1ï¼Œè°ƒç”¨omAllocåˆ†é…ä¸€ä¸ªmonitorå¯¹è±¡åœ¨<code>omAlloc</code>æ–¹æ³•ä¸­ä¼šå…ˆä»çº¿ç¨‹ç§æœ‰çš„<code>monitor</code>é›†åˆ<code>omFreeList</code>ä¸­åˆ†é…å¯¹è±¡ï¼Œå¦‚æœ<code>omFreeList</code>ä¸­å·²ç»æ²¡æœ‰<code>monitor</code>å¯¹è±¡ï¼Œåˆ™ä»JVMå…¨å±€çš„<code>gFreeList</code>ä¸­åˆ†é…ä¸€æ‰¹<code>monitor</code>åˆ°<code>omFreeList</code>ä¸­ã€‚</p>
<p>2ï¼Œåˆå§‹åŒ–monitorå¯¹è±¡</p>
<p>3ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸ºINFLATING</p>
<p>4ï¼Œheaderå­—æ®µä¸ºdisplaced mark wordï¼Œownerå­—æ®µä¸ºlock recordï¼Œobjå­—æ®µä¸ºé”å¯¹è±¡</p>
<p>5ï¼Œè®¾ç½®ä¸ºé‡é‡çº§é”ï¼ŒæŒ‡å‘ç¬¬ä¸€æ­¥åˆ†é…çš„monitorå¯¹è±¡</p>
</blockquote>
<p><strong>æ— é”çŠ¶æ€è†¨èƒ€</strong></p>
<blockquote>
<p>1.è°ƒç”¨<code>omAlloc</code>åˆ†é…ä¸€ä¸ª<code>ObjectMonitor</code>å¯¹è±¡(ä»¥ä¸‹ç®€ç§°monitor)</p>
<p>2.åˆå§‹åŒ–<code>monitor</code>å¯¹è±¡</p>
<p>3.è®¾ç½®<code>monitor</code>çš„headerå­—æ®µä¸º<code> mark word</code>ï¼Œownerå­—æ®µä¸º<code>null</code>ï¼Œobjå­—æ®µä¸ºé”å¯¹è±¡</p>
<p>4.è®¾ç½®é”å¯¹è±¡å¤´çš„<code>mark word</code>ä¸ºé‡é‡çº§é”çŠ¶æ€ï¼ŒæŒ‡å‘ç¬¬ä¸€æ­¥åˆ†é…çš„<code>monitor</code>å¯¹è±¡</p>
</blockquote>
<p><strong>INFLATINGå­˜åœ¨çš„åŸå› </strong></p>
<blockquote>
<p>1ï¼Œå»¶è¿Ÿæ‹¥æœ‰é”çš„çº¿ç¨‹Aï¼Œé‡Šæ”¾é”çš„æ—¶é—´ï¼Œå› ä¸ºå°†é”çŠ¶æ€è®¾ç½®ä¸ºINFLATINGæ—¶ï¼Œçº¿ç¨‹Aä¼šè§£é”å¤±è´¥ï¼Œæ­¤æ—¶å˜åŒ–è†¨èƒ€è¿›å…¥INFLATINGè‡ªæ—‹</p>
<p>2ï¼Œé˜²æ­¢hashcodeé—ªçƒï¼ˆä¸å¤ªæ˜ç™½ï¼‰</p>
</blockquote>
<p>å½“é”è†¨èƒ€å®Œåï¼Œè¿›å…¥Enterç¯èŠ‚</p>
<h5 id="enter">Enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">enter</span><span class="p">(</span><span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœå½“å‰é”æ²¡æœ‰äººè·å–ï¼Œåˆ™å°è¯•è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//é”é‡å…¥ï¼Œæ¬¡æ•°+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_recursions</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœè¢«åŠ é”ä¹‹å‰ä¸ºè½»é‡çº§é”ï¼Œä¸”ä¸ºè½»é‡çº§é”ç¬¬ä¸€æ¬¡é”è†¨èƒ€è¿›å…¥enteræ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span> <span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">cur</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;internal state error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//é”é‡å…¥+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_owner</span> <span class="o">=</span> <span class="n">Self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">=</span> <span class="n">intptr_t</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//å†è°ƒç”¨ç³»ç»ŸåŒæ­¥æ“ä½œå‰ï¼Œå…ˆå°è¯•è‡ªæ—‹ï¼Œè‡ªæ—‹æˆåŠŸè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Knob_SpinEarly</span> <span class="o">&amp;&amp;</span> <span class="n">TrySpin</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(((</span><span class="n">oop</span><span class="p">)(</span><span class="n">object</span><span class="p">()))</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span> <span class="n">jt</span> <span class="o">=</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span> <span class="n">Self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">jt</span><span class="o">-&gt;</span><span class="n">thread_state</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_thread_blocked</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Atomic</span><span class="o">::</span><span class="n">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EventJavaMonitorEnter</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨ç³»ç»ŸåŒæ­¥æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">jt</span><span class="o">-&gt;</span><span class="n">set_suspend_equivalent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿›å…¥EnterIç¯èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">EnterI</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ExitSuspendEquivalent</span><span class="p">(</span><span class="n">jt</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">exit</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">jt</span><span class="o">-&gt;</span><span class="n">java_suspend_self</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Self</span><span class="o">-&gt;</span><span class="n">set_current_pending_monitor</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="enteri">EnterI</h5>
<p><strong>EnterIçš„åŸç†å’ŒReentrantLockçš„åŸç†åŠå…¶ç›¸ä¼¼</strong></p>
<blockquote>
<p>ä¸€ä¸ª<code>ObjectMonitor</code>å¯¹è±¡åŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ªå…³é”®å­—æ®µï¼š<strong>cxq</strong>ï¼ˆä¸‹å›¾ä¸­çš„ContentionListï¼‰ï¼Œ<strong>EntryList</strong> ï¼Œ<strong>WaitSet</strong>ï¼Œ<strong>owner</strong>ã€‚</p>
<p>å…¶ä¸­cxq ï¼ŒEntryList ï¼ŒWaitSetéƒ½æ˜¯ç”±ObjectWaiterçš„é“¾è¡¨ç»“æ„ï¼ŒowneræŒ‡å‘æŒæœ‰é”çš„çº¿ç¨‹ã€‚</p>
<p>**å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œ**ä¼šä»cxqæˆ–EntryListä¸­æŒ‘é€‰ä¸€ä¸ªçº¿ç¨‹å”¤é†’ï¼Œè¢«é€‰ä¸­çš„çº¿ç¨‹å«åš<code>Heir presumptive</code>å³å‡å®šç»§æ‰¿äºº_succï¼Œå°±æ˜¯å›¾ä¸­çš„<code>Ready Thread</code>ï¼Œå‡å®šç»§æ‰¿äººè¢«å”¤é†’åä¼šå°è¯•è·å¾—é”ï¼Œä½†<code>synchronized</code>æ˜¯éå…¬å¹³çš„ï¼Œæ‰€ä»¥å‡å®šç»§æ‰¿äººä¸ä¸€å®šèƒ½è·å¾—é”ï¼ˆè¿™ä¹Ÿæ˜¯å®ƒå«&quot;å‡å®š&quot;ç»§æ‰¿äººçš„åŸå› ï¼‰</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">EnterI</span><span class="p">(</span><span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(((</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span> <span class="n">Self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">thread_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">_thread_blocked</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å°è¯•è·å–é”ï¼Œè·å–é”æˆåŠŸåˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DeferredInitialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å°è¯•è‡ªæ—‹ï¼Œè‡ªæ—‹è·å–é”æˆåŠŸåˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">TrySpin</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†çº¿ç¨‹å°è£…æˆObjectWaiterï¼Œæ’å…¥åˆ°_cxqä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ObjectWaiter</span> <span class="nf">node</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">node</span><span class="p">.</span><span class="n">_prev</span>   <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xBAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">node</span><span class="p">.</span><span class="n">TState</span>  <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span>
</span></span><span class="line"><span class="cl">  <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">nxt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å…ˆå°è¯•å°†nodeæ’å…¥åˆ°_cxqå¤´éƒ¨ï¼Œå¦‚æœæœªæˆåŠŸï¼Œåˆ™CASä¸€éï¼Œå‡å°‘æ’å…¥æ¬¡æ•°å’Œæ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">_next</span> <span class="o">=</span> <span class="n">nxt</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">nxt</span><span class="p">)</span> <span class="o">==</span> <span class="n">nxt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//åˆ¤æ–­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œè‹¥æ²¡æœ‰åˆ™å°†_Responsibleè®¾ç½®æœªè‡ªå·±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nxt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">_EntryList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_Responsible</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">Contention</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nWakeups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">recheckInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœ_Responsible==Nullåˆ™è®¾ç½®ä¸ºè‡ªå·±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_Responsible</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_Responsible</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å¦‚æœ_Responsibleä¸ºè‡ªå·± åˆ™ç­‰å¾…ä¸€å®šæ—¶é—´é—´éš”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_Responsible</span> <span class="o">==</span> <span class="n">Self</span> <span class="o">||</span> <span class="p">(</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">park</span> <span class="n">TIMED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">park</span><span class="p">((</span><span class="n">jlong</span><span class="p">)</span> <span class="n">recheckInterval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">recheckInterval</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">recheckInterval</span> <span class="o">&gt;</span> <span class="n">MAX_RECHECK_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">recheckInterval</span> <span class="o">=</span> <span class="n">MAX_RECHECK_INTERVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å¦‚æœ_Responsibleä¸ä¸ºè‡ªå·±ï¼Œåˆ™ç›´æ¥park
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">park</span> <span class="n">UNTIMED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">park</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å°è¯•è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">Futile</span> <span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">FutileWakeups</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">nWakeups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//å°è¯•è‡ªæ—‹è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">Knob_SpinAfterFutile</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">TrySpin</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">Knob_ResetEvent</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//è¿™ä¸€è½®è¿˜æ²¡èµ°å‡ºå»åˆ™å–æ¶ˆå‡å®šå€™é€‰äººèµ„æ ¼ï¼Œæ´—ç‰Œé‡æ–°æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//èµ°å‡ºè¯¥å¾ªç¯ä»£è¡¨å·²ç»è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">object</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†å½“å‰çº¿ç¨‹çš„nodeä»cxqæˆ–EntryListä¸­ç§»é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">UnlinkAfterAcquire</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_Responsible</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span> <span class="c1">// Dekker pivot-point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ï¼Œå°è¯•è·å–é”å’Œè‡ªæ—‹</p>
<p>2ï¼Œçº¿ç¨‹å°è£…æ·»åŠ åˆ°_cxqé˜Ÿé¦–ï¼Œè¯¥è¿‡ç¨‹ä¹Ÿä¼šå°è¯•è·å–é”</p>
<p>3ï¼Œè¿›å…¥å¾ªç¯parkï¼Œä¸­é€”ä¹Ÿä¼šå°è¯•è·å–é”å’Œè‡ªæ—‹</p>
<p>4ï¼Œè¢«å”¤é†’åï¼Œå†æ¬¡å°è¯•è·å–é”</p>
<p>5ï¼Œå¦‚æœè·å–é”ï¼Œåˆ™å°†nodeä»_cxqæˆ–è€…entryListä¸­ç§»é™¤ï¼Œæƒ…å†µè‡ªå·±æ‰€åœ¨çš„ Responsibleå’Œ succ</p>
<p><strong>æ³¨ï¼š</strong></p>
<p>å½“ç«äº‰å‘ç”Ÿæ—¶ï¼Œé€‰å–ä¸€ä¸ªçº¿ç¨‹ä½œä¸º<code>_Responsible</code>ï¼Œ<code>_Responsible</code>çº¿ç¨‹è°ƒç”¨çš„æ˜¯æœ‰æ—¶é—´é™åˆ¶çš„<code>park</code>æ–¹æ³•ï¼Œå…¶ç›®çš„æ˜¯é˜²æ­¢å‡ºç°<code>ææµ…</code>ç°è±¡ã€‚</p>
</blockquote>
<h5 id="exit">Exit</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="kt">bool</span> <span class="n">not_suspended</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœæ­¤æ—¶è¯¥çº¿ç¨‹ä¸ä¸ºæŒæœ‰é”çš„çº¿ç¨‹ ä¼šæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">THREAD</span> <span class="o">!=</span> <span class="n">_owner</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å› ä¸ºè‡ªå·±æ˜¯è½»é‡çº§é”ï¼Œé”è†¨èƒ€åè¿˜æ²¡æ¥å¾—åŠ Enter å¯¼è‡´çº¿ç¨‹æ²¡åˆ‡æ¢è¿‡æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span> <span class="n">_owner</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_owner</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//çœŸçš„ä¸æ˜¯è‡ªå·±ï¼Œå°±é©¬ä¸Šç¦»å¼€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Exit</span> <span class="o">-</span> <span class="n">Throw</span> <span class="n">IMSX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&#34;Non-balanced monitor enter/exit! Likely JNI locking&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//é”é‡å…¥æƒ…å†µï¼Œrecursion--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_recursions</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_recursions</span><span class="o">--</span><span class="p">;</span>        <span class="c1">// this is simple recursive enter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">recursive</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//_Responsibleè®¾ç½®ä¸ºNull
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if INCLUDE_TRACE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">not_suspended</span> <span class="o">&amp;&amp;</span> <span class="n">Tracing</span><span class="o">::</span><span class="n">is_event_enabled</span><span class="p">(</span><span class="n">TraceJavaMonitorEnterEvent</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_previous_owner_tid</span> <span class="o">=</span> <span class="n">THREAD_TRACE_ID</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">THREAD</span> <span class="o">==</span> <span class="n">_owner</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Knob_ExitPolicy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//code 1:å…ˆé‡Šæ”¾é”ï¼Œéå…¬å¹³é”çš„ä¼˜åŒ–ï¼Œæ­¤æ—¶å¦‚æœæœ‰çº¿ç¨‹è¿›å…¥å¯ä»¥ç›´æ¥è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">OrderAccess</span><span class="o">::</span><span class="n">release_store_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">      <span class="n">OrderAccess</span><span class="o">::</span><span class="n">storeload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//code 2: å¦‚æœæ²¡æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œæˆ–è€…å·²ç»æœ‰å‡å®šå€™é€‰äººäº†ç›´æ¥å¼€æºœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_EntryList</span><span class="p">)</span><span class="o">|</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_cxq</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">simple</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æ­¤æ—¶è¿›è¡Œåç»­æ­¥éª¤éœ€è¦é‡æ–°è·å–é”ï¼Œå¦‚æœè·å–é”å¤±è´¥åˆ™è¯´æ˜å·²ç»æœ‰å¤–ç•Œçº¿ç¨‹å ç”¨é”ï¼Œåˆ™é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Exit</span> <span class="o">-</span> <span class="n">Reacquired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_EntryList</span><span class="p">)</span><span class="o">|</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_cxq</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">OrderAccess</span><span class="o">::</span><span class="n">release_store_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>   <span class="c1">// drop the lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OrderAccess</span><span class="o">::</span><span class="n">storeload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_cxq</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">simple</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">reacquired</span> <span class="n">succeeded</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">reacquired</span> <span class="n">failed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">complex</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">guarantee</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">THREAD</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">w</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">QMode</span> <span class="o">=</span> <span class="n">Knob_QMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// code 4ï¼šæ ¹æ®QModeçš„ä¸åŒä¼šæœ‰ä¸åŒçš„å”¤é†’ç­–ç•¥ï¼Œé»˜è®¤ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// QMode == 2 : cxqä¸­çš„çº¿ç¨‹æœ‰æ›´é«˜ä¼˜å…ˆçº§ï¼Œç›´æ¥å”¤é†’cxqçš„é˜Ÿé¦–çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†cxqä¸­çš„å…ƒç´ æ’å…¥åˆ°EntryListçš„æœ«å°¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">Tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Tail</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span> <span class="n">Tail</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="n">Tail</span> <span class="o">=</span> <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">Tail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">Tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†cxqæ’å…¥åˆ°EntryListçš„é˜Ÿé¦–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_EntryList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_EntryList</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å¦‚æœEntryListä¸ä¸ºç©ºåˆ™å”¤é†’ç¬¬ä¸€ä¸ªå…ƒç´ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">drain</span> <span class="n">cxq</span> <span class="n">into</span> <span class="n">EntryList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_EntryList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// QMode == 1 : å°†cxqä¸­çš„å…ƒç´ è½¬ç§»åˆ°EntryListï¼Œå¹¶åè½¬é¡ºåº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">u</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_EntryList</span>  <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// QMode == 0 or QMode == 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// å°†cxqä¸­çš„å…ƒç´ è½¬ç§»åˆ°EntryList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1">// _succä¸ä¸ºnullï¼Œè¯´æ˜å·²ç»æœ‰ä¸ªç»§æ‰¿äººäº†ï¼Œæ‰€ä»¥ä¸éœ€è¦å½“å‰çº¿ç¨‹å»å”¤é†’ï¼Œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¯”ç‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// å”¤é†’EntryListç¬¬ä¸€ä¸ªå…ƒç´ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">guarantee</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1,ä¼šå…ˆè¿›è¡Œé”é‡å…¥ï¼Œé”è†¨èƒ€ä¸€äº›åˆ¤æ–­ï¼Œå¦‚æœ recursionä¸º0 ä¸” ä¸ºæŒé”çº¿ç¨‹ åˆ™è¿›è¡Œä»¥ä¸‹æ­¥éª¤</p>
<p>2,å…ˆé‡Šæ”¾é”ï¼Œç»™å¤–ç•Œçº¿ç¨‹è·å–åŒæ­¥ä»£ç å—çš„æœºä¼š</p>
<p>3,å¦‚æœæ­¤æ—¶_cxqä¸ºç©º æˆ–è€… å·²ç»æœ‰succ äº† åˆ™é€€å‡º</p>
<p>4,å¦‚æœæ­¤æ—¶_cxqä¸ä¸ºç©ºï¼Œä¸”æ²¡æœ‰succ åˆ™ä¼šé‡æ–°è·å–é”(å¯¹ cxqå’ŒentryListæ“ä½œ)</p>
<p>5,æ ¹æ®QModeçš„ä¸åŒï¼Œä¼šæ‰§è¡Œä¸åŒçš„å”¤é†’ç­–ç•¥ï¼›</p>
<p>æ ¹æ®QModeçš„ä¸åŒï¼Œæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š</p>
<blockquote>
<ol>
<li>QMode = 2ä¸”cxqéç©ºï¼šå–cxqé˜Ÿåˆ—é˜Ÿé¦–çš„ObjectWaiterå¯¹è±¡ï¼Œè°ƒç”¨ExitEpilogæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå”¤é†’ObjectWaiterå¯¹è±¡çš„çº¿ç¨‹ï¼Œç„¶åç«‹å³è¿”å›ï¼Œåé¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œäº†ï¼›</li>
<li>QMode = 3ä¸”cxqéç©ºï¼šæŠŠcxqé˜Ÿåˆ—æ’å…¥åˆ°EntryListçš„å°¾éƒ¨ï¼›</li>
<li>QMode = 4ä¸”cxqéç©ºï¼šæŠŠcxqé˜Ÿåˆ—æ’å…¥åˆ°EntryListçš„å¤´éƒ¨ï¼›</li>
<li>QMode = 0ï¼šæš‚æ—¶ä»€ä¹ˆéƒ½ä¸åšï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼›
<strong>åªæœ‰QMode=2çš„æ—¶å€™ä¼šæå‰è¿”å›ï¼Œç­‰äº0ã€3ã€4çš„æ—¶å€™éƒ½ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼š</strong></li>
</ol>
<p>1.å¦‚æœEntryListçš„é¦–å…ƒç´ éç©ºï¼Œå°±å–å‡ºæ¥è°ƒç”¨ExitEpilogæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå”¤é†’ObjectWaiterå¯¹è±¡çš„çº¿ç¨‹ï¼Œç„¶åç«‹å³è¿”å›ï¼›
2.å¦‚æœEntryListçš„é¦–å…ƒç´ ä¸ºç©ºï¼Œå°±å°†cxqçš„æ‰€æœ‰å…ƒç´ æ”¾å…¥åˆ°EntryListä¸­ï¼Œç„¶åå†ä»EntryListä¸­å–å‡ºæ¥é˜Ÿé¦–å…ƒç´ æ‰§è¡ŒExitEpilogæ–¹æ³•ï¼Œç„¶åç«‹å³è¿”å›ï¼›</p>
</blockquote>
</blockquote>
<h3 id="51-åŸç†ä¹‹-wait--notify">5.1 åŸç†ä¹‹ wait / notify</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220324201947719.png"
	
	
	
	loading="lazy"
	
		alt="image-20220324201947719"
	
	
></p>
<ul>
<li>Ownerçº¿ç¨‹æ–¹æ³•è‡ªèº«æ¡ä»¶ä¸è¶³æ—¶ï¼Œè°ƒç”¨waitæ–¹æ³•ï¼Œå³å¯è¿›å…¥WaitSetå˜ä¸ºWAITINGçŠ¶æ€</li>
<li>BLOCKEDå’ŒWAITINGçš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPU</li>
<li>BLOCKEDçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹è¿è¡Œå®Œæ—¶ï¼Œç»™å”¤é†’</li>
<li>WAITINGçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹è°ƒç”¨notifyæˆ–è€…notifyAllæ—¶å”¤é†’ï¼Œä½†å”¤é†’å¹¶ä¸æ„å‘³ç€ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥EntryListè¿›è¡Œç«äº‰</li>
</ul>
<h4 id="apiä»‹ç»åªèƒ½åœ¨åŒæ­¥ä»£ç å—ä½¿ç”¨">APIä»‹ç»ï¼ˆåªèƒ½åœ¨åŒæ­¥ä»£ç å—ä½¿ç”¨ï¼‰</h4>
<ul>
<li>obj.wait()è®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°waitSetç­‰å¾…</li>
<li>obj.notify()åœ¨objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li>
<li>obj.notifyAll() è®©objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li>
</ul>
<p><strong>æ³¨ï¼šä¸ç®¡ä»€ä¹ˆé”ï¼Œå¦‚æœå¯¹é”å¯¹è±¡è°ƒç”¨wait()æ–¹æ³•ï¼Œä¼šç›´æ¥ä½¿é”çŠ¶æ€å˜ä¸ºFat Lock</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java.lang.Object object internals:
</span></span><span class="line"><span class="cl">OFF  SZ   TYPE DESCRIPTION               VALUE
</span></span><span class="line"><span class="cl">  0   4        (object header: mark)     0x16324c0d (biased: 0x000b1926; epoch: 0; age: 1)
</span></span><span class="line"><span class="cl">  4   4        (object header: class)    0x15691118
</span></span><span class="line"><span class="cl">Instance size: 8 bytes
</span></span><span class="line"><span class="cl">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">java.lang.Object object internals:
</span></span><span class="line"><span class="cl">OFF  SZ   TYPE DESCRIPTION               VALUE
</span></span><span class="line"><span class="cl">  0   4        (object header: mark)     0x15b0ad0e (fat lock: 0x15b0ad0e)
</span></span><span class="line"><span class="cl">  4   4        (object header: class)    0x15691118
</span></span><span class="line"><span class="cl">Instance size: 8 bytes
</span></span><span class="line"><span class="cl">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¸ºä»€ä¹ˆ-wait-notifyå’Œ-notifyallå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨">ä¸ºä»€ä¹ˆ wait(), notify()å’Œ notifyAll()å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ</h4>
<blockquote>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ wait()æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„é”ï¼Œæ¥ç€å®ƒå°±ä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„ notify()æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ notify()æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä»¥ä¾¿å…¶ä»–åœ¨ç­‰å¾…çš„çº¿ç¨‹å°±å¯ä»¥å¾—åˆ°è¿™ä¸ªå¯¹è±¡é”ã€‚ç”±äºæ‰€æœ‰çš„è¿™äº›æ–¹æ³•éƒ½éœ€è¦çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œè¿™æ ·å°±åªèƒ½é€šè¿‡åŒæ­¥æ¥å®ç°ï¼Œæ‰€ä»¥ä»–ä»¬åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ã€‚</p>
</blockquote>
<h5 id="waitlong-timeout"><strong>wait(long timeout):</strong></h5>
<ul>
<li>**timeout ==0 : **æ— é™åˆ¶ç­‰å¾…</li>
<li><strong>timeout &gt; 0:</strong> åœ¨è§„å®šæ—¶é—´è¿›è¡Œç­‰å¾…</li>
</ul>
<h5 id="waitlong-timeoutint-nanos-è™½è¯´æ˜¯çº³ç§’å®é™…ä¸Šæ˜¯å‡çº³ç§’">wait(long timeout,int nanos): è™½è¯´æ˜¯çº³ç§’å®é™…ä¸Šæ˜¯å‡çº³ç§’</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">wait</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nanos</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;timeout value is negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">999999</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="s">&#34;nanosecond timeout value out of range&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">wait</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-wait-notifyçš„æ­£ç¡®å§¿åŠ¿">5.2 wait notifyçš„æ­£ç¡®å§¿åŠ¿</h3>
<h4 id="sleep-å’Œ-wait-çš„åŒºåˆ«">sleep() å’Œ wait() çš„åŒºåˆ«</h4>
<ol>
<li>sleepæ˜¯Threadæ–¹æ³•ï¼Œwaitæ˜¯Objectæ–¹æ³•</li>
<li>sleepä¸ä¼šé‡Šæ”¾é”ï¼Œè€Œwaitä¼šé‡Šæ”¾é”å¯¹è±¡</li>
<li>sleepæ— éœ€å¼ºåˆ¶å’Œsynchronizedä½¿ç”¨ï¼Œä½†æ˜¯waitéœ€è¦å’Œsynchronizedä½¿ç”¨</li>
<li>waitä¼šä½¿é”å¼ºåˆ¶å‡çº§ä¸ºfat lockï¼Œsleepä¸ä¼š</li>
</ol>
<h4 id="å…±åŒç‚¹">å…±åŒç‚¹ï¼š</h4>
<ul>
<li>éƒ½æ˜¯è¿›å…¥TIME_WAITING</li>
</ul>
<h4 id="step1">step1:</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">step2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹å·¥ä½œ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="o">(!</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æœ‰çƒŸæ²¡?[{}]&#34;</span><span class="o">,</span><span class="n">cig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(!</span><span class="n">cig</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ²¡æœ‰çƒŸï¼Œå¼€æ‘†!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                        room.wait();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æœ‰çƒŸäº†ï¼Œå¼€å†²!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;çƒŸé¬¼&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹å·¥ä½œäº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;å…¶ä»–äºº&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            synchronized (room){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">cig</span><span class="o">=!</span><span class="n">cig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;çƒŸæ¥å’¯ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                room.notify();
</span></span></span><span class="line"><span class="cl"><span class="c1">//            }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">},</span><span class="s">&#34;çƒŸè´©å­&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00:12:35.351 [çƒŸé¬¼] DEBUG c.Wait - å¼€å§‹å·¥ä½œ
</span></span><span class="line"><span class="cl">00:12:35.358 [çƒŸé¬¼] DEBUG c.Wait - æœ‰çƒŸæ²¡?[false]
</span></span><span class="line"><span class="cl">00:12:35.359 [çƒŸé¬¼] DEBUG c.Wait - æ²¡æœ‰çƒŸï¼Œå¼€æ‘†!
</span></span><span class="line"><span class="cl">00:12:36.362 [çƒŸè´©å­] DEBUG c.Wait - çƒŸæ¥å’¯ï¼
</span></span><span class="line"><span class="cl">00:12:37.372 [çƒŸé¬¼] DEBUG c.Wait - æœ‰çƒŸäº†ï¼Œå¼€å†²!
</span></span><span class="line"><span class="cl">00:12:37.372 [å…¶ä»–äºº4] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:12:37.372 [å…¶ä»–äºº3] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:12:37.372 [å…¶ä»–äºº2] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:12:37.372 [å…¶ä»–äºº1] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:12:37.372 [å…¶ä»–äºº0] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å¯ä»¥çœ‹å‡ºä¸Šè¿°ä»£ç ä½¿ç”¨sleepçš„è¯ï¼Œä¼šå¯¼è‡´çƒŸé¬¼ä¸€ç›´æ‘†çƒ‚å ç”¨çº¿ç¨‹ï¼Œå¯¼è‡´æ­£å¸¸äººæ— æ³•å·¥ä½œï¼Œæ•ˆç‡å˜ä½</li>
<li>è€Œä¸”çƒŸè´©å­ä¸èƒ½åŠ å…¥åˆ°åŒæ­¥ä»£ç å—ä¸­ï¼Œå¦åˆ™ä¹Ÿä¼šé˜»å¡ã€‚</li>
<li>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨wait-notifyæ¥ä¼˜åŒ–è¯¥ç¨‹åº</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">step2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹å·¥ä½œ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(!</span><span class="n">cig</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ²¡æœ‰çƒŸï¼Œå¼€æ‘†!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">room</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æœ‰çƒŸäº†ï¼Œå¼€å†²!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;çƒŸé¬¼&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹å·¥ä½œäº†&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;å…¶ä»–äºº&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">cig</span><span class="o">=!</span><span class="n">cig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;çƒŸæ¥å’¯ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">room</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;çƒŸè´©å­&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00:06:17.739 [çƒŸé¬¼] DEBUG c.Wait - å¼€å§‹å·¥ä½œ
</span></span><span class="line"><span class="cl">00:06:17.744 [çƒŸé¬¼] DEBUG c.Wait - æ²¡æœ‰çƒŸï¼Œå¼€æ‘†!
</span></span><span class="line"><span class="cl">00:06:18.738 [å…¶ä»–äºº0] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:06:18.739 [å…¶ä»–äºº1] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:06:18.739 [å…¶ä»–äºº2] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:06:18.739 [å…¶ä»–äºº3] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:06:18.739 [å…¶ä»–äºº4] DEBUG c.Wait - å¼€å§‹å·¥ä½œäº†
</span></span><span class="line"><span class="cl">00:06:20.741 [çƒŸè´©å­] DEBUG c.Wait - çƒŸæ¥å’¯ï¼
</span></span><span class="line"><span class="cl">00:06:20.741 [çƒŸé¬¼] DEBUG c.Wait - æœ‰çƒŸäº†ï¼Œå¼€å†²!
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿™æ ·å­å°±å¯ä»¥å¾ˆå¥½çš„è§£å†³çƒŸé¬¼ç­‰çƒŸçš„é—®é¢˜ï¼Œè®©çƒŸé¬¼æŠŠé”è®©å‡ºå»ï¼Œä¾›å…¶ä»–çº¿ç¨‹ä½¿ç”¨</li>
</ul>
<h6 id="ä½†æ˜¯ä¸Šè¿°æ–¹æ³•è¿˜æ˜¯å­˜åœ¨é—®é¢˜å¦‚æœè¿™æ—¶å€™ä¸åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶è€Œæ˜¯æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶è¿™æ—¶å€™notifyä¼šäº§ç”Ÿè™šå‡å”¤é†’çš„ç°è±¡ä¹Ÿå°±æ˜¯å°†å½“å‰æ¡ä»¶ä¸ç¬¦åˆçš„çº¿ç¨‹ç»™å”¤é†’"><strong>ä½†æ˜¯ä¸Šè¿°æ–¹æ³•è¿˜æ˜¯å­˜åœ¨é—®é¢˜</strong>ï¼šå¦‚æœè¿™æ—¶å€™ï¼Œä¸åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶ï¼Œè€Œæ˜¯æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶ï¼Œè¿™æ—¶å€™notifyä¼šäº§ç”Ÿ<em>è™šå‡å”¤é†’</em>çš„ç°è±¡ï¼Œä¹Ÿå°±æ˜¯å°†å½“å‰æ¡ä»¶ä¸ç¬¦åˆçš„çº¿ç¨‹ç»™å”¤é†’ã€‚</h6>
<ul>
<li><strong>å¦‚æœä½¿ç”¨notifyAll()å¯ä»¥è§£å†³é—®é¢˜å—ï¼Ÿ</strong></li>
</ul>
<p>ä¸å¯ä»¥è§£å†³ï¼Œä½†æ˜¯ä¼šæŠŠæ‰€æœ‰çº¿ç¨‹å”¤é†’ï¼Œä¸ç¬¦åˆè¯¥æ¡ä»¶çš„çº¿ç¨‹éƒ½ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—å¯¼è‡´ï¼Œå…¶ä»–çº¿ç¨‹çš„è™šå‡å”¤é†’</p>
<ul>
<li><strong>ä½¿ç”¨whileæ¥æ—¶åˆ»æ£€æŸ¥+notifyAll()å¯ä»¥è§£å†³å—ï¼Ÿ</strong></li>
</ul>
<p>å¯ä»¥è§£å†³</p>
<h2 id="åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ">åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</h2>
<h3 id="å®šä¹‰">å®šä¹‰</h3>
<p>ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p>
<h4 id="è¦ç‚¹">è¦ç‚¹</h4>
<ul>
<li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ªObject</li>
<li>å¦‚æœæœ‰ç»“æœæºæºä¸æ–­çš„ä¼ è¾“ï¼Œåˆ™ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</li>
<li><strong>JDKä¸­ï¼Œjoinå’ŒFutureTaskçš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼â€˜</strong></li>
<li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœæ‰€ä»¥å½’ä¸ºåŒæ­¥æ¨¡å¼</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326142527922.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326142527922"
	
	
></p>
<h3 id="å®ç°">å®ç°</h3>
<h4 id="guardedobjectç±»å®ç°">GuardedObjectç±»å®ç°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">GuardedObject</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="n">Object</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¿æŠ¤æ€§æš‚åœæ¨¡å¼å®ç°">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼å®ç°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">securityStop</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GuardedObject</span> <span class="n">guardedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GuardedObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç­‰å¾…ç»“æœ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span><span class="n">guardedObject</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ä¸‹è½½å†…å®¹&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="n">list</span> <span class="o">=</span>  <span class="n">Downloader</span><span class="o">.</span><span class="na">download</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">           <span class="n">guardedObject</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ä¸‹è½½å®Œæ¯•&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–</h4>
<p>å¦‚æœä¸‹è½½æ—¶é—´ç‰¹åˆ«é•¿ï¼Œå°±ä¼šå¯¼è‡´ç­‰å¾…çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œè¦ç»™ä»–è®¾ç½®ä¸€ä¸ªç­‰å¾…æ—¶é•¿</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">passTime</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">passTime</span> <span class="o">&gt;=</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç­‰å¾…è¶…æ—¶&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">timeOut</span> <span class="o">-</span> <span class="n">passTime</span><span class="o">);</span> <span class="c1">// é˜²æ­¢è™šå‡å”¤é†’æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">passTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–2">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–2</h4>
<p>ä½¿ç”¨Futuresæ–¹æ³• ä¸€ä¸€å¯¹åº”</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326153814167.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326153814167"
	
	
></p>
<h5 id="futureguardedobject">futureGuardedObject</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">futureGuardedObject</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">futureGuardedObject</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">passTime</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">passTime</span> <span class="o">&gt;=</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç­‰å¾…è¶…æ—¶&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">timeOut</span> <span class="o">-</span> <span class="n">passTime</span><span class="o">);</span> <span class="c1">// é˜²æ­¢è™šå‡å”¤é†’æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">passTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="n">Object</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="mailbox">MailBox</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Mailboxes</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">futureGuardedObject</span><span class="o">&gt;</span> <span class="n">boxes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">generateId</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">futureGuardedObject</span> <span class="nf">createGuardedObject</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="k">new</span> <span class="n">futureGuardedObject</span><span class="o">(</span><span class="n">generateId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">boxes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">go</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">go</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">futureGuardedObject</span> <span class="nf">getGuradObject</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">boxes</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">getIds</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">boxes</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="person">Person</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Person</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">       <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">createGuardedObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹æ”¶ä¿¡ id{}&#34;</span><span class="o">,</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">       <span class="n">Object</span> <span class="n">mail</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°ä¿¡ id{} å†…å®¹{}&#34;</span><span class="o">,</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="postman">PostMan</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">PostMan</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">mail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">PostMan</span><span class="o">(</span><span class="n">String</span> <span class="n">mail</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¼€å§‹é€ä¿¡ id{} å†…å®¹{}&#34;</span><span class="o">,</span><span class="n">id</span><span class="o">,</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">getGuradObject</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">go</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">futureSecurityStop</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">3</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Person</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">getIds</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">id</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">PostMan</span><span class="o">(</span><span class="s">&#34;ä¿¡å°&#34;</span><span class="o">+</span><span class="n">id</span><span class="o">,</span><span class="n">id</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">16:30:44.541 [Thread-0] DEBUG People - å¼€å§‹æ”¶ä¿¡ id1
</span></span><span class="line"><span class="cl">16:30:44.541 [Thread-2] DEBUG People - å¼€å§‹æ”¶ä¿¡ id2
</span></span><span class="line"><span class="cl">16:30:44.541 [Thread-1] DEBUG People - å¼€å§‹æ”¶ä¿¡ id3
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-3] DEBUG PostMan - å¼€å§‹é€ä¿¡ id3 å†…å®¹ä¿¡å°3
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-4] DEBUG PostMan - å¼€å§‹é€ä¿¡ id2 å†…å®¹ä¿¡å°2
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-5] DEBUG PostMan - å¼€å§‹é€ä¿¡ id1 å†…å®¹ä¿¡å°1
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-1] DEBUG People - æ”¶åˆ°ä¿¡ id3 å†…å®¹ä¿¡å°3
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-2] DEBUG People - æ”¶åˆ°ä¿¡ id2 å†…å®¹ä¿¡å°2
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-0] DEBUG People - æ”¶åˆ°ä¿¡ id1 å†…å®¹ä¿¡å°1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…">å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…</h2>
<h3 id="å®šä¹‰-1">å®šä¹‰</h3>
<h4 id="è¦ç‚¹-1">è¦ç‚¹</h4>
<ul>
<li>ä¸éœ€è¦åƒGuardedObjectä¸€æ ·ï¼Œæ¯æœ‰ä¸€ä¸ªç”Ÿäº§è€…å°±å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå»ä¸€ä¸€å¯¹åº”</li>
<li>ç”Ÿäº§è€…æ— éœ€å…³å¿ƒæ•°æ®å¤„ç†ï¼Œåªéœ€è¦è´Ÿè´£ç”Ÿäº§å°±è¡Œï¼Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç”Ÿäº§è€…äº§ç”Ÿçš„æ•°æ®</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡æ˜¯æœ‰é™åº¦çš„</strong>ï¼Œå½“å®¹é‡æ»¡äº†çš„æ—¶å€™ï¼Œå°±ä¸ä¼šåœ¨å¾€é‡Œé¢æ·»åŠ æ•°æ®ï¼Œå½“å®¹é‡ç©ºäº†çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šç»§ç»­æ¶ˆè€—æ•°æ®</li>
<li>JDKå„ç§é˜»å¡é˜Ÿåˆ—é‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326163817796.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326163817796"
	
	
></p>
<p>**æ³¨ï¼š**å¼‚æ­¥æ˜¯å› ä¸ºç”Ÿäº§è€…çš„æ¶ˆæ¯ä¸ä¼šç«‹åˆ»è¢«å¤„ç†</p>
<h4 id="å®ç°-1">å®ç°</h4>
<h5 id="message">Message</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Message</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Message{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;id=&#34;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;, value=&#34;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="messagequeue">MessageQueue</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MessageQueue</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kt">int</span> <span class="n">capcity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="nf">MessageQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capcity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="o">.</span><span class="na">capcity</span> <span class="o">=</span> <span class="n">capcity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">Message</span> <span class="nf">take</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">while</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                 <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;é˜Ÿåˆ—ä¸ºç©ºï¼Œæš‚æ— éœ€è¦å¤„ç†çš„å†…å®¹&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                     <span class="n">list</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                     <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">             <span class="n">list</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">          <span class="kd">synchronized</span> <span class="o">(</span><span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">              <span class="k">while</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">capcity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                  <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                      <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;é˜Ÿåˆ—å·²æ»¡ï¼Œè¯·ç¨å&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                      <span class="n">list</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                  <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                  <span class="o">}</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span>
</span></span><span class="line"><span class="cl">              <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å·²ç»æ·»åŠ  äº§å“ id{} å†…å®¹ {}&#34;</span><span class="o">,</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">message</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">              <span class="n">list</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">list</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¿è¡Œæµ‹è¯•-1">è¿è¡Œæµ‹è¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducersAndConsumers</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageQueue</span> <span class="n">messageQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageQueue</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç”Ÿäº§è€…{} å¼€å§‹ç”Ÿäº§&#34;</span><span class="o">,</span><span class="n">temp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Message</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span><span class="s">&#34;å­¦ä¹ èµ„æ–™&#34;</span><span class="o">+</span><span class="n">temp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">messageQueue</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;ç”Ÿäº§è€…&#34;</span><span class="o">+</span><span class="n">temp</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span>  <span class="n">messageQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å·²ç»å¤„ç† äº§å“ id{} å†…å®¹ {}&#34;</span><span class="o">,</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">message</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;æ¶ˆè´¹è€…&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">17:11:14.080 [æ¶ˆè´¹è€…] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæš‚æ— éœ€è¦å¤„ç†çš„å†…å®¹
</span></span><span class="line"><span class="cl">17:11:14.080 [ç”Ÿäº§è€…3] DEBUG main - ç”Ÿäº§è€…3 å¼€å§‹ç”Ÿäº§
</span></span><span class="line"><span class="cl">17:11:14.080 [ç”Ÿäº§è€…4] DEBUG main - ç”Ÿäº§è€…4 å¼€å§‹ç”Ÿäº§
</span></span><span class="line"><span class="cl">17:11:14.080 [ç”Ÿäº§è€…1] DEBUG main - ç”Ÿäº§è€…1 å¼€å§‹ç”Ÿäº§
</span></span><span class="line"><span class="cl">17:11:14.080 [ç”Ÿäº§è€…2] DEBUG main - ç”Ÿäº§è€…2 å¼€å§‹ç”Ÿäº§
</span></span><span class="line"><span class="cl">17:11:14.080 [ç”Ÿäº§è€…0] DEBUG main - ç”Ÿäº§è€…0 å¼€å§‹ç”Ÿäº§
</span></span><span class="line"><span class="cl">17:11:16.100 [ç”Ÿäº§è€…2] DEBUG MessageQueue - å·²ç»æ·»åŠ  äº§å“ id2 å†…å®¹ å­¦ä¹ èµ„æ–™2
</span></span><span class="line"><span class="cl">17:11:16.100 [æ¶ˆè´¹è€…] DEBUG main - å·²ç»å¤„ç† äº§å“ id2 å†…å®¹ å­¦ä¹ èµ„æ–™2
</span></span><span class="line"><span class="cl">17:11:16.100 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç»æ·»åŠ  äº§å“ id1 å†…å®¹ å­¦ä¹ èµ„æ–™1
</span></span><span class="line"><span class="cl">17:11:16.100 [ç”Ÿäº§è€…4] DEBUG MessageQueue - å·²ç»æ·»åŠ  äº§å“ id4 å†…å®¹ å­¦ä¹ èµ„æ–™4
</span></span><span class="line"><span class="cl">17:11:16.100 [ç”Ÿäº§è€…3] DEBUG MessageQueue - å·²ç»æ·»åŠ  äº§å“ id3 å†…å®¹ å­¦ä¹ èµ„æ–™3
</span></span><span class="line"><span class="cl">17:11:16.101 [ç”Ÿäº§è€…0] DEBUG MessageQueue - é˜Ÿåˆ—å·²æ»¡ï¼Œè¯·ç¨å
</span></span><span class="line"><span class="cl">17:11:16.101 [æ¶ˆè´¹è€…] DEBUG main - å·²ç»å¤„ç† äº§å“ id1 å†…å®¹ å­¦ä¹ èµ„æ–™1
</span></span><span class="line"><span class="cl">17:11:16.101 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç»æ·»åŠ  äº§å“ id0 å†…å®¹ å­¦ä¹ èµ„æ–™0
</span></span><span class="line"><span class="cl">17:11:16.101 [æ¶ˆè´¹è€…] DEBUG main - å·²ç»å¤„ç† äº§å“ id4 å†…å®¹ å­¦ä¹ èµ„æ–™4
</span></span><span class="line"><span class="cl">17:11:16.101 [æ¶ˆè´¹è€…] DEBUG main - å·²ç»å¤„ç† äº§å“ id3 å†…å®¹ å­¦ä¹ èµ„æ–™3
</span></span><span class="line"><span class="cl">17:11:16.101 [æ¶ˆè´¹è€…] DEBUG main - å·²ç»å¤„ç† äº§å“ id0 å†…å®¹ å­¦ä¹ èµ„æ–™0
</span></span><span class="line"><span class="cl">17:11:16.101 [æ¶ˆè´¹è€…] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæš‚æ— éœ€è¦å¤„ç†çš„å†…å®¹
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-çº¿ç¨‹åˆ‡æ¢">6 çº¿ç¨‹åˆ‡æ¢</h2>
<h3 id="61-é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢">6.1 é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220328204903731.png"
	
	
	
	loading="lazy"
	
		alt="image-20220328204903731"
	
	
></p>
<h4 id="æƒ…å†µ1-new----runnable">æƒ…å†µ1 NEW &ndash;&gt; RUNNABLE</h4>
<ul>
<li>è°ƒç”¨Thread.startæ–¹æ³•ï¼Œç”±New&ndash;&gt;Runnable</li>
</ul>
<h4 id="æƒ…å†µ2-runnable-----waiting">æƒ…å†µ2 RUNNABLE &lt;&mdash;&gt; WAITING</h4>
<p><strong>tçº¿ç¨‹ç”¨synchronized(obj)è·å–å¯¹è±¡å</strong></p>
<ul>
<li>è°ƒç”¨wait()æ–¹æ³•ï¼Œè¿›å…¥<strong>WAITING</strong>çŠ¶æ€</li>
<li>è°ƒç”¨notify()ï¼ŒnotifyAll()ï¼Œinterrupt()æ—¶</li>
</ul>
<blockquote>
<ul>
<li>ç«äº‰æˆåŠŸï¼Œä»<strong>waiting</strong>è½¬ä¸º<strong>runnable</strong></li>
<li>ç«äº‰å¤±è´¥ï¼Œä»<strong>waiting</strong>è½¬ä¸º<strong>blocked</strong></li>
</ul>
</blockquote>
<h4 id="æƒ…å†µ3-runnable-----waiting">æƒ…å†µ3 RUNNABLE &lt;&mdash;&gt; WAITING</h4>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<strong>t.join()<strong>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»</strong>RUNNABLE&ndash;&gt;WAITING</strong>ï¼Œå½“å‰çº¿ç¨‹åœ¨tå¯¹è±¡çš„çº¿ç¨‹ç›‘è§†å™¨ä¸Šç­‰å¾…</li>
<li>å½“tçº¿ç¨‹æ‰§è¡Œç»“æŸåï¼Œæˆ–è€…è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<strong>interrupt()<strong>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»</strong>WAITING &ndash;&gt; RUNNABLE</strong></li>
</ul>
<h4 id="æƒ…å†µ4-runnable----waiting">æƒ…å†µ4 RUNNABLE &lt;&ndash;&gt; WAITING</h4>
<ul>
<li>
<p>å½“å‰çº¿ç¨‹ <strong>LockSupport.park()</strong> æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ ä»<strong>RUNNABLE &ndash;&gt; WAITING</strong></p>
</li>
<li>
<p>è°ƒç”¨ <strong>LockSupport.unpark()</strong> æ–¹æ³• æˆ–è€… è°ƒç”¨äº† interruptæ–¹æ³• ä¼šä½¿ <strong>WAITING &ndash;&gt; RUNNABLE</strong></p>
</li>
</ul>
<h4 id="æƒ…å†µ5-runnable----timed_waiting">æƒ…å†µ5 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<p><strong>tçº¿ç¨‹ç”¨synchronized(obj)è·å–å¯¹è±¡å</strong></p>
<ul>
<li>è°ƒç”¨<strong>wait(time)<strong>æ–¹æ³•ï¼Œè¿›å…¥</strong>TIME_WAITING</strong>çŠ¶æ€</li>
<li>è°ƒç”¨<strong>notify()</strong>ï¼Œ<strong>notifyAll()</strong>ï¼Œ<strong>interrupt()</strong>ï¼Œæˆ–è€…waitæ—¶é—´è€—å°½æ—¶</li>
</ul>
<blockquote>
<ul>
<li>ç«äº‰æˆåŠŸï¼Œä»<strong>waiting</strong>è½¬ä¸º<strong>runnable</strong></li>
<li>ç«äº‰å¤±è´¥ï¼Œä»<strong>waiting</strong>è½¬ä¸º<strong>blocked</strong></li>
</ul>
</blockquote>
<h4 id="æƒ…å†µ6-runnable----timed_waiting">æƒ…å†µ6 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>tçº¿ç¨‹è°ƒç”¨<strong>sleep(time)</strong>ï¼Œè¿›å…¥<strong>TIME_WAITING</strong>çŠ¶æ€</li>
<li><strong>è¶…æ—¶æˆ–è€…è°ƒç”¨interruptä»RUNNABLE&ndash;&gt;TIMED_WAITING</strong></li>
</ul>
<h4 id="æƒ…å†µ7-runnable----timed_waiting">æƒ…å†µ7 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>
<p>tçº¿ç¨‹è°ƒç”¨<strong>LockSupport.park(time)</strong>ï¼Œè¿›å…¥<strong>TIME_WAITING</strong>çŠ¶æ€</p>
</li>
<li>
<p><strong>è¶…æ—¶æˆ–è€…è°ƒç”¨interruptä»RUNNABLE&ndash;&gt;TIMED_WAITING</strong></p>
</li>
</ul>
<h4 id="æƒ…å†µ8-runnable----timed_waiting">æƒ…å†µ8 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>
<p>tçº¿ç¨‹è°ƒç”¨<strong>join(time)</strong>ï¼Œè¿›å…¥<strong>TIME_WAITING</strong>çŠ¶æ€</p>
</li>
<li>
<p><strong>è¶…æ—¶æˆ–è€…è°ƒç”¨interruptä»RUNNABLE&ndash;&gt;TIMED_WAITING</strong></p>
</li>
</ul>
<h4 id="æƒ…å†µ9-runnable----terminated">æƒ…å†µ9 RUNNABLE &lt;&ndash;&gt; TERMINATED</h4>
<p>çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</p>
<ul>
<li></li>
</ul>
<h2 id="8-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶">8 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</h2>
<h4 id="å›ºå®šè¿è¡Œé¡ºåº">å›ºå®šè¿è¡Œé¡ºåº</h4>
<blockquote>
<p>ä¾‹é¢˜ï¼šè¦æ±‚çº¿ç¨‹Bå…ˆè¾“å‡ºå†çº¿ç¨‹Aè¾“å‡º</p>
</blockquote>
<h5 id="wait-notifyçš„æ–¹æ³•æ¥å…ˆåè¾“å‡º">wait-notifyçš„æ–¹æ³•æ¥å…ˆåè¾“å‡º</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">boolean</span> <span class="n">t2runned</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">A</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">while</span><span class="o">(!</span><span class="n">t2runned</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                 <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">B</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t2runned</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">B</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="park-unparkçš„æ–¹æ³•æ¥å…ˆåè¾“å‡º">park-unparkçš„æ–¹æ³•æ¥å…ˆåè¾“å‡º</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="äº¤æ›¿è¾“å‡º">äº¤æ›¿è¾“å‡º</h4>
<blockquote>
<p>ä¾‹é¢˜ï¼šçº¿ç¨‹1 è¾“å‡º a 5æ¬¡ï¼Œçº¿ç¨‹2 è¾“å‡º b 5æ¬¡ï¼Œ çº¿ç¨‹3 è¾“å‡º c 5æ¬¡ã€‚ç°åœ¨è¦æ±‚è¾“å‡º<strong>abcabcabcabcabc</strong>æ€ä¹ˆå®ç°</p>
</blockquote>
<h4 id="wait-notifyç‰ˆæœ¬">wait-notifyç‰ˆæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">WaitNotify</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loopNum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">flag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">WaitNotify</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNum</span><span class="o">,</span><span class="kt">int</span> <span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">loopNum</span> <span class="o">=</span> <span class="n">loopNum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">,</span> <span class="n">String</span> <span class="n">word</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNum</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="o">(</span><span class="n">index</span><span class="o">!=</span><span class="n">flag</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">flag</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">WaitNotify</span> <span class="n">waitNotify</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WaitNotify</span><span class="o">(</span><span class="n">5</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">2</span><span class="o">,</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">3</span><span class="o">,</span><span class="s">&#34;b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">3</span><span class="o">,</span><span class="n">1</span><span class="o">,</span><span class="s">&#34;c&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:25:53.672 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="await-signalç‰ˆæœ¬">await-signalç‰ˆæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AwaitSignal</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loopNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AwaitSignal</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">loopNumber</span> <span class="o">=</span> <span class="n">loopNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">Condition</span> <span class="n">condition</span><span class="o">,</span><span class="n">Condition</span> <span class="n">nextCondition</span><span class="o">,</span><span class="n">String</span> <span class="n">word</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">nextCondition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">AwaitSignal</span> <span class="n">awaitSignal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AwaitSignal</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition1</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition2</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition3</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition1</span><span class="o">,</span><span class="n">condition2</span><span class="o">,</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition2</span><span class="o">,</span><span class="n">condition3</span><span class="o">,</span><span class="s">&#34;b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition3</span><span class="o">,</span><span class="n">condition1</span><span class="o">,</span><span class="s">&#34;c&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">awaitSignal</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">condition1</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">awaitSignal</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:48:25.989 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.995 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.995 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.997 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨ï¼šæ­¤å¤„æœ‰bugï¼Œå½“aå”¤é†’båï¼Œæ­¤æ—¶aæœªè¿›å…¥conditionè¿›è¡Œç­‰å¾…ï¼Œè€Œæ˜¯ç›´æ¥è¿è¡Œbï¼Œbå†è¿è¡Œcï¼Œcå”¤é†’aåï¼Œå†æ¬¡è¿›å…¥cç„¶åè¿›è¡Œç­‰å¾…ï¼Œç„¶åè¿è¡Œa è¿›è¡Œç­‰å¾…ï¼Œå°±ä¼šä½¿å¾—aæ— äººå”¤é†’ã€‚</p>
<h4 id="park-unparkç‰ˆæœ¬">park-unparkç‰ˆæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public static void test3(int n){
</span></span><span class="line"><span class="cl">        ParkUnPark parkUnPark = new ParkUnPark(n);
</span></span><span class="line"><span class="cl">        t1 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;a&#34;,t2);
</span></span><span class="line"><span class="cl">        },&#34;3-t1&#34;);
</span></span><span class="line"><span class="cl">        t2 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;b&#34;,t3);
</span></span><span class="line"><span class="cl">        },&#34;3-t2&#34;);
</span></span><span class="line"><span class="cl">        t3 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            long start = System.currentTimeMillis();
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;c&#34;,t1);
</span></span><span class="line"><span class="cl">            long end = System.currentTimeMillis();
</span></span><span class="line"><span class="cl">            log.debug(&#34;ParkUnPark time{} ms&#34;,start-end);
</span></span><span class="line"><span class="cl">        },&#34;3-t3&#34;);
</span></span><span class="line"><span class="cl">        t1.start();
</span></span><span class="line"><span class="cl">        t2.start();
</span></span><span class="line"><span class="cl">        t3.start();
</span></span><span class="line"><span class="cl">        LockSupport.unpark(t1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">class ParkUnPark{
</span></span><span class="line"><span class="cl">    private int loopNumber;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public void print(String word,Thread next){
</span></span><span class="line"><span class="cl">        for (int i = 0; i &lt;loopNumber ; i++) {
</span></span><span class="line"><span class="cl">            LockSupport.park();
</span></span><span class="line"><span class="cl">            //log.debug(word);
</span></span><span class="line"><span class="cl">            LockSupport.unpark(next);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public ParkUnPark(int loopNumber){
</span></span><span class="line"><span class="cl">        this.loopNumber = loopNumber;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ä¸‰ä¸ªç‰ˆæœ¬è¿è¡Œ50000æ¬¡é€Ÿåº¦æ¯”è¾ƒ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">01:38:15.238 [3-t3] DEBUG JUC.model.alternateControl - ParkUnPark time-13545 ms
</span></span><span class="line"><span class="cl">01:38:16.938 [2-t3] DEBUG JUC.model.alternateControl - AwaitSignal time-15245 ms
</span></span><span class="line"><span class="cl">01:38:20.998 [1-t3] DEBUG JUC.model.alternateControl - WaitNotify time-19289 ms
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ParkUnPark &gt; AwaitSignal &gt; WaitNotify</p>
</blockquote>
<h2 id="9-å…±äº«æ¨¡å‹ä¹‹å†…å­˜">9 å…±äº«æ¨¡å‹ä¹‹å†…å­˜</h2>
<h3 id="91-javaå†…å­˜æ¨¡å‹">9.1 Javaå†…å­˜æ¨¡å‹</h3>
<h4 id="ç®€ä»‹">ç®€ä»‹</h4>
<p>JMMå³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ï¼Œå·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ï¼Œç¼“å­˜ï¼Œç¡¬ä»¶å†…å­˜ï¼ŒCPUæŒ‡ä»¤ä¼˜åŒ–ç­‰</p>
<p>JMMä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>åŸå­æ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li>
<li>å¯è§æ€§-ä¿è¯æŒ‡ä»¤ä¸å—CPUç¼“å­˜çš„å½±å“</li>
<li>æœ‰åºæ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šCPUæŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li>
</ul>
<h3 id="92-å¯è§æ€§">9.2 å¯è§æ€§</h3>
<h4 id="ç®€ä»‹-1"><strong>ç®€ä»‹ï¼š</strong></h4>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç°ä»£è®¡ç®—æœºä¸­ï¼Œç”±äº CPU ç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®çš„æ•ˆç‡ä¸é«˜ï¼Œæ‰€ä»¥éƒ½ä¼šå¯¹åº”çš„ CPU é«˜é€Ÿç¼“å­˜ï¼Œå…ˆå°†ä¸»å†…å­˜ä¸­çš„æ•°æ®è¯»å–åˆ°ç¼“å­˜ä¸­ï¼Œçº¿ç¨‹ä¿®æ”¹æ•°æ®ä¹‹åé¦–å…ˆæ›´æ–°åˆ°ç¼“å­˜ï¼Œä¹‹åæ‰ä¼šæ›´æ–°åˆ°ä¸»å†…å­˜ã€‚å¦‚æœæ­¤æ—¶è¿˜æ²¡æœ‰å°†æ•°æ®æ›´æ–°åˆ°ä¸»å†…å­˜å…¶ä»–çš„çº¿ç¨‹æ­¤æ—¶æ¥è¯»å–å°±æ˜¯ä¿®æ”¹ä¹‹å‰çš„æ•°æ®ã€‚è€Œåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å˜é‡çš„å€¼æ”¹å˜ï¼Œä¸å®é™…çš„å€¼ä¸ç¬¦ï¼Œè€Œç¼“å­˜é‡Œçš„å€¼æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚æ‰€ä»¥åº”å½“ä¿è¯åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå˜é‡çš„å€¼å¾—æ”¹å˜è¦åŒæ­¥ï¼Œvolatileä¿è¯äº†æ¯æ¬¡å€¼éƒ½ä»å†…å­˜ä¸­è·å–ã€‚</p>
</blockquote>
<h4 id="å®šä¹‰-2">å®šä¹‰:</h4>
<p>å¯è§æ€§å°±æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚</p>
<h4 id="é—®é¢˜">é—®é¢˜</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">boolean</span> <span class="n">runnable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">runnable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        new Thread(()-&gt;{
</span></span></span><span class="line"><span class="cl"><span class="c1">//            foo();
</span></span></span><span class="line"><span class="cl"><span class="c1">//        }).start();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="n">runnable</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç»“æŸ i={}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç»“æœ">ç»“æœ</h4>
<p>JDK5 ä¸­ è¿è¡Œä¸ä¼šåœæ­¢</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331154727822.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331154727822"
	
	
></p>
<p>JDK8ä¸­ è¿è¡Œåœæ­¢äº†ï¼ˆè¿™é‡Œæ˜¯å› ä¸ºæˆ‘ç”¨çš„æ˜¯jdk x86çš„åŸå›  å¯¼è‡´ä¸ä¼šæœ‰å¯è§æ€§å­˜åœ¨ï¼‰</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331154758252.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331154758252"
	
	
></p>
<h4 id="åŸç†-1">åŸç†</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331142913212.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331142913212"
	
	
></p>
<p>å½“å…¨å±€å˜é‡å®šä¹‰æ—¶ï¼Œæ”¾å…¥åœ¨ä¸»å†…å­˜ï¼Œæ­¤æ—¶tçº¿ç¨‹è¯»å–ä¸»å†…å­˜çš„runï¼Œè¿›å…¥å¾ªç¯</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331143050864.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331143050864"
	
	
></p>
<p>æœ‰JITä¼˜åŒ–çš„åŸå› ï¼Œä¼šç»™tçº¿ç¨‹å¼€è¾Ÿä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œå¹¶å°†å˜é‡runå­˜å…¥é«˜é€Ÿç¼“å­˜ï¼Œä»¥å¸®åŠ©çº¿ç¨‹æ›´å¿«çš„è·å–å˜é‡</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331143203102.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331143203102"
	
	
></p>
<p>æ­¤æ—¶ä¸»çº¿ç¨‹ä¿®æ”¹ä¸»å†…å­˜ä¸­çš„runï¼Œrunè¢«æ”¹ä¸ºfalseï¼Œä½†æ˜¯tçº¿ç¨‹ä¸­çš„runè¿˜æ˜¯ä½¿ç”¨çš„é«˜é€Ÿç¼“å­˜ï¼Œåˆ™å¯¼è‡´ä¸å¯è§æ€§ï¼Œ</p>
<p>å¾ªç¯ä¸€ç›´æŒç»­ã€‚</p>
<h4 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h4>
<h5 id="volatileæ˜“å˜å…³é”®å­—">volatile(æ˜“å˜å…³é”®å­—)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">runnable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„çº¿ç¨‹çš„å·¥ä½œç¼“å­˜è·å–èµ„æºï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œvolatileå˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜</p>
<h5 id="synchronized">synchronized</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">runnable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">foo2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(!</span><span class="n">runnable</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="ä¸ºä»€ä¹ˆåœ¨whileå¾ªç¯ä¸­åŠ å…¥systemoutprintln-ä¹Ÿä¼šä½¿å…¶é€€å‡ºå¾ªç¯">ä¸ºä»€ä¹ˆåœ¨whileå¾ªç¯ä¸­åŠ å…¥System.out.println() ä¹Ÿä¼šä½¿å…¶é€€å‡ºå¾ªç¯ï¼Ÿ</h6>
<blockquote>
<p>å› ä¸ºåœ¨System.out.println()çš„æºç ä¸­ï¼Œè¿›è¡Œäº†åŠ é”æ“ä½œ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public void println(String x) {
</span></span><span class="line"><span class="cl">        synchronized (this) {
</span></span><span class="line"><span class="cl">            print(x);
</span></span><span class="line"><span class="cl">            newLine();
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="synchronized-vs-volatile">Synchronized vs Volatile</h4>
<ul>
<li>
<p>volatileä¿è¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹volatileå˜é‡ä¿®æ”¹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹volatileè¯»å–ï¼Œ<strong>å¯ä»¥ä¿è¯å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯åŸå­æ€§</strong>ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹è¯»å–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹çš„æƒ…å†µã€‚</p>
</li>
<li>
<p>synchronized å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„è¯»å†™é—®é¢˜ï¼Œ<strong>å³æ—¢èƒ½ä¿è¯åŸå­æ€§ä¹Ÿèƒ½ä¿è¯å¯è§æ€§</strong>ï¼Œä½†æ˜¯synchronizedå±äºé‡é‡çº§æ“ä½œï¼Œååˆ†æ¶ˆè€—æ€§èƒ½ã€‚</p>
</li>
</ul>
<h4 id="ä½¿ç”¨volatileçš„ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼">ä½¿ç”¨volatileçš„ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">TwoPhaseInterrput</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">stop</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ–™ç†åäº‹&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç›‘æ§ä¸­&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//current.interrupt(); //ç”±äºsleepä¼šæ¸…é™¤Interruptæ ‡è®°,é‡æ–°æ‰“æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;åœæ­¢ç›‘æ§&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseInterrput</span> <span class="n">twoPhaseInterrput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseInterrput</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åŒæ­¥æ¨¡å¼ä¹‹balking">åŒæ­¥æ¨¡å¼ä¹‹Balking</h4>
<p>Balking(çŠ¹è±«)æ¨¡å¼ï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹åšäº†æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆçº¿ç¨‹åˆ™æ— éœ€åœ¨åšäº†ï¼Œç›´æ¥è¿”å›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TwoPhaseTermination</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitorThread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">starting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">monitorThread</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">monitorThread</span><span class="o">.</span><span class="na">getState</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">TERMINATED</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">starting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å”¤é†’ç›‘æ§&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">starting</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç›‘æ§å·²ç»å¯åŠ¨&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">starting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;åˆ›å»ºæ–°ç›‘æ§&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitorThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å¯åŠ¨ç›‘æ§&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ç›‘æ§å…³é—­&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;monitor&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitorThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseTermination</span> <span class="n">twoPhaseTermination</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseTermination</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">twoPhaseTermination</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">twoPhaseTermination</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç»“æœ-1">ç»“æœ:</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">18:46:18.095 [t1] DEBUG JUC.model.TwoPhaseTermination - åˆ›å»ºæ–°ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:18.095 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:18.106 [monitor] DEBUG JUC.model.TwoPhaseTermination - å¯åŠ¨ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:18.621 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:19.113 [monitor] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å…³é—­
</span></span><span class="line"><span class="cl">18:46:19.128 [t1] DEBUG JUC.model.TwoPhaseTermination - å”¤é†’ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:19.128 [t1] DEBUG JUC.model.TwoPhaseTermination - åˆ›å»ºæ–°ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:19.128 [monitor] DEBUG JUC.model.TwoPhaseTermination - å¯åŠ¨ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:19.635 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:20.136 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:20.136 [monitor] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å…³é—­
</span></span><span class="line"><span class="cl">18:46:20.649 [t1] DEBUG JUC.model.TwoPhaseTermination - å”¤é†’ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:20.649 [t1] DEBUG JUC.model.TwoPhaseTermination - åˆ›å»ºæ–°ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:20.649 [monitor] DEBUG JUC.model.TwoPhaseTermination - å¯åŠ¨ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:21.164 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:21.664 [monitor] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å…³é—­
</span></span><span class="line"><span class="cl">18:46:21.664 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:22.165 [t1] DEBUG JUC.model.TwoPhaseTermination - å”¤é†’ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:22.165 [t1] DEBUG JUC.model.TwoPhaseTermination - åˆ›å»ºæ–°ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:22.165 [monitor] DEBUG JUC.model.TwoPhaseTermination - å¯åŠ¨ç›‘æ§
</span></span><span class="line"><span class="cl">18:46:22.666 [t1] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å·²ç»å¯åŠ¨
</span></span><span class="line"><span class="cl">18:46:23.165 [monitor] DEBUG JUC.model.TwoPhaseTermination - ç›‘æ§å…³é—­
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åº”ç”¨">åº”ç”¨ï¼š</h5>
<p>å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="93-æœ‰åºæ€§">9.3 æœ‰åºæ€§</h3>
<h4 id="ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’">ä»€ä¹ˆæ˜¯ã€æŒ‡ä»¤é‡æ’ã€‘ï¼Ÿ</h4>
<p>JVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">int</span> <span class="n">j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl"><span class="n">j</span> <span class="o">=</span> <span class="o">..</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºä»¥ä¸Šç»“æœï¼Œå…ˆæ‰§è¡Œiï¼Œè¿˜æ˜¯å…ˆæ‰§è¡Œjï¼Œéƒ½ä¸ä¼šå¯¹æœ€åçš„ç»“æœæœ‰å½±å“ï¼Œè¿™æ ·çš„ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€‘ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ä¼šå½±å“æ­£ç¡®æ€§ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦æœ‰æŒ‡ä»¤é‡æ’è¿™ä¸€ç‰¹æ€§å‘¢">ä¸ºä»€ä¹ˆè¦æœ‰ã€æŒ‡ä»¤é‡æ’ã€‘è¿™ä¸€ç‰¹æ€§å‘¢ï¼Ÿ</h4>
<h5 id="æŒ‡ä»¤é‡æ’åºä¼˜åŒ–">æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</h5>
<p>ç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„CPUæŒ‡ä»¤ã€‚æŒ‡ä»¤å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š<strong>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331191315711.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331191315711"
	
	
></p>
<p>å¦‚åƒå›¾ä¸Šæ“ä½œçš„è¯ï¼Œå°†æµªè´¹å¾ˆå¤šæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŒ‡ä»¤è¯‘ç æœŸé—´ï¼Œæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„å–æŒ‡ä»¤ã€‚ç°ä»£<strong>CPUæ”¯æŒå¤šçº§æŒ‡ä»¤çš„æµæ°´çº¿æ“ä½œ</strong>ï¼Œä¾‹å¦‚åŒæ—¶æ‰§è¡Œ <strong>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</strong>  çš„å¤„ç†å™¨ï¼Œå°±å¯ä»¥ç§°ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚è¿™æ˜¯CPUå¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œ<strong>åŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µ</strong>ï¼Œæœ¬è´¨ä¸Šï¼Œ<strong>å¤šçº§æŒ‡ä»¤æµæ°´çº¿æ“ä½œä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯å¯ä»¥å¤§å¤§æé«˜ååé‡</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331191655681.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331191655681"
	
	
></p>
<p>åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡<strong>é‡æ’åº</strong>å’Œ<strong>ç»„åˆ</strong>æ¥å®ç°æŒ‡ä»¤å¹¶è¡Œï¼Œå¦‚ä¸‹å›¾å°±æ˜¯å¯ä»¥è¿›è¡ŒæŒ‡ä»¤é‡æ’åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¿™æ˜¯ä¸èƒ½æŒ‡ä»¤é‡æ’åºçš„ä¾‹å­</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">20</span> <span class="o">-</span> <span class="n">a</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è¯¡å¼‚çš„ç»“æœ">è¯¡å¼‚çš„ç»“æœ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ volatile boolean ready = false; å¯ä»¥é˜²æ­¢å˜é‡ä¹‹å‰çš„ä»£ç è¢«é‡æ’åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">boolean</span> <span class="n">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šä»£ç  r1 ä¼šæœ‰å‡ ç§ç»“æœ</p>
<ul>
<li>ç»“æœä¸€ï¼šå…ˆæ‰§è¡Œçº¿ç¨‹2çš„actor2æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œæ‰§è¡Œçº¿ç¨‹1ï¼Œæœ€åç­”æ¡ˆä¸º4</li>
<li>ç»“æœäºŒï¼šå…ˆæ‰§è¡Œactor1æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œç­”æ¡ˆä¸º1</li>
<li><strong>ç»“æœä¸‰</strong>ï¼šå› ä¸ºé‡æ’åºçš„åŸå› ï¼Œä½¿å¾—readyå’Œnumçš„ä»£ç æ‰§è¡Œé¡ºåºå€’è½¬ï¼Œä½¿å¾—ready = trueå…ˆæ‰§è¡Œï¼Œä»è€Œå¯¼è‡´ç­”æ¡ˆä¸º0</li>
</ul>
<h5 id="è§£å†³">è§£å†³ï¼š</h5>
<p>å¯¹readyå˜é‡åŠ ä¸€ä¸ªvolatileï¼Œä½¿å¾—é‡æ’åºé—®é¢˜è§£å†³</p>
<h3 id="94-volatile-åŸç†">9.4 volatile åŸç†</h3>
<p><strong>volatileçš„åº•å±‚åŸç†æ˜¯å†…å­˜å±éšœ</strong></p>
<ul>
<li>è¯»å±éšœï¼šå¯¹volatileå˜é‡æ‰§è¡Œè¯»æŒ‡ä»¤ä¼šæ·»åŠ è¯»å±éšœ</li>
<li>å†™å±éšœï¼šå¯¹volatileå˜é‡æ‰§è¡Œå†™æŒ‡ä»¤ä¼šæ·»åŠ å†™å±éšœ</li>
</ul>
<h4 id="å¦‚ä½•ä¿è¯å¯è§æ€§">å¦‚ä½•ä¿è¯å¯è§æ€§</h4>
<p><strong>å†™å±éšœï¼š</strong> <strong>åœ¨è¯¥å±éšœä¹‹å‰</strong>ï¼Œå¯¹åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­ï¼Œå°†ä¿®æ”¹çš„æ•°æ®ä¿®æ”¹è‡³ä¸»å­˜å½“ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//ready æ˜¯ volatileèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å†™å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¯»å±éšœï¼šåœ¨è¯¥å±éšœä¹‹å</strong>ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼Œä¼šåœ¨ä¸»å­˜å½“ä¸­å»è¯»å–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¯»å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402174335491.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402174335491"
	
	
></p>
<h4 id="å¦‚ä½•ä¿è¯æœ‰åºæ€§">å¦‚ä½•ä¿è¯æœ‰åºæ€§</h4>
<p><strong>å†™å±éšœï¼šåœ¨è¯¥å±éšœä¹‹å‰çš„ä»£ç ä¸ä¼šæ’åœ¨å†™å±éšœä¹‹å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//ready æ˜¯ volatileèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å†™å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¯»å±éšœï¼šåœ¨è¯¥å±éšœä¹‹åçš„ä»£ç ä¸ä¼šæ’åœ¨è¯»å±éšœä¹‹å‰</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¯»å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402175426307.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402175426307"
	
	
></p>
<h5 id="volatileè™½ç„¶èƒ½è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§ä½†æ˜¯æ— æ³•è§£å†³åŸå­æ€§ä¹Ÿå°±æ˜¯æŒ‡ä»¤äº¤é”™">volatileè™½ç„¶èƒ½è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä½†æ˜¯æ— æ³•è§£å†³åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä»¤äº¤é”™</h5>
<ul>
<li>å†™æ“ä½œèƒ½ä¿è¯ï¼Œä¸»å­˜ä¸­æ›´æ–°æœ€æ–°çš„æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯ï¼Œè¯»æŒ‡ä»¤åœ¨å†™æ“ä½œä¹‹å‰å‘ç”Ÿ</li>
<li>æœ‰åºæ€§ä¹Ÿåªèƒ½ä¿è¯åœ¨æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ–°æ’åº</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402175746518.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402175746518"
	
	
></p>
<h4 id="double-checked-locking-é—®é¢˜">double-checked locking é—®é¢˜</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šå®ç°çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ‡’æƒ°å®ä¾‹åŒ–</li>
<li>åˆ©ç”¨synchronizedå¯¹getInstanceåŠ é”ï¼Œé˜²æ­¢çº¿ç¨‹å¯è§æ€§é—®é¢˜</li>
</ul>
<blockquote>
<p>**é—®é¢˜ï¼š**è™½è¯´ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œä¿è¯å®ä¾‹å¯¹è±¡åªä¼šç”Ÿæˆä¸€ä¸ªï¼Œä½†æ˜¯åœ¨å•ä¾‹å¯¹è±¡ç”Ÿæˆåï¼Œæˆ‘å°±ä¸éœ€è¦å¯¹å…¶åŠ ä¸Šçº¿ç¨‹å®‰å…¨é”äº†ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨getInstanceæ–¹æ³•éƒ½ä¼šè¦ä¸Šé”ï¼Œä¼šå¯¼è‡´æ€§èƒ½é™ä½</p>
</blockquote>
<p><strong>äºæ˜¯å°±æœ‰äº†è‘—åçš„ double-checked lockingå•ä¾‹æ¨¡å¼</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">       <span class="kd">synchronized</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> 
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥åŠ é”ï¼Œä¹‹åä½¿ç”¨ä¸ä¼šä½¿ç”¨synchronized</p>
</blockquote>
<p><strong>ä¸Šè¿°ä»£ç çœ‹ä¼¼å®Œç¾ï¼Œä½†ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„</strong></p>
<h5 id="getinstanceå­—èŠ‚ç ">getInstance()å­—èŠ‚ç </h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">JUC</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Singleton</span> <span class="nf">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">       <span class="n">0</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">3</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="n">37</span>
</span></span><span class="line"><span class="cl">       <span class="n">6</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="n">3</span>                  <span class="c1">// class JUC/model/Singleton åŠ é”è·å¾—ç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">8</span><span class="o">:</span> <span class="n">dup</span>                               <span class="c1">//ç±»å¯¹è±¡å¼•ç”¨æŒ‡é’ˆå¤åˆ¶ä¸€ä»½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">9</span><span class="o">:</span> <span class="n">astore_0</span>                          <span class="c1">//å­˜å‚¨ä¸€ä»½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">10</span><span class="o">:</span> <span class="n">monitorenter</span>
</span></span><span class="line"><span class="cl">      <span class="n">11</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">14</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="n">27</span>
</span></span><span class="line"><span class="cl">      <span class="n">17</span><span class="o">:</span> <span class="k">new</span>           <span class="err">#</span><span class="n">3</span>                  <span class="c1">// class JUC/model/Singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">20</span><span class="o">:</span> <span class="n">dup</span>
</span></span><span class="line"><span class="cl">      <span class="n">21</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="err">#</span><span class="n">4</span>                  <span class="c1">// Method &#34;&lt;init&gt;&#34;:()V
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">24</span><span class="o">:</span> <span class="n">putstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">27</span><span class="o">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">      <span class="n">28</span><span class="o">:</span> <span class="n">monitorexit</span>
</span></span><span class="line"><span class="cl">      <span class="n">29</span><span class="o">:</span> <span class="k">goto</span>          <span class="n">37</span>
</span></span><span class="line"><span class="cl">      <span class="n">32</span><span class="o">:</span> <span class="n">astore_1</span>
</span></span><span class="line"><span class="cl">      <span class="n">33</span><span class="o">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">      <span class="n">34</span><span class="o">:</span> <span class="n">monitorexit</span>
</span></span><span class="line"><span class="cl">      <span class="n">35</span><span class="o">:</span> <span class="n">aload_1</span>
</span></span><span class="line"><span class="cl">      <span class="n">36</span><span class="o">:</span> <span class="n">athrow</span>
</span></span><span class="line"><span class="cl">      <span class="n">37</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">40</span><span class="o">:</span> <span class="n">areturn</span>
</span></span><span class="line"><span class="cl">    <span class="n">Exception</span> <span class="n">table</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">       <span class="n">from</span>    <span class="n">to</span>  <span class="n">target</span> <span class="n">type</span>
</span></span><span class="line"><span class="cl">          <span class="n">11</span>    <span class="n">29</span>    <span class="n">32</span>   <span class="n">any</span>
</span></span><span class="line"><span class="cl">          <span class="n">32</span>    <span class="n">35</span>    <span class="n">32</span>   <span class="n">any</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>17ï¼šnewä¸€ä¸ªå¯¹è±¡å¼•ç”¨</li>
<li>20ï¼šå¤åˆ¶è¯¥å¯¹è±¡å¼•ç”¨</li>
<li>21ï¼šè°ƒç”¨æ„é€ æ–¹æ³•</li>
<li>24ï¼šå°†å¼•ç”¨æ”¾å…¥é™æ€å˜é‡ä¸­</li>
</ul>
<blockquote>
<p><strong>æ­¤æ—¶ é—®é¢˜æ¥äº† ç”±äºjvmä¼˜åŒ–çš„ç»“æœï¼Œä¼šå¯¼è‡´21è¡ŒæŒ‡ä»¤å’Œ24è¡ŒæŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œè™½ç„¶æ˜¯åœ¨synchronizedé‡Œé¢ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªifè¯­å¥æ˜¯ä¸åŒ…å«åœ¨synchronizedè¯­å¥ä¸­çš„ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°t2åœ¨INSTANCEè¿˜æ²¡åˆå§‹åŒ–ï¼Œå°±è¢«è¿”å›ä¸€ä¸ªNULLå€¼ã€‚</strong></p>
</blockquote>
<p>#<strong>æ³¨</strong>ï¼šè™½ç„¶synchronizedèƒ½ä¿è¯æœ‰åºæ€§ï¼Œä½†æ˜¯æ— æ³•æ”¹å˜JVMçš„æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402183416400.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402183416400"
	
	
></p>
<h5 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h5>
<p>å¯¹INSTANCEåŠ ä¸Švolatileå˜é‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public static JUC.model.Singleton getInstance();
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">    // ----------------------------------------------------&gt; åŠ å…¥å¯¹INSTANCEå˜é‡çš„è¯»å±éšœ
</span></span><span class="line"><span class="cl">       0: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">       3: ifnonnull     37
</span></span><span class="line"><span class="cl">       6: ldc           #3                  // class JUC/model/Singleton åŠ é”è·å¾—ç±»å¯¹è±¡
</span></span><span class="line"><span class="cl">       8: dup                               //ç±»å¯¹è±¡å¼•ç”¨æŒ‡é’ˆå¤åˆ¶ä¸€ä»½
</span></span><span class="line"><span class="cl">       9: astore_0                          //å­˜å‚¨ä¸€ä»½
</span></span><span class="line"><span class="cl">      10: monitorenter -----------------------&gt; ä¿è¯åŸå­æ€§ï¼Œå¯è§æ€§
</span></span><span class="line"><span class="cl">      11: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      14: ifnonnull     27
</span></span><span class="line"><span class="cl">      17: new           #3                  // class JUC/model/Singleton
</span></span><span class="line"><span class="cl">      20: dup
</span></span><span class="line"><span class="cl">      21: invokespecial #4                  // Method &#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">      24: putstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      //--------------------------------------&gt; åŠ å…¥INSTANCEå˜é‡çš„å†™å±éšœ
</span></span><span class="line"><span class="cl">      27: aload_0
</span></span><span class="line"><span class="cl">      28: monitorexit
</span></span><span class="line"><span class="cl">      29: goto          37
</span></span><span class="line"><span class="cl">      32: astore_1
</span></span><span class="line"><span class="cl">      33: aload_0
</span></span><span class="line"><span class="cl">      34: monitorexit
</span></span><span class="line"><span class="cl">      35: aload_1
</span></span><span class="line"><span class="cl">      36: athrow
</span></span><span class="line"><span class="cl">      37: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      40: areturn
</span></span><span class="line"><span class="cl">    Exception table:
</span></span><span class="line"><span class="cl">       from    to  target type
</span></span><span class="line"><span class="cl">          11    29    32   any
</span></span><span class="line"><span class="cl">          32    35    32   any
</span></span></code></pre></td></tr></table>
</div>
</div><p>**æƒ…å†µ1ï¼š**t2 getstatic() è·å–çš„æ˜¯ç©ºå€¼NULLæ­¤æ—¶ä¼šè¿›å…¥synchronizedï¼Œä½†ç”±äºAå·²ç»åŠ é”ï¼Œä¼šä½¿å¾—t2é”ä½ï¼Œç›´åˆ°Aè§£é”ï¼Œæ­¤æ—¶INSTANCEå·²ç»èµ‹å€¼äº†ï¼Œt2è·å–æœ€æ–°çš„INSTANCEå¹¶ä¸”è¿”å›</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402190134854.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402190134854"
	
	
></p>
<p>**æƒ…å†µ2ï¼š**æ­¤æ—¶çš„putstaticä¸ä¼šåœ¨invokespecialçš„å‰é¢ï¼Œå°±ä¸ä¼šå‡ºç°å…ˆèµ‹å€¼ï¼Œå†æ„é€ çš„æƒ…å†µäº†</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402190341247.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402190341247"
	
	
></p>
<h4 id="happens-before">happens-before</h4>
<p>happens-beforeè§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶ä»–çš„çº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹happens-beforeè§„åˆ™ï¼ŒJMMå¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§</p>
<ul>
<li>çº¿ç¨‹è§£é”mä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹måŠ é”çš„å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191318405.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191318405"
	
	
></p>
<ul>
<li>çº¿ç¨‹å¯¹volatileå˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹å˜é‡çš„è¯»å¯è§</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191508935.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191508935"
	
	
></p>
<ul>
<li>çº¿ç¨‹startå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191615128.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191615128"
	
	
></p>
<ul>
<li>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¾—çŸ¥ä»–ç»“æŸåçš„è¯»å¯è§(æ¯”å¦‚å…¶ä»–çº¿ç¨‹è°ƒç”¨t1,isAlive()ï¼Œt1.join()ç­‰å¾…ä»–ç»“æŸ)</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191728776.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191728776"
	
	
></p>
<ul>
<li>çº¿ç¨‹t1æ‰“æ–­t2å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥t2è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§(é€šè¿‡t2.interruptedæˆ–t2.isInterrupted)</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191935840.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191935840"
	
	
></p>
<ul>
<li>
<p>å¯¹å˜é‡é»˜è®¤å€¼çš„å†™(0ï¼Œfalseï¼Œnull)ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡å¯è§</p>
</li>
<li>
<p>å…·æœ‰ä¼ é€’æ€§ï¼Œç”±äºå†™å±éšœä¼šå°†å†™å±éšœä¹‹å‰çš„èµ‹å€¼éƒ½åŒæ­¥åˆ°ä¸»å­˜ä¸­ï¼Œæ‰€ä»¥</p>
</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402192753344.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402192753344"
	
	
></p>
<h3 id="95-çº¿ç¨‹å®‰å…¨å•ä¾‹">9.5 çº¿ç¨‹å®‰å…¨å•ä¾‹</h3>
<p>å•ä¾‹æ¨¡å¼æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œé¥¿æ±‰ï¼Œæ‡’æ±‰ï¼Œé™æ€å†…éƒ¨ç±»ï¼Œæšä¸¾ç±»</p>
<blockquote>
<p>æ‡’æ±‰å¼ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•ä¾‹å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šè¢«åˆ›å»º</p>
<p>é¥¿æ±‰å¼ï¼šç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•ä¾‹å¯¹è±¡è¢«åˆ›å»º</p>
</blockquote>
<h5 id="å®ç°1"><strong>å®ç°1ï¼š</strong></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ final
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜2ï¼šå¦‚æœå®ç°åºåˆ—åŒ–æ¥å£ï¼Œè¿˜éœ€è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Singleton2</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®æœªç§æœ‰ï¼Ÿæ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="nf">Singleton2</span><span class="o">(){}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//é—®é¢˜4ï¼šè¿™ä¹Ÿåˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Singleton2</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæé«˜é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°†INSTANCEè®¾ç½®æœªpublic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton2</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>é—®é¢˜1ï¼šé˜²æ­¢å­ç±»ç»§æ‰¿ï¼Œæ›´æ”¹æ–¹æ³•å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨</p>
<p>é—®é¢˜2ï¼šç”±äºååºåˆ—åŒ–ä¼šåˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡å†™readResovleæ¥è¿”å›åŸæœ¬çš„å•ä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">readResovle</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">INSTANCE</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é—®é¢˜3ï¼šä¸è®©å¤–ç•Œå¯¹è±¡è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œç ´åå•ä¾‹æ¨¡å¼ï¼Œä¸èƒ½é˜²æ­¢åå°„</p>
<p>é—®é¢˜4ï¼šé™æ€æˆå‘˜å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨ç±»åŠ è½½é˜¶æ®µå®Œæˆçš„ï¼Œç”±JVMå®Œæˆï¼Œä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<p>é—®é¢˜5ï¼šåˆ©ç”¨æ–¹æ³• å¯ä»¥å¯¹å•ä¾‹å¯¹è±¡æœ‰æ›´å¤šæ§åˆ¶ï¼Œç”¨æ–¹æ³•å¯ä»¥è¿”å›æ³›å‹ï¼Œè¿˜å¯ä»¥å®ç°ä¸€ä¸ªæ‡’æƒ°å¼çš„åŠ è½½</p>
</blockquote>
<h5 id="å®ç°2">å®ç°2ï¼š</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜2ï¼šæšä¸¾å•ä¾‹æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜3ï¼šæšä¸¾å•ä¾‹æ˜¯å¦èƒ½è¢«åå°„ç ´åå•ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜4ï¼šæšä¸¾å•ä¾‹æ˜¯å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼
</span></span></span><span class="line"><span class="cl"><span class="c1">//é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘åº”è¯¥å¦‚ä½•åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">enum</span> <span class="n">Singleton</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æšä¸¾å˜é‡å­—èŠ‚ç æ–‡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">enum</span> <span class="n">JUC</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">SingletonEnum</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Enum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// compiled from: SingletonEnum.java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// access flags 0x4019
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">LJUC</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">SingletonEnum</span><span class="o">;</span> <span class="n">INSTANCE</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>é—®é¢˜1ï¼šåˆ›å»ºäº†å¤šå°‘ä¸ªæšä¸¾ç±»å‹ï¼Œå°±æœ‰å¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡</p>
<p>é—®é¢˜2ï¼šæ— å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºæ˜¯é™æ€å˜é‡</p>
<p>é—®é¢˜3ï¼šæšä¸¾ç±»å‹æ— æ³•ç”¨åå°„ç ´åå•ä¾‹</p>
<p>é—®é¢˜4ï¼šæšä¸¾ç±»å‹é»˜è®¤å®ç°äº†åºåˆ—åŒ–ï¼Œä¸ä¼šè¢«ååºåˆ—ç ´åå•ä¾‹</p>
<p>é—®é¢˜5ï¼šé¥¿æ±‰å¼</p>
<p>é—®é¢˜6ï¼šå†æšä¸¾ç±»é‡Œé¢å¯ä»¥åŠ ä¸€äº›æ„é€ æ–¹æ³•</p>
</blockquote>
<h5 id="å®ç°3">å®ç°3ï¼š</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å®ç°4">å®ç°4ï¼š</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonStatic</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">SingletonStatic</span><span class="o">(){</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LazyHolder</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="kd">final</span> <span class="n">SingletonStatic</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonStatic</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonStatic</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">LazyHolder</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-ä¿æŠ¤å…±äº«èµ„æº-æ— é”å®ç°">10 ä¿æŠ¤å…±äº«èµ„æº-æ— é”å®ç°</h2>
<h3 id="101-atomicinteger">10.1 AtomicInteger</h3>
<h5 id="account-æ¥å£">Account æ¥å£</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">account</span><span class="o">.</span><span class="na">withdraw</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">()+</span><span class="s">&#34; cost:&#34;</span><span class="o">+(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">)/</span><span class="n">1000_000</span><span class="o">+</span><span class="s">&#34; ms&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æœ‰é”æŠ€æœ¯å®ç°èµ„æºå…±äº«">æœ‰é”æŠ€æœ¯å®ç°èµ„æºå…±äº«</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AccountUnsafe</span> <span class="kd">implements</span> <span class="n">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AccountUnsafe</span><span class="o">(</span><span class="kt">int</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">-=</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ— æ‰€æŠ€æœ¯å®ç°èµ„æºå…±äº«">æ— æ‰€æŠ€æœ¯å®ç°èµ„æºå…±äº«</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AccountCas</span> <span class="kd">implements</span> <span class="n">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AccountCas</span><span class="o">(</span><span class="kt">int</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">balance</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">prev</span><span class="o">-</span><span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="n">next</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç»“æœæ¯”è¾ƒ">ç»“æœæ¯”è¾ƒ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0 cost:107 ms //Unsafe
</span></span><span class="line"><span class="cl">0 cost:105 ms //AtomicInteger
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Process finished with exit code 0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="102-casä¸volatile">10.2 CASä¸volatile</h3>
<h4 id="ä¸ºä»€ä¹ˆ-compareandset-å¯ä»¥å®ç°ä¸åŠ é”ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜">ä¸ºä»€ä¹ˆ compareAndSet å¯ä»¥å®ç°ä¸åŠ é”ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</h4>
<blockquote>
<p>compareAndSet åˆç®€ç§°ä¸ºCASï¼Œç”±äºä»–æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220422214037388.png"
	
	
	
	loading="lazy"
	
		alt="image-20220422214037388"
	
	
></p>
<h5 id="æµç¨‹è§£æ">æµç¨‹è§£æ</h5>
<ul>
<li>çº¿ç¨‹1è·å– ä½™é¢ 100 å¹¶ä¸” å‡å°‘10 æ­¤æ—¶çš„å€¼ä¸º90</li>
<li>æ­¤æ—¶çº¿ç¨‹2 å·²ç»å°†ä½™é¢å˜ä¸ºäº† 90</li>
<li>çº¿ç¨‹1åˆ©ç”¨cas(100,90)å»æ¯”è¾ƒï¼Œå‘ç°æ­¤æ—¶çš„balance ä¸º 90 å’Œ 100ä¸ç¬¦åˆäºæ˜¯è¿”å›false</li>
<li>çº¿ç¨‹1é‡æ–°è·å¾—ä½™é¢å€¼</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>å…¶å®CASçš„åº•å±‚æ˜¯lock cmpxchgæŒ‡ä»¤(x86æ¶æ„)ï¼Œåœ¨å•æ ¸CPUå’Œå¤šæ ¸CPUéƒ½èƒ½ä¿è¯ã€æ¯”è¾ƒ-äº¤æ¢ã€‘çš„åŸå­æ€§</p>
<ul>
<li><strong>åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPUä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæˆæ—¶ï¼Œæ‰å¼€å¯æ€»çº¿</strong>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«è¿›ç¨‹è°ƒåº¦æœºåˆ¶æ‰€ç»™æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼ŒåŸå­æ€§</li>
</ul>
</blockquote>
<h4 id="volatile-ä¸-casä¹‹é—´çš„å…³ç³»">volatile ä¸ CASä¹‹é—´çš„å…³ç³»</h4>
<p>ç”±äºCASæ“ä½œå¿…é¡»è¦è¯»å–å½“å‰çš„æœ€æ–°å€¼ï¼Œæ‰€ä»¥å¿…é¡»è¦å°†å½“å‰çš„å€¼åŒæ­¥åˆ°ä¸»å­˜ï¼Œæ‰èƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œæ‰€ä»¥åœ¨AtomicIntegerä¸­çš„valueæ˜¯è¢«volatileè¿›è¡Œä¿®é¥°çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicInteger</span> <span class="kd">extends</span> <span class="n">Number</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">6214790243416807050L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// setup to use Unsafe.compareAndSwapInt for updates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">valueOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">AtomicInteger</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜">ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜ï¼Ÿ</h4>
<ul>
<li>æ— é”æƒ…å†µä¸‹ï¼Œçº¿ç¨‹åœ¨é«˜é€Ÿè¿è¡Œï¼Œæ— åœæ­‡ã€‚è€ŒåŠ é”çš„çº¿ç¨‹ï¼Œä¼šå› ä¸ºè¿›å…¥ä¸´ç•ŒåŒºåŸŸï¼Œåœä¸‹æ¥ï¼Œä¸”å†æ¬¡å¯åŠ¨éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¼šå¯¼è‡´æ€§èƒ½ä»£ä»·æ¯”è¾ƒå¤§</li>
<li>ä½†æ˜¯æ— é”æƒ…å†µä¸‹ï¼Œä¸€æ—¦çº¿ç¨‹çš„æ•°é‡è¶…è¿‡cpuçš„æ•°é‡ï¼Œå°±ä¼šå¯¼è‡´æ— æ—¶é—´ç‰‡å¯åˆ†é…ï¼Œçº¿ç¨‹è¿˜æ˜¯è¦è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
<h4 id="casçš„ç‰¹ç‚¹">CASçš„ç‰¹ç‚¹</h4>
<p>ç»“åˆCASå’Œvolatileå¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹è¾ƒå°‘çš„ï¼Œå¤šæ ¸CPUçš„åœºæ™¯ä¸‹</p>
<ul>
<li>CASæ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ã€‚</li>
<li>synchronizedé‡‡ç”¨çš„æ˜¯æ‚²è§‚é”çš„æ€æƒ³ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ã€‚</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220422223808771.png"
	
	
	
	loading="lazy"
	
		alt="image-20220422223808771"
	
	
></p>
<h2 id="11-åŸå­">11 åŸå­</h2>
<h3 id="111-åŸå­æ•´æ•°">11.1 åŸå­æ•´æ•°</h3>
<ul>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
</ul>
<h4 id="ä¾‹atomicinteger">ä¾‹ï¼šAtomicInteger</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">());</span> <span class="c1">//i++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">());</span> <span class="c1">//++i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">updateAndGet</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">10</span><span class="o">));</span> <span class="c1">//i*10
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="updareandgetåŸç†">updareAndGetåŸç†</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">updateAndGet</span><span class="o">(</span><span class="n">IntUnaryOperator</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">prev</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span> <span class="o">=</span> <span class="n">updateFunction</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">prev</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span> <span class="n">next</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="112-åŸå­å¼•ç”¨">11.2 åŸå­å¼•ç”¨</h3>
<ul>
<li>AtomicReference</li>
<li>AtomicMarkableReference</li>
<li>AtomicStampedReference</li>
</ul>
<h4 id="abaé—®é¢˜">ABAé—®é¢˜</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomReference</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="s">&#34;A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;C {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;C&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">other</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;B {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;B&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change B-&gt;A {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;A&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å¼•ç”¨Aä¸ºAtomicReference</strong></p>
<blockquote>
<p>ä¸»çº¿ç¨‹ å°†å¼•ç”¨A æ”¹ä¸º å¼•ç”¨C</p>
<p>çº¿ç¨‹1 å°†å¼•ç”¨A æ”¹ä¸º å¼•ç”¨B</p>
<p>çº¿ç¨‹2 å°†å¼•ç”¨B æ”¹ä¸º å¼•ç”¨A</p>
<p>æ­¤æ—¶ çº¿ç¨‹1å…ˆå¯åŠ¨ï¼Œå…¶æ¬¡çº¿ç¨‹2ï¼Œå†ä¸»çº¿ç¨‹</p>
</blockquote>
<p>åœ¨å¦‚ä¸Šæƒ…å†µï¼Œä¸»çº¿ç¨‹æ— æ³•å¯Ÿè§‰åˆ°å¼•ç”¨Aè¢«æ›´æ”¹ï¼Œè™½ç„¶å†å¹³å¸¸å·¥ä½œä¸­æ— å¤§ç¢ï¼Œä½†æ˜¯æ˜¯å­˜åœ¨å®‰å…¨éšæ‚£çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨</p>
<p>AtomicStampedReferenceæ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<h4 id="atomicstampedreference">AtomicStampedReference</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomReference</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="s">&#34;A&#34;</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;C {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;C&#34;</span><span class="o">,</span><span class="n">stamp</span><span class="o">,</span><span class="n">stamp</span><span class="o">+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">other</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;B {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span><span class="s">&#34;B&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change B-&gt;A {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span><span class="s">&#34;A&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AtomicStampedReferenceå¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œç¡®å®šæ•´ä¸ªåŸå­çš„å˜åŒ–è¿‡ç¨‹</p>
<h4 id="atomicmarkablereference">AtomicMarkableReference</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220425223520696.png"
	
	
	
	loading="lazy"
	
		alt="image-20220425223520696"
	
	
></p>
<p>å¦‚æœä¸æƒ³çŸ¥é“ç‰ˆæœ¬å·ï¼Œåªæƒ³çŸ¥é“æ˜¯å¦ä¿®æ”¹ï¼Œåˆ™å¯ä»¥ç”¨AtomicMarkableReference</p>
<h3 id="113-åŸå­æ•°ç»„">11.3 åŸå­æ•°ç»„</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomArray</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">               <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">AtomicIntegerArray</span><span class="o">(</span><span class="n">10</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">               <span class="o">(</span><span class="n">array</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">               <span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="n">index</span><span class="o">)-&gt;</span><span class="n">array</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">index</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">               <span class="n">array</span><span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">array</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arraySupplier</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">lengthFun</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">putConsumer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">printConsumer</span>
</span></span><span class="line"><span class="cl">    <span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="n">array</span> <span class="o">=</span> <span class="n">arraySupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">lengthFun</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">array</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">length</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="n">10000</span> <span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">putConsumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="n">j</span><span class="o">%</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">         <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}});</span>
</span></span><span class="line"><span class="cl">        <span class="n">printConsumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">array</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="114-åŸå­æ›´æ–°å™¨">11.4 åŸå­æ›´æ–°å™¨</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.g_noLock.Atomic</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicReferenceFieldUpdater</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomFileUpdate</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Student</span> <span class="n">genius</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&#34;Genius&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AtomicReferenceFieldUpdater</span> <span class="n">updater</span> <span class="o">=</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">&#34;name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">genius</span><span class="o">,</span><span class="s">&#34;Genius&#34;</span><span class="o">,</span><span class="s">&#34;fuck&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">genius</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Student</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Student</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="115-åŸå­ç´¯åŠ å™¨">11.5 åŸå­ç´¯åŠ å™¨</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.g_noLock.Atomic</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.LongAdder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomSum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                 <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="n">0</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                 <span class="o">(</span><span class="n">adder</span><span class="o">)-&gt;</span><span class="n">adder</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">         <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">LongAdder</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">adder</span><span class="o">)-&gt;</span><span class="n">adder</span><span class="o">.</span><span class="na">increment</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">adderSupplier</span><span class="o">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="n">adder</span> <span class="o">=</span> <span class="n">adderSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="n">50000000</span> <span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">adder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">)/</span><span class="n">1000_000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>javaä¸ºç´¯åŠ æä¾›äº†ä¸“é—¨çš„ç´¯åŠ å™¨ï¼Œæ•ˆæœæ˜¯AtomicIntegerç´¯åŠ çš„åå€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Atomic_Sum cost: 19332
</span></span><span class="line"><span class="cl">LongAdder_Sum cost: 1041
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ€§èƒ½æå‡çš„åŸå› ï¼šLongAdderä¸ºæ¯ä¸€ä¸ªThreadåˆ†é…äº†ä¸€ä¸ªç´¯åŠ å•å…ƒCell[0]ï¼Œå†ç´¯åŠ çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è‡ªå·±çš„Cell[0]è¿›è¡Œæ“ä½œï¼Œç´¯åŠ ç»“æŸåå†å°†ç»“æœæ±‡æ€»ï¼Œå‡å°‘äº†CASå¤±è´¥çš„æ¬¡æ•°ï¼Œä»è€Œæå‡äº†æ•ˆç‡</p>
<h4 id="æºç ä¹‹longadder">æºç ä¹‹LongAdder</h4>
<p>LongAdderç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ç´¯åŠ å•å…ƒæ•°ç»„ï¼Œæ‡’æƒ°åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">Cell</span><span class="o">[]</span> <span class="n">cells</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åŸºç¡€å€¼ï¼Œå¦‚æœæ²¡æœ‰ç«äº‰ï¼Œåˆ™ç”¨casç´¯åŠ è¿™ä¸ªåŸŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åœ¨cells åˆ›å»ºæˆ–æ‰©å®¹æ—¶ï¼Œç½®ä¸º1ï¼Œè¡¨ç¤ºåŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">cellsBusy</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="casé”">Casé”</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CasLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CasLock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//å½“æ— äººç«äº‰æ—¶ï¼Œçº¿ç¨‹å ç”¨é”ï¼Œä¸”å°†busyæ”¹ä¸º1ï¼Œå½“å…¶ä»–çº¿ç¨‹ä½¿ç”¨è¯¥é”æ—¶ï¼Œå°†ä¼šå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//è°ƒç”¨unlock å°†busyæ”¹ä¸º0ï¼Œä½¿å…¶è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unlock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åŸç†ä¹‹ä¼ªå…±äº«">åŸç†ä¹‹ä¼ªå…±äº«</h5>
<h6 id="cellç±»">Cellç±»</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@sun.misc.Contended</span> 
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Cell</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cell</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">cas</span><span class="o">(</span><span class="kt">long</span> <span class="n">cmp</span><span class="o">,</span> <span class="kt">long</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">UNSAFE</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="n">cmp</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Unsafe mechanics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span> <span class="n">UNSAFE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">valueOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">UNSAFE</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ak</span> <span class="o">=</span> <span class="n">Cell</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueOffset</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="o">.</span><span class="na">objectFieldOffset</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">ak</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="ç¼“å­˜ä¸å†…å­˜çš„æ¯”è¾ƒ">ç¼“å­˜ä¸å†…å­˜çš„æ¯”è¾ƒ</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210009831.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210009831"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210139575.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210139575"
	
	
></p>
<p>ç”±ä¸Šå›¾å¯çŸ¥ï¼Œä½¿ç”¨ç¼“å­˜çš„åŸå› æ˜¯å› ä¸ºcpuè¯»å–å†…å­˜çš„æ—¶é—´ååˆ†é•¿ï¼Œç›¸å¯¹äºç¼“å­˜æ¥è¯´æ…¢å¾ˆå¤šã€‚</p>
<p>è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œä¸€ä¸ªç¼“å­˜è¡Œä¸€èˆ¬æ˜¯ä»¥64byteä¸ºå•ä½(8ä¸ªlong)ã€‚</p>
<p>ç¼“å­˜å¹¶ä¸æ˜¯åå…¨åç¾çš„ï¼Œç¼“å­˜ä¼šå¯¼è‡´æ•°æ®å‰¯æœ¬é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½é€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å½“ä¸€ä¸ªCPUå¯¹ç¼“å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ›´æ”¹(å¦‚äºŒçº§ç¼“å­˜)ï¼Œåˆ™å¦ä¸€ä¸ªCPUä¸­çš„äºŒçº§ç¼“å­˜çš„æ•°æ®å°±å¿…é¡»è¦å¤±æ•ˆã€‚</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210850571.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210850571"
	
	
></p>
<p>å› ä¸ºCellæ˜¯æ•°ç»„å½¢å¼ï¼Œè¿ç»­å­˜æ”¾åœ¨CPUä¸­ï¼Œä¸€ä¸ªCellå•ä½æ˜¯24å­—èŠ‚(16byteå¯¹è±¡å¤´+8byte long)ï¼ŒCell[0]å’ŒCell[1]ä¸¤ä¸ªç¼“å­˜è¡Œçš„æ•°æ®å¤§å°æ˜¯48ï¼Œå¯ä»¥å­˜æ”¾åœ¨ä¸€ä¸ª<strong>ç¼“å­˜è¡Œ</strong>ä¸­ï¼Œæ­¤æ—¶é—®é¢˜æ¥äº†ï¼š</p>
<ul>
<li>Core-0 ä¿®æ”¹Cell[0]</li>
<li>Core-1 ä¿®æ”¹Cell[1]</li>
</ul>
<p>æ­¤æ—¶ä¸ç®¡æ˜¯è°ä¿®æ”¹äº†Cellï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œå¯¼è‡´Cpu-Coreéœ€è¦é‡æ–°åˆ°å†…å­˜ä¸­å»å¯»æ‰¾æ•°æ®ï¼Œå¤§å¤§é™ä½äº†è¯»å–æ•ˆç‡</p>
<p>@sun.misc.Contended æ­¤æ—¶è¯¥æ³¨è§£å°±èƒ½å‘æŒ¥æ•ˆæœäº†ï¼Œjavaå¯¹æ ‡æ³¨è¯¥æ³¨è§£çš„å¯¹è±¡è¿›è¡Œpaddingå¡«å……ï¼Œå°†<strong>128byte</strong>å¡«å……åœ¨å¯¹è±¡åé¢ï¼Œè¿™ä¸ªæ—¶å€™å°±èƒ½ä½¿å¯¹è±¡ä¸å ç”¨åŒä¸€ç¼“å­˜è¡Œäº†</p>
<blockquote>
<p>**æ³¨ï¼š**ä¸ºä»€ä¹ˆæ˜¯128byteå‘¢ï¼Œå› ä¸ºç¼“å­˜è¡Œçš„å¤§å°åœ¨ 32~256ä¹‹é—´ï¼Œ128å¯ä»¥ä¿è¯åªèƒ½æ”¾ä¸‹ä¸€ä¸ªç¼“å­˜è¡Œ</p>
</blockquote>
<h5 id="addæ–¹æ³•">addæ–¹æ³•</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428085137816.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428085137816"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span> <span class="kt">long</span> <span class="n">b</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span> <span class="n">Cell</span> <span class="n">a</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">casBase</span><span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">uncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">getProbe</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">!(</span><span class="n">uncontended</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">cas</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">longAccumulate</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">uncontended</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="longaccumlateæ–¹æ³•">longAccumlateæ–¹æ³•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">longAccumulate</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">,</span> <span class="n">LongBinaryOperator</span> <span class="n">fn</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">boolean</span> <span class="n">wasUncontended</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">getProbe</span><span class="o">())</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span> <span class="c1">// force initialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">h</span> <span class="o">=</span> <span class="n">getProbe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                <span class="c1">// True if last slot nonempty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span> <span class="n">Cell</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span> <span class="kt">long</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å·²ç»åˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//åœ¨æ— é”çŠ¶æ€ä¸‹é”æ˜¯å¦ä¸ºç©ºï¼Œä¸”æ§½æ˜¯å¦è¢«å ç”¨ï¼Œä¸ä¸ºç©ºä¸”æ²¡è¢«å ç”¨è¿›å…¥ä¸‹ä¸€å±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>       <span class="c1">// Try to attach new Cell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Cell</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>   <span class="c1">// Optimistically create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//åœ¨æœ‰é”çŠ¶æ€ä¸‹é”æ˜¯å¦ä¸ºç©ºï¼Œä¸”æ§½æ˜¯å¦è¢«å ç”¨ï¼Œä¸ä¸ºç©ºåˆ™åˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">boolean</span> <span class="n">created</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>               <span class="c1">// Recheck under lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                <span class="n">rs</span><span class="o">[</span><span class="n">j</span> <span class="o">=</span> <span class="o">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">rs</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                                <span class="n">created</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">created</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="o">;</span>           <span class="c1">// Slot is now non-empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">wasUncontended</span><span class="o">)</span>       <span class="c1">// CAS already known to fail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>      <span class="c1">// Continue after rehash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//æ§½ä½ä¸ä¸ºç©ºåˆ™è¿›è¡Œç´¯åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">cas</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="o">((</span><span class="n">fn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">fn</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">x</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ç´¯åŠ å¤±è´¥ï¼Œåˆ™çœ‹çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡CPUçš„æ ¸å¿ƒæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">NCPU</span> <span class="o">||</span> <span class="n">cells</span> <span class="o">!=</span> <span class="n">as</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>            <span class="c1">// At max size or stale
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">collide</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//æœªè¶…è¿‡CPUçš„æ ¸å¿ƒæ•°ï¼Œåˆ™è¿›è¡Œæ‰©å®¹ï¼Œå¹¶ä¸”åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// Expand table unless stale
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">[</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">rs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>                   <span class="c1">// Retry with expanded table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„æ§½ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">h</span> <span class="o">=</span> <span class="n">advanceProbe</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æœªåˆ›å»ºï¼ŒæœªåŠ é”ï¼Œä¸å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">cells</span> <span class="o">==</span> <span class="n">as</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>                           <span class="c1">// Initialize table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">[</span><span class="n">2</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rs</span><span class="o">[</span><span class="n">h</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">init</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">init</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åŠ é”å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">casBase</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="o">((</span><span class="n">fn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">fn</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">x</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>                          <span class="c1">// Fall back on using base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="cellæœªå­˜åœ¨">Cellæœªå­˜åœ¨</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428090016999.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428090016999"
	
	
></p>
<h6 id="cellå­˜åœ¨æœªåˆ›å»º">Cellå­˜åœ¨æœªåˆ›å»º</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428090622030.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428090622030"
	
	
></p>
<h6 id="cellå­˜åœ¨å·²åˆ›å»º">Cellå­˜åœ¨å·²åˆ›å»º</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428092151435.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428092151435"
	
	
></p>
<h3 id="116-unsafe">11.6 Unsafe</h3>
<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>
<p>Unsafeå¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafeå¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">unsafeTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span><span class="n">IllegalAccessException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">theUnsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">theUnsafe</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span><span class="n">theUnsafe</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="unsafe-casæ“ä½œ">Unsafe CASæ“ä½œ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span><span class="n">IllegalAccessException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">theUnsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">theUnsafe</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span><span class="n">theUnsafe</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1 è·å–åç§»åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">idOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">Teacher</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">nameOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">Teacher</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">idOffset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Teacher</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Teacher</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2 è¿›è¡ŒCASæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unsafe</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">t</span><span class="o">,</span><span class="n">idOffset</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsafe</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">t</span><span class="o">,</span><span class="n">nameOffset</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="s">&#34;Genius&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-ä¸å¯å˜ç±»">12 ä¸å¯å˜ç±»</h2>
<h3 id="121-ä¸å¯å˜ç±»çš„è®¾è®¡">12.1 ä¸å¯å˜ç±»çš„è®¾è®¡</h3>
<p>**å®šä¹‰ï¼š**ä¸å¯å˜ç±»æŒ‡çš„æ˜¯ï¼Œè¯¥ç±»åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå› ä¸ºå…¶ä»–çº¿ç¨‹å‚ä¸ï¼Œå¯¼è‡´ç±»çš„å†…éƒ¨å±æ€§é­åˆ°ç¯¡æ”¹ï¼Œè€Œå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<p>**ä¾‹å­ï¼š**String ç±»æ˜¯å¤§å®¶ç†ŸçŸ¥çš„ä¸å¯å˜ç±»ï¼Œæˆ‘ä»¬å€Ÿæ­¤æ¥çœ‹çœ‹ä¸å¯å˜ç±»è®¾è®¡çš„è¦ç´ </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">String</span>
</span></span><span class="line"><span class="cl">    <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">,</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">CharSequence</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** The value is used for character storage. */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">char</span> <span class="n">value</span><span class="o">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** Cache the hash code for the string */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span> <span class="c1">// Default to 0
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1-finalçš„ä½¿ç”¨">1. finalçš„ä½¿ç”¨</h4>
<p>åœ¨ä¸å¯å˜ç±»ä¸­ï¼Œå¤§éƒ¨åˆ†çš„å±æ€§ï¼Œæ–¹æ³•ï¼Œç±»éƒ½æœ‰åŠ ä¸Šfinalå‰ç¼€</p>
<ul>
<li>finalä¿®é¥°ä¿è¯è¯¥å˜é‡ä¸ºå¯è¯»ï¼Œä¸å¯ä¿®é¥°</li>
<li>finalä¿®é¥°ç±»ï¼Œé˜²æ­¢å­ç±»ç»§æ‰¿è¦†ç›–çˆ¶ç±»æ–¹æ³•ï¼Œå¯¼è‡´çˆ¶ç±»ä¸å¯å˜æ€§é­åˆ°ç ´å</li>
</ul>
<h4 id="2ä¿æŠ¤æ€§æ‹·è´">2.ä¿æŠ¤æ€§æ‹·è´</h4>
<p>å½“é‡åˆ°ä¸€äº›å­—ç¬¦ä¸²ä¿®æ”¹é—®é¢˜æ—¶ï¼Œå°±ä¼šå¯¹åŸå…ˆçš„å­—ç¬¦ä¸²æ•°ç»„è¿›è¡Œæ‹·è´ï¼Œåœ¨æ‹·è´çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">substring</span><span class="o">(</span><span class="kt">int</span> <span class="n">beginIndex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">beginIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">subLen</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">beginIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">subLen</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">beginIndex</span><span class="o">,</span> <span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="122-äº«å…ƒæ¨¡å¼">12.2 äº«å…ƒæ¨¡å¼</h3>
<p>é€šè¿‡ä¸å¯å˜ç±»çš„æ‹·è´æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯æ¬¡ä¿®æ”¹å­—ç¬¦ä¸²éƒ½è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œä»è€Œå¯¼è‡´è¿‡å¤šçš„å†…å­˜æµªè´¹ï¼Œ<strong>è€Œäº«å…ƒæ¨¡å¼å°±æ˜¯é’ˆå¯¹æœ‰é™ä¸ªæ•°çš„åŒä¸€ç±»å¯¹è±¡å¯é‡å¤ä½¿ç”¨çš„åœºæ™¯æ¥ä½¿ç”¨çš„</strong></p>
<p><strong>å¸¸è§çš„äº«å…ƒæ¨¡å¼ä¾‹å­ï¼š</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220620160018128.png"
	
	
	
	loading="lazy"
	
		alt="image-20220620160018128"
	
	
></p>
<h3 id="123-è‡ªå®šä¹‰è¿æ¥æ± ">12.3 è‡ªå®šä¹‰è¿æ¥æ± </h3>
<h4 id="è¿æ¥æ± åŠŸèƒ½">è¿æ¥æ± åŠŸèƒ½ï¼š</h4>
<blockquote>
<p>**1ï¼Œ**åœ¨è¿æ¥æ± ä¸­ä¼šæœ‰ä¸€å®šçš„å®¹é‡å¤§å°æ¥å­˜å‚¨å·²æœ‰è¿æ¥(å·²ç»å®ç°)</p>
<p>**2ï¼Œ**å½“æœ‰çº¿ç¨‹è¦è·å–è¿æ¥æ—¶ï¼Œåˆ™æŸ¥çœ‹è¿æ¥æ± ä¸­çš„æ¯ä¸ªè¿æ¥çš„çŠ¶æ€ï¼Œæœ‰ç©ºé—²å³æ‹¿èµ°ï¼Œæ²¡æœ‰ç©ºé—²åˆ™ç­‰å¾…(å·²ç»å®ç°)</p>
<p>**3ï¼Œ**è¢«ä½¿ç”¨å®Œçš„è¿æ¥ï¼Œè¦å½’å›è¿æ¥ï¼Œä¸”æ›´æ”¹çŠ¶æ€(å·²ç»å®ç°)</p>
<p>**4ï¼Œ**è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©</p>
<p>**5ï¼Œ**è¿æ¥ä¿æ´»</p>
<p>**6ï¼Œ**ç­‰å¾…è¶…æ—¶å¤„ç†</p>
<p>**7ï¼Œ**åˆ†å¸ƒå¼hash</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.h_immuteable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">JUC.g_noLock.Atomic.AtomArray</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicIntegerArray</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionPool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pool</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">100</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">getConn</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                try {
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    Thread.sleep(new Random().nextInt(1000));
</span></span></span><span class="line"><span class="cl"><span class="c1">//                }catch (InterruptedException e){
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    e.printStackTrace();
</span></span></span><span class="line"><span class="cl"><span class="c1">//                }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">pool</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span><span class="o">(</span><span class="n">topic</span><span class="o">=</span><span class="s">&#34;pool&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Pool</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">poolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">connection</span><span class="o">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicIntegerArray</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Pool</span><span class="o">(</span><span class="kt">int</span> <span class="n">poolSize</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">=</span> <span class="n">poolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="o">[</span><span class="n">poolSize</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicIntegerArray</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">poolSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GeniusConnection</span><span class="o">(</span><span class="s">&#34;connection&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConn</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;get {}&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;no connection wait&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">free</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} free&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">GeniusConnection</span> <span class="kd">implements</span> <span class="n">Connection</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GeniusConnection</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;GeniusConncetion{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;name=&#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Statement</span> <span class="nf">createStatement</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="124-finalåŸç†">12.4 finalåŸç†</h3>
<h4 id="1è®¾ç½®finalå˜é‡çš„åŸç†">1ï¼Œè®¾ç½®finalå˜é‡çš„åŸç†</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">killFinal</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å­—èŠ‚ç </strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public JUC.h_immuteable.killFinal();
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">       0: aload_0
</span></span><span class="line"><span class="cl">       1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">       4: aload_0
</span></span><span class="line"><span class="cl">       5: bipush        20
</span></span><span class="line"><span class="cl">       7: putfield      #2                  // Field a:I
</span></span><span class="line"><span class="cl">         &lt;-- å†™å±éšœ
</span></span><span class="line"><span class="cl">      10: return
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘ç°finalå˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡putfieldæŒ‡ä»¤å®Œæˆï¼Œåœ¨putfieldæŒ‡ä»¤ä¹‹åä¼šåŠ å…¥å†™å±éšœï¼Œé˜²æ­¢å‡ºç°ä¸å¯è§æ€§é—®é¢˜</p>
<h4 id="2è·å–finalå˜é‡çš„åŸç†">2ï¼Œè·å–finalå˜é‡çš„åŸç†</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">killFinal</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">+</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">21</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">useFinal</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">b</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">d</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>final static int a çš„è¯»å–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L0</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">22</span> <span class="n">L0</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BIPUSH</span> <span class="n">20</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¹¶æ²¡æœ‰ä»ç±»ä¸­å–å‡ºaå˜é‡ï¼Œè€Œæ˜¯ç›´æ¥ä»å¸¸é‡æ± å–å‡ºæ•°å­—20 æ¨å…¥æ“ä½œæ•°æ ˆï¼Œç›¸å½“äºå¤åˆ¶ä¸€ä»½æ¥è¿›è¡Œå¤„ç†(ç”±äº -128&lt;a&lt;127 æ‰€ä»¥ä¸ºBIPUSH)</p>
</li>
<li>
<p>final static int b çš„è¯»å–</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L1</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">23</span> <span class="n">L1</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LDC</span> <span class="o">-</span><span class="n">2147483648</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹     å’ŒaåŒç†ï¼Œåªæ˜¯é‡‡ç”¨çš„æ˜¯LDCçš„æ–¹å¼ä»å¸¸é‡æ± å–å‡ºï¼Œæ¨å…¥åˆ°æ ˆä¸­</p>
<ul>
<li>static int cçš„è¯»å–</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L2</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">24</span> <span class="n">L2</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">JUC</span><span class="o">/</span><span class="n">h_immuteable</span><span class="o">/</span><span class="n">killFinal</span><span class="o">.</span><span class="na">c</span> <span class="o">:</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ™®é€šå¸¸é‡çš„è¯»å–å°±å’Œfinalè¯»å–æœ‰ä¸åŒï¼Œæ˜¯ä»å˜é‡çš„ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯ä»å †ä¸­å»å¯»æ‰¾ï¼Œå–å‡ºåï¼Œå¾—åˆ°è¯¥å€¼ï¼Œ<!-- raw HTML omitted -->æ‰€ä»¥finalå˜é‡çš„è¯»å–ä¼šè¦æ¯”éfinalå˜é‡è¯»å–æ›´åŠ çš„å¿«é€Ÿ<!-- raw HTML omitted --></p>
<h2 id="13-çº¿ç¨‹æ± ">13 çº¿ç¨‹æ± </h2>
<h3 id="131-æ‰‹å†™çº¿ç¨‹æ± ">13.1 æ‰‹å†™çº¿ç¨‹æ± </h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622142058663.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622142058663"
	
	
></p>
<h4 id="1blockingqueue-é˜»å¡é˜Ÿåˆ—">1,BlockingQueue é˜»å¡é˜Ÿåˆ—</h4>
<p>å½“çº¿ç¨‹æ± ä¸­æ ¸å¿ƒè°ƒç”¨æ•°å·²æ»¡æ—¶ï¼Œåˆ™å°†è¦æ·»åŠ çš„ä»»åŠ¡ï¼Œæ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç”±äºå¤šçº¿ç¨‹æ“ä½œï¼Œ<strong>æ‰€ä»¥è¦ä¿è¯BlockingQueueæ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼Œ<strong>åŒæ—¶éœ€è¦ç”¨æ¡ä»¶æ¥ç»´æŠ¤BlockingQueueçš„æ»¡å‘˜çŠ¶æ€å’Œç©ºçŠ¶æ€</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BlockQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">deque</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Condition</span> <span class="n">fullWaitSet</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Condition</span> <span class="n">emptyWaitSet</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BlockQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span><span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nanos</span> <span class="o">=</span> <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">nanos</span><span class="o">&lt;=</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">T</span> <span class="n">element</span> <span class="o">=</span> <span class="n">deque</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å–å‡ºä»»åŠ¡ {}&#34;</span><span class="o">,</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fullWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryPut</span><span class="o">(</span><span class="n">T</span> <span class="n">task</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">rejectPolicy</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">T</span> <span class="n">element</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fullWaitSet</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ”¾å…¥ä»»åŠ¡ {}&#34;</span><span class="o">,</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2threadpool-çº¿ç¨‹æ± ">2ï¼ŒThreadPool çº¿ç¨‹æ± </h4>
<h5 id="21-æ‹’ç»ç­–ç•¥">2.1 æ‹’ç»ç­–ç•¥</h5>
<p>æ‹’ç»ç­–ç•¥å³ï¼Œå½“æ¯ä¸€ä¸ªä»»åŠ¡å·¥ä½œæ—¶é—´ååˆ†é•¿ï¼Œæ ¸å¿ƒæ•°å·²æ»¡ï¼Œä¸”é˜»å¡é˜Ÿåˆ—ä¹Ÿå·²æ»¡ï¼Œæ­¤æ—¶putçš„è¯ä¼šå¯¼è‡´BlockQueueé•¿æ—¶é—´ç­‰å¾…ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬é‡‡ç”¨æ‹’ç»ç­–ç•¥æ¥é’ˆå¯¹æ»¡å‘˜æ—¶putçš„æ“ä½œï¼Œå¹¶ä¸”å°†è¯¥æ‹’ç»ç­–ç•¥ä¸‹æ”¾ç»™è°ƒç”¨è€…å»æ‰§è¡Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">BlockQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">,</span> <span class="n">T</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>BlockQueueä¸­çš„tryput</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryPut</span><span class="o">(</span><span class="n">T</span> <span class="n">task</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejectPolicy</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="22-worker">2.2 worker</h5>
<p>workerå³çº¿ç¨‹æ± ä¸­å·¥ä½œçš„çº¿ç¨‹ï¼Œè´Ÿè´£å®Œæˆåˆ†é…ä»»åŠ¡ä»¥åŠé˜»å¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡åˆ™è®¾ç½®ä¸ºç©ºï¼Œå¹¶ä¸”å»é˜»å¡é˜Ÿåˆ—å¯»æ‰¾ä¸‹ä¸€ä¸ªä»»åŠ¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">task</span><span class="o">!=</span><span class="kc">null</span><span class="o">||(</span><span class="n">task</span><span class="o">=</span><span class="n">taskQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">timeOut</span><span class="o">,</span><span class="n">timeUnit</span><span class="o">))!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ä»»åŠ¡æ‰§è¡Œç»“æŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{}ç§»é™¤ æ²¡æœ‰ä»»åŠ¡å¯åš&#34;</span><span class="o">,</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="23-çº¿ç¨‹æ± ä»£ç ">2.3 çº¿ç¨‹æ± ä»£ç </h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GeniusThreadPool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BlockQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">taskQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">poolCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GeniusThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">poolCapacity</span><span class="o">,</span><span class="kt">int</span> <span class="n">queueCapacity</span><span class="o">,</span><span class="kt">int</span> <span class="n">timeOut</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">poolCapacity</span> <span class="o">=</span> <span class="n">poolCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeOut</span> <span class="o">=</span> <span class="n">timeOut</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeUnit</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">rejectPolicy</span> <span class="o">=</span> <span class="n">rejectPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">taskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockQueue</span><span class="o">&lt;&gt;(</span><span class="n">queueCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">()&lt;</span><span class="n">poolCapacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ·»åŠ workerå¯¹è±¡ {}&#34;</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">worker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ ¸å¿ƒå·²æ»¡ å°†task {} æ·»åŠ é˜»å¡é˜Ÿåˆ—&#34;</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">taskQueue</span><span class="o">.</span><span class="na">tryPut</span><span class="o">(</span><span class="n">task</span><span class="o">,</span><span class="n">rejectPolicy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="132-threadpoolexecutor">13.2 ThreadPoolExecutor</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622135849975.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622135849975"
	
	
></p>
<h4 id="1çº¿ç¨‹æ± çŠ¶æ€">1ï¼Œçº¿ç¨‹æ± çŠ¶æ€</h4>
<p>çº¿ç¨‹æ± çš„çŠ¶æ€ç”± int çš„é«˜3ä½ç»„æˆï¼Œä½29ä½ç»„æˆçº¿ç¨‹çš„æ•°é‡</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622140707645.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622140707645"
	
	
></p>
<p><strong>çº¿ç¨‹æ± çŠ¶æ€çš„å¤§å°ï¼šTERMINATED &gt; TIDIYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</strong></p>
<p><strong>çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ç”±åŸå­å˜é‡ctlå­˜å‚¨</strong>ï¼Œçº¿ç¨‹æ± çŠ¶æ€ä¹‹æ‰€ä»¥ç”¨è¿™ç§åˆäºŒä¸ºä¸€çš„æ–¹å¼å»å­˜å‚¨ï¼Œæ˜¯å› ä¸ºå¦‚æœåˆ†åˆ«ç”¨ä¸¤ä¸ªåŸå­å˜é‡å­˜å‚¨éœ€è¦è¿›è¡Œä¸¤æ¬¡CASï¼Œè€Œè¿™æ ·å­åªéœ€è¦æ‰§è¡Œä¸€æ¬¡CASæ“ä½œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">,</span> <span class="n">0</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">ctlOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">wc</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">wc</span><span class="o">;</span> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2æ„é€ æ–¹æ³•">2ï¼Œæ„é€ æ–¹æ³•</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å‚æ•°ä»‹ç»"><strong>å‚æ•°ä»‹ç»</strong></h5>
<blockquote>
<p>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°</p>
<p>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°</p>
<p>keepAliveTimeï¼šæ•‘æ€¥çº¿ç¨‹å­˜æ´»æ—¶é—´</p>
<p>unitï¼šæ—¶é—´å¤„ç†</p>
<p>workQueueï¼šä»»åŠ¡é˜»å¡é˜Ÿåˆ—
threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸ºçº¿ç¨‹å–åå­—</p>
<p>handlerï¼šæ‹’ç»ç­–ç•¥</p>
</blockquote>
<h5 id="æ•‘æ€¥çº¿ç¨‹">æ•‘æ€¥çº¿ç¨‹:</h5>
<p>**ä½œç”¨ï¼š**å½“æ ¸å¿ƒçº¿ç¨‹å’Œé˜»å¡çº¿ç¨‹éƒ½æ»¡äº†æ—¶ï¼Œå†æ¬¡æ·»åŠ ä»»åŠ¡javaçº¿ç¨‹æ± ä¸ä¼šå…ˆè°ƒç”¨æ‹’ç»ç­–ç•¥ï¼Œè€Œæ˜¯å…ˆå¼€è¾Ÿä¸€ä¸ªæ•‘æ€¥çº¿ç¨‹æ¥å¯¹ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœæ•‘æ€¥çº¿ç¨‹åˆ°è¾¾å®ƒæœ€å¤§å­˜æ´»æ—¶é—´ï¼Œåˆ™é”€æ¯è¯¥çº¿ç¨‹</p>
<p>**æ•‘æ€¥çº¿ç¨‹çš„æ•°é‡ï¼š**maximumPoolSize - corePoolSize</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622141300868.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622141300868"
	
	
></p>
<h5 id="æ‹’ç»ç­–ç•¥">æ‹’ç»ç­–ç•¥</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220623013619733.png"
	
	
	
	loading="lazy"
	
		alt="image-20220623013619733"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220623013216541.png"
	
	
	
	loading="lazy"
	
		alt="image-20220623013216541"
	
	
></p>
<h4 id="3å·¥å‚æ–¹æ³•æ„é€ çº¿ç¨‹æ± ">3ï¼Œå·¥å‚æ–¹æ³•æ„é€ çº¿ç¨‹æ± </h4>
<ul>
<li><strong>newFixThreadPool</strong> å›ºå®šå¤§å°çº¿ç¨‹æ± </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ï¼Œæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹</p>
<p>2ï¼Œé˜»å¡é˜Ÿåˆ—æœªè®¾ç½®å¤§å°ï¼Œå¤§å°â€œæ— é™â€</p>
<p>3ï¼Œé€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œä»»åŠ¡é‡å¤§çš„çº¿ç¨‹</p>
</blockquote>
<ul>
<li><strong>newCachedThreadPool</strong> å¸¦ç¼“å†²çš„çº¿ç¨‹æ± </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">60L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ï¼Œå¯ä»¥æ— é™æ¬¡åˆ›å»ºçº¿ç¨‹ï¼Œä¸”æ ¸å¿ƒçº¿ç¨‹ä¸º0ï¼Œåˆ™ä»£è¡¨æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼Œä¸”å­˜æ´»æ—¶é—´ä¸º60ç§’</p>
<p>2ï¼ŒSynchronousQueueé˜Ÿåˆ—çš„å®¹é‡ä¸º0ï¼Œåªæœ‰åœ¨æœ‰çº¿ç¨‹å–ä»»åŠ¡çš„æ—¶å€™ï¼Œæ‰èƒ½æ”¾å…¥ä»»åŠ¡ï¼Œç›¸å½“äºä¸€æ‰‹äº¤é’±ï¼Œä¸€æ‰‹äº¤è´§(åº•å±‚é‡‡ç”¨Park/unParkå®ç°)</p>
<p>3ï¼Œé€‚ç”¨äºä»»åŠ¡é‡åºå¤§ï¼Œä¸”æ¯ä¸ªä»»åŠ¡æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li><strong>newSingleThreadExecutor</strong> å•çº¿ç¨‹çš„çº¿ç¨‹æ± </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FinalizableDelegatedExecutorService</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>1ï¼Œè¯¥çº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨æ¥å¤„ç†å¤šä»»åŠ¡æ’é˜Ÿå¤„ç†çš„æƒ…å†µ</p>
<blockquote>
<p><strong>å’Œå•çº¿ç¨‹çš„åŒºåˆ«</strong></p>
<ul>
<li>å½“å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¤±è´¥å¼‚å¸¸æŠ›å‡ºåï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œ</li>
<li>ExecutorService.newSingleThreadExecutor()çº¿ç¨‹æ± çº¿ç¨‹æ•°å§‹ç»ˆä¸ºä¸€ï¼Œä¸å…è®¸ä¿®æ”¹</li>
</ul>
<p><strong>ä¸newFixThreadExecutor(1)ä¸åŒçš„æ˜¯ï¼ŒnewSingleThreadExecutor()ä¸­çš„FinalizableDelegatedExecutorï¼Œæ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªæš´éœ²äº†ä¸€äº›è°ƒç”¨æ–¹æ³•çš„æ¥å£ï¼Œä¸å…è®¸æ›´æ”¹Executorå†…éƒ¨ä¿¡æ¯ï¼Œè€ŒnewFixThreadExecutorè¿”å›çš„æ˜¯ThreadPoolExecutorï¼Œå¯ä»¥é€šè¿‡setCoreCapacityæ¥æ›´æ”¹çº¿ç¨‹æ•°é‡</strong></p>
</blockquote>
<ul>
<li><strong>newScheduledThreadPool</strong>  å®šæ—¶æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ScheduledExecutorService</span> <span class="nf">newScheduledThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>ä¸Timerçš„åŒºåˆ«</strong>ï¼š</p>
<p>1ï¼ŒTimerååˆ†è„†å¼±ï¼Œå½“ä¸€ç³»åˆ—ä»»åŠ¡ä¸­æŸäº›ä»»åŠ¡çš„æ—¶é—´éå¸¸é•¿æˆ–è€…ä»»åŠ¡å‡ºç°å¼‚å¸¸éƒ½ä¼šå½±å“åˆ°åç»­ä»»åŠ¡ï¼Œä½†æ˜¯newScheduledThreadPoolå¹¶ä¸ä¼š</p>
</blockquote>
<blockquote>
<p><strong>shceduleAtiFixedRateä¸scheduleWithFixedDelayçš„åŒºåˆ«</strong></p>
<p>ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å®šæ—¶å¾ªç¯æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œä¸”å‚æ•°æ„ä¹‰éƒ½ç›¸åŒ</p>
<p>1ï¼ŒshceduleAtiFixedRate çš„å»¶æ—¶æ‰§è¡Œæ—¶é—´ å–å†³äº max(ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œå»¶æ—¶æ—¶é—´)</p>
<p>2ï¼ŒscheduleWithFixedDelay çš„å»¶æ—¶æ‰§è¡Œæ—¶é—´ å–å†³äº å»¶æ—¶æ—¶é—´+ä»»åŠ¡æ‰§è¡Œæ—¶é—´</p>
</blockquote>
<p><strong>å°ç»ƒæ‰‹ï¼šæ¯å‘¨å››ä¸‹åˆå››ç‚¹å®šæ—¶æ‰§è¡Œä»»åŠ¡</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624174237917.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624174237917"
	
	
></p>
<h4 id="4æäº¤ä»»åŠ¡">4ï¼Œæäº¤ä»»åŠ¡</h4>
<ul>
<li><strong>submit</strong></li>
</ul>
<p>æäº¤ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…è¿”å›ç»“æœï¼Œé‡‡ç”¨çš„æ˜¯ä¿æŠ¤æ€§æš‚åœè®¾è®¡æ¨¡å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>invokeAll</strong></li>
</ul>
<p>æäº¤ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œç­‰å¾…æäº¤çš„æ‰€æœ‰ä»»åŠ¡çš„è¿”å›ç»“æœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>invokeAny</strong></li>
</ul>
<p>æäº¤ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œè¿”å›æœ€å…ˆæ‰§è¡Œå®Œçš„ä»»åŠ¡ç»“æœï¼Œä¸”å…¶ä»–ä»»åŠ¡ä¸ä¼šç»§ç»­æ‰§è¡Œä¸‹å»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5å…³é—­çº¿ç¨‹æ± ">5ï¼Œ<strong>å…³é—­çº¿ç¨‹æ± </strong></h4>
<ul>
<li><strong>shutdown</strong></li>
</ul>
<blockquote>
<p>å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ä¸ºshutdown</p>
<p>ä¸å†æ¥å—æ–°çš„ä»»åŠ¡</p>
<p>å·²æäº¤çš„ä»»åŠ¡ä¼šä¸€ç›´æ‰§è¡Œå®Œ</p>
<p>è°ƒç”¨çº¿ç¨‹ä¸ä¼šç­‰å¾…ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkShutdownAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºshutdown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">advanceRunState</span><span class="o">(</span><span class="n">SHUTDOWN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æ‰“æ–­ç©ºé—²çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">interruptIdleWorkers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">onShutdown</span><span class="o">();</span> <span class="c1">// hook for ScheduledThreadPoolExecutor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°è¯•ç»ˆç»“çº¿ç¨‹(æ²¡æœ‰ä»»åŠ¡æ—¶ç«‹å³ç»ˆç»“ï¼Œæœ‰ä»»åŠ¡å­˜åœ¨ä¹Ÿä¸ä¼šç­‰å¾…)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tryTerminate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>shutdownNow</strong></li>
</ul>
<blockquote>
<p>å°†çº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸ºSTOP</p>
<p>ä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œå·²æäº¤çš„ä»»åŠ¡ä¹Ÿä¸å†æ‰§è¡Œï¼Œå¹¶ä¸”è¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</p>
<p>æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ç”¨interruptè¿›è¡Œæ‰“æ–­</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkShutdownAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">advanceRunState</span><span class="o">(</span><span class="n">STOP</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æ‰“æ–­æ‰€æœ‰çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">interruptWorkers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tasks</span> <span class="o">=</span> <span class="n">drainQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°è¯•ç»ˆç»“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tryTerminate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å…¶ä»–æ–¹æ³•</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//ä¸åœ¨RUNNINGçŠ¶æ€ä¸‹çš„çº¿ç¨‹æ± è¿”å›True
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isShutdown</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//çº¿ç¨‹æ± æ˜¯å¦ä¸ºTerminating   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isTerminating</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//è°ƒç”¨shutdownåï¼Œè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…çº¿ç¨‹æ± ä¸­ä»»åŠ¡æ‰§è¡Œï¼Œæ­¤æ—¶å¯ä»¥è°ƒç”¨awaitTerminationè¿›è¡Œç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">awaitTermination</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="133-åˆ›å»ºçº¿ç¨‹æ± å¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚å‘¢">13.3 åˆ›å»ºçº¿ç¨‹æ± å¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚å‘¢</h3>
<ul>
<li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œå¯¼è‡´é¥¥é¥¿</li>
<li>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li>
</ul>
<h4 id="1cpuå¯†é›†å‹è¿ç®—">1ï¼ŒCPUå¯†é›†å‹è¿ç®—</h4>
<p>é‡‡ç”¨ cpuæ ¸æ•°+1 èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„CPUåˆ©ç”¨ç‡ï¼Œ+1æ˜¯ä¿è¯å½“å‰çº¿ç¨‹ç”±äºé¡µæ•…éšœæˆ–å…¶ä»–åŸå› å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„çº¿ç¨‹èƒ½é¡¶æ›¿ä¸Šå»ã€‚</p>
<h4 id="2ioå¯†é›†å‹è¿ç®—">2ï¼ŒI/Oå¯†é›†å‹è¿ç®—</h4>
<p>CPUä¸æ€»å¤„äºç¹å¿™çŠ¶æ€ï¼Œæ¯”å¦‚æ•°æ®åº“å¢åˆ æŸ¥æ”¹ï¼ŒRFCæ¡†æ¶è°ƒç”¨ï¼ŒI/0æ“ä½œï¼Œæ­¤æ—¶ä½ çš„CPUå°±ä¼šé—²ä¸‹æ¥ã€‚</p>
<p><strong>ç»éªŒå…¬å¼å¦‚ä¸‹ï¼š</strong></p>
<blockquote>
<p>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ›CPUåˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´+ç­‰å¾…æ—¶é—´) / CPUè®¡ç®—æ—¶é—´</p>
</blockquote>
<p>ä¾‹å¦‚ï¼š4æ ¸CPUè®¡ç®—æ—¶é—´æ˜¯50%ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯50%ï¼ŒæœŸæœ›cpuè¢«100%åˆ©ç”¨</p>
<p>4*100% *100%/ 50% = 8</p>
<h3 id="134-tomcatçº¿ç¨‹æ± ">13.4 Tomcatçº¿ç¨‹æ± </h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180953828.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180953828"
	
	
></p>
<ul>
<li>LimitLatchç”¨æ¥é™åˆ¶æµé‡ï¼Œæ§åˆ¶æœ€å¤§è¿æ¥æ•°</li>
<li>Accpetorè´Ÿè´£æ¥å—æ–°çš„socketè¿æ¥</li>
<li>Polleråªè´Ÿè´£ç›‘å¬socket channleæ˜¯å¦æœ‰ ã€å¯è¯»I/Oäº‹ä»¶ã€‘</li>
<li>ä¸€æ—¦è¯»å–ï¼ŒæŠŠäº‹ä»¶å°è£…æˆã€socketProcessorã€‘äº¤ç»™Excutorçº¿ç¨‹æ± å¤„ç†</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624181202589.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624181202589"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624181231465.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624181231465"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180500536.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180500536"
	
	
></p>
<p><strong>Tomcatæ•‘æ€¥çº¿ç¨‹åŸç†æ›´æ”¹</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180557243.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180557243"
	
	
></p>
<h3 id="135-forkjoin">13.5 Fork/Join</h3>
<h4 id="1æ¦‚å¿µ">1ï¼Œæ¦‚å¿µ</h4>
<p>Fork/Joiné‡‡ç”¨çš„æ˜¯ä¸€ç§<strong>åˆ†æ²»çš„æ€æƒ³</strong>ï¼ŒæŠŠä¸€ä¸ªä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªä»»åŠ¡ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡Œæ‹†è§£ï¼Œåˆå¹¶ï¼Œæé«˜è¿ç®—æ•ˆç‡</p>
<h2 id="14-juc">14 JUC</h2>
<h3 id="141-aqs">14.1 AQS</h3>
<h4 id="1æ¦‚è¿°">1,æ¦‚è¿°</h4>
<p>å…¨ç§°æ˜¯AbstractQueuedSynchronizedrï¼Œä¸é˜»å¡å¼é”ç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç”¨stateæ¥ä»£è¡¨èµ„æºçŠ¶æ€ï¼Œå­ç±»å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”ï¼Œé‡Šæ”¾é”</li>
</ul>
<blockquote>
<p><strong>AQSå®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼</strong></p>
<p>Exclusiveï¼ˆç‹¬å ï¼‰ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ReentrantLockã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼š</p>
<ul>
<li>å…¬å¹³é”ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é”</li>
<li>éå…¬å¹³é”ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œæ— è§†é˜Ÿåˆ—é¡ºåºç›´æ¥å»æŠ¢é”ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„</li>
</ul>
<p>Shareï¼ˆå…±äº«ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚Semaphore/CountDownLatchã€‚Semaphoreã€CountDownLatchã€ CyclicBarrierã€ReadWriteLock æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚</p>
</blockquote>
<ul>
<li>æä¾›äº†åŸºäºFIFOçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äºMonitorçš„EntryList</li>
<li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ï¼Œå”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äºMonitorçš„WaitSet</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220625203233523.png"
	
	
	
	loading="lazy"
	
		alt="image-20220625203233523"
	
	
></p>
<h3 id="142reentrantlock">14.2ï¼ŒReentrantLock</h3>
<p><strong>ç›¸å¯¹äºsynchronizedå®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹</strong></p>
<ul>
<li>å¯ä¸­æ–­</li>
<li>è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</li>
<li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li>
</ul>
<p><strong>ä¸synchronizedä¸€æ ·ï¼Œæ”¯æŒå¯é‡å…¥</strong></p>
<h5 id="è¯­æ³•">è¯­æ³•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ReentrantLock</span> <span class="n">reentrantLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">reentrantLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ä¸´ç•ŒåŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">reentrantLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å¯é‡å…¥">å¯é‡å…¥</h4>
<p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å¾—è¿™æŠŠé”ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">static</span> <span class="n">ReentrantLock</span> <span class="n">Lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">method1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">Lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">Lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;come in2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å¯æ‰“æ–­">å¯æ‰“æ–­</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å°è¯•è·å–é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ²¡æœ‰è·å¾—é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;è·å–é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;æ‰“æ–­t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é”è¶…æ—¶">é”è¶…æ—¶</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;å°è¯•è·å¾—é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(!</span><span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;è·å–ä¸åˆ°é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;è·å¾—åˆ°é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;é‡Šæ”¾äº†é”&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">22:51:45.783 [t1] DEBUG JUC.e_ReentrantLock.lockWait - å°è¯•è·å¾—é”
</span></span><span class="line"><span class="cl">22:51:46.797 [main] DEBUG JUC.e_ReentrantLock.lockWait - é‡Šæ”¾äº†é”
</span></span><span class="line"><span class="cl">22:51:46.797 [t1] DEBUG JUC.e_ReentrantLock.lockWait - è·å¾—åˆ°é”
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="locktrylock">lock.tryLock():</h5>
<blockquote>
<p>timeout=0æ²¡è·å–é”ï¼Œç›´æ¥è¿”å›</p>
<p>timeout&gt;0æ²¡è·å–é”ï¼Œç­‰å¾…timeoutæ—¶é—´ï¼Œå†è¿”å›</p>
</blockquote>
<h4 id="å…¬å¹³é”">å…¬å¹³é”</h4>
<p>ç®€ä»‹ï¼šå¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºå»è·å¾—é”ï¼Œçº¿ç¨‹ä¼šç›´æ¥è¿›å…¥é˜Ÿåˆ—å»æ’é˜Ÿï¼Œæ°¸è¿œéƒ½æ˜¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä½æ‰èƒ½å¾—åˆ°é”ã€‚</p>
<p>ReentrantLock é»˜è®¤ä¸ºä¸å…¬å¹³çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fair</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="n">fair</span> <span class="o">?</span> <span class="k">new</span> <span class="n">FairSync</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>*<em>æ³¨ï¼šå…¬å¹³é”ä¼šé™ä½å¹¶å‘åº¦</em></p>
<h4 id="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</h4>
<p>ReentrantLockçš„æ¡ä»¶å˜é‡æ¯”synchronizedå¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</p>
<h5 id="ä½¿ç”¨æµç¨‹">ä½¿ç”¨æµç¨‹</h5>
<ul>
<li>awaitå‰éœ€è¦è·å–é”</li>
<li>awaitæ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥conditionObjectç­‰å¾…</li>
<li>awaitçš„çº¿ç¨‹å”¤é†’åï¼Œé‡æ–°ç«äº‰locké”</li>
<li>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</li>
</ul>
<h3 id="143-åŸç†">14.3 åŸç†</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220625205626823.png"
	
	
	
	loading="lazy"
	
		alt="image-20220625205626823"
	
	
></p>
<h4 id="1åŠ é”ä»¥åŠç«äº‰é”">1ï¼ŒåŠ é”ä»¥åŠç«äº‰é”</h4>
<ul>
<li><strong>åœ¨æ²¡æœ‰çº¿ç¨‹ç«äº‰é”æ—¶</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626172830834.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626172830834"
	
	
></p>
<p>Threadçº¿ç¨‹å°†stateè®¾ç½®ä¸º1ï¼Œä¸”EXCThreadå˜ä¸ºThread-0</p>
<ul>
<li><strong>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626173058819.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626173058819"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¼šå…ˆé‡‡ç”¨CASæ¥åˆ¤æ–­æ˜¯å¦èƒ½è·å–é”ï¼ŒCASå¤±è´¥åè°ƒç”¨acquire(1)æ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>acquireæ­¤æ—¶è¿˜ä¼šè°ƒç”¨ä¸€æ¬¡tryAcquire()ï¼Œå†è¿›è¡Œä¸€æ¬¡CASæ¥åšæœ€åä¸€æ¬¡æŒ£æ‰ï¼Œçœ‹æ˜¯å¦èƒ½è·å–é”ï¼Œ<strong>å¦‚æœæ— æ³•è·å–åˆ™è¿›å…¥acquireQueuedé€»è¾‘å°†è¯¥çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeåŠ å…¥FIFOé˜Ÿåˆ—ä¸­</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626174055812.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626174055812"
	
	
></p>
<blockquote>
<p>åœ¨FIFOé˜Ÿåˆ—ä¸­</p>
<ul>
<li>é»„è‰²çš„ä¸‰è§’å½¢ä»£è¡¨å½“å‰Nodeçš„waitStatusçŠ¶æ€ï¼Œ0ä»£è¡¨æ­£å¸¸</li>
<li>åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ä¼šæœ‰ä¸€ä¸ªNull NodeèŠ‚ç‚¹ï¼Œå½“ä½œå“¨å…µèŠ‚ç‚¹ä½¿ç”¨</li>
<li>Nodeåˆ›å»ºæ˜¯æ‡’æƒ°çš„</li>
</ul>
</blockquote>
<ul>
<li><strong>acquireQueued</strong> <strong>é€»è¾‘</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å†è¿›å…¥acquireQueuedé€»è¾‘ä¹‹åï¼Œä¼šå…ˆåˆ¤æ–­è¯¥èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºå¤´èŠ‚ç‚¹ï¼Œåˆ™å†æ¬¡å°è¯•è·å–ã€‚</p>
<p>å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è¿›å…¥shouldParkAfterFailedAcquireé€»è¾‘ï¼Œå°†å‰æœŸçš„NodeèŠ‚ç‚¹çš„waitStatusè®¾ç½®ä¸º-1ï¼Œä¸”è¿™æ¬¡è¿”å›falseã€‚</p>
<p>-1çš„èŠ‚ç‚¹ä»£è¡¨è´Ÿè´£å”¤é†’å…¶åç»§node.nextèŠ‚ç‚¹çš„ä»»åŠ¡</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626182806742.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626182806742"
	
	
></p>
<p>shouldParkAfterFailedAcquireæ‰§è¡Œå®Œæ¯•åä¼šå†æ¬¡æ‰§è¡Œä¸€étryAcquireï¼Œå¦‚æœå†æ¬¡è·å–å¤±è´¥ï¼Œåˆ™è¿›å…¥shouldParkAfterFailedAcquire</p>
<p>ï¼Œæ­¤æ—¶è¿”å›trueï¼Œå³è¿›å…¥é˜»å¡çŠ¶æ€</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626183038234.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626183038234"
	
	
></p>
<p>ç»å†å¤šæ¬¡ç«äº‰åï¼Œå˜æˆå¦‚ä¸‹è¿™ä¸ªæ ·å­</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626183323473.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626183323473"
	
	
></p>
<h4 id="2è§£é”æµç¨‹">2ï¼Œè§£é”æµç¨‹</h4>
<ul>
<li><strong>å½“Thread-0æ‰§è¡Œç»“æŸåï¼Œä¼šè°ƒç”¨unlockï¼Œé‡Šæ”¾èµ„æº</strong></li>
</ul>
<p>releaseé€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">tryRelease</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">unparkSuccessor</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶ä¼šå…ˆè¿›è¡ŒtryReleaseæ¥å°è¯•è§£é”ï¼Œè§£é”æˆåŠŸåï¼Œä¼šå°†å½“å‰æ‰§è¡Œçº¿ç¨‹è®¾ä¸ºnullï¼ŒåŒæ—¶è°ƒç”¨unparkSuccessoræ¥å”¤é†’åç»§çº¿ç¨‹</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626184408218.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626184408218"
	
	
></p>
<ul>
<li><strong>unparkSuccessorå”¤é†’åç»§çº¿ç¨‹</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">unparkSuccessor</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">node</span><span class="o">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>é˜Ÿåˆ—çº¿ç¨‹(æ²¡æœ‰ç«äº‰)ï¼ŒåŠ é”æˆåŠŸ</strong></li>
</ul>
<p>exclusiveOwnerThreadè®¾ç½®ä¸ºThread-1ï¼Œstate=1</p>
<p>headæŒ‡å‘åˆšåˆšçš„Thread-1èŠ‚ç‚¹ï¼Œå¹¶å°†Node.threadè®¾ä¸ºnullï¼Œä¹‹å‰çš„èŠ‚ç‚¹ç¦»å¼€é˜Ÿåˆ—ï¼Œè¢«GCå›æ”¶</p>
<p>æ­¤æ—¶ä¼šæ‰¾åˆ°ç¦»headæœ€è¿‘çš„ä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œè°ƒç”¨unparkæ¥å”¤é†’åç»§çº¿ç¨‹ï¼Œå½“åç»§çº¿ç¨‹è¢«å”¤é†’åï¼Œä¼šè¿›è¡ŒåŠ é”</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626184634884.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626184634884"
	
	
></p>
<ul>
<li><strong>åŠ é”å¤±è´¥ï¼Œæœ‰å…¶ä»–çº¿ç¨‹æ¥ç«äº‰(éå…¬å¹³é”)</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626222937304.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626222937304"
	
	
></p>
<p>Thread-1å†æ¬¡è¿›å…¥acquireQueuedæµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥park</p>
<h4 id="3å¯é‡å…¥">3ï¼Œå¯é‡å…¥</h4>
<ul>
<li><strong>ä¸å…¬å¹³é”å¯é‡å…¥</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">nonfairTryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æ­¤æ—¶é‡å…¥çš„è¯ï¼Œåˆ™state++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è§£é”æ—¶ï¼Œè€ƒè™‘åˆ°å¯é‡å…¥ï¼Œstate--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">()</span> <span class="o">-</span> <span class="n">releases</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">free</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">free</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4å¯æ‰“æ–­">4ï¼Œå¯æ‰“æ–­</h4>
<ul>
<li><strong>ä¸å¯æ‰“æ–­æ¨¡å¼</strong></li>
</ul>
<p>ä¸å¯æ‰“æ–­æ¨¡å¼ä¸‹çš„çº¿ç¨‹å¯ä»¥è¢«å¤–ç•Œçº¿ç¨‹æ‰“æ–­ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå› ä¸ºæ‰“æ–­è€Œé€€å‡ºé˜»å¡é˜Ÿåˆ—ç‹¬ç«‹è¿è¡Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">parkAndCheckInterrupt</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  <span class="c1">//é˜»å¡çš„çº¿ç¨‹ï¼Œè¢«å¤–ç•Œçº¿ç¨‹æ‰“æ–­é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//æ­¤æ—¶è°ƒç”¨interruptedæ–¹æ³•ï¼Œè¿”å›trueï¼ŒåŒæ—¶æ¸…é™¤æ‰“æ–­æ ‡è®°(parkåªèƒ½parkï¼Œæ²¡è¢«æ‰“æ–­çš„çº¿ç¨‹ï¼Œæ–¹ä¾¿ä¸‹æ¬¡å¾ªç¯åæ‰“æ–­)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//è¿”å›è¢«æ‰“æ–­çš„ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//è¢«æ‰“æ–­çš„çº¿ç¨‹å°†æ ‡è®°è®¾ä¸ºç©ºï¼Œæ­¤æ—¶çº¿ç¨‹å¹¶æ²¡æœ‰å‡ºé˜»å¡é˜Ÿåˆ—ç‹¬ç«‹è¿è¡Œï¼Œè€Œæ˜¯ç»§ç»­ç«äº‰é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//1 ï¼Œç«äº‰å¤±è´¥ --&gt; parkAndCheckInterrupt ç»§ç»­é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//2 ï¼Œç«äº‰æˆåŠŸ --&gt; return interrupted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è‹¥æ‰“æ–­æ ‡è®°ä¸ºtrueï¼Œåˆ™åœ¨æ‰“æ–­ä¸€æ¬¡ï¼Œå°†æ‰“æ–­æ ‡è®°è®¾ä¸ºtrueï¼Œç›®çš„æ˜¯é˜²æ­¢å†ä¹‹åè¿è¡Œä¸­ï¼Œå†æ¬¡è¢«é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">selfInterrupt</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å¯æ‰“æ–­æ¨¡å¼</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doAcquireInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//åœ¨è‡ªèº«è¢«æ‰“æ–­åï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5å…¬å¹³é”">5ï¼Œ<strong>å…¬å¹³é”</strong></h4>
<p>ä¸éå…¬å¹³é”ä¸åŒçš„æ˜¯ï¼Œéå…¬å¹³é”ä¸­çº¿ç¨‹åˆ°æ¥å³å¯ç«äº‰é”ï¼Œ<strong>è€Œå…¬å¹³é”ä¸­</strong>ï¼Œ<strong>çº¿ç¨‹åˆ°æ¥å…ˆè¦åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰å…¶ä»–é˜Ÿåˆ—æˆ–è€…åˆ°æ¥çº¿ç¨‹ä¸ºé˜»å¡é˜Ÿåˆ—ç¬¬äºŒå</strong>ï¼Œå³å¯ç«äº‰é”</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">hasQueuedPredecessors</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasQueuedPredecessors</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span> <span class="o">!=</span> <span class="n">t</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6æ¡ä»¶å˜é‡å®ç°åŸç†">6ï¼Œæ¡ä»¶å˜é‡å®ç°åŸç†</h4>
<h5 id="await">await</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†nodeæ·»åŠ åˆ°æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addConditionWaiter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//fullyReleaseæ˜¯è·å–åˆ°é”çš„å…¨éƒ¨å¯é‡å…¥æ¬¡æ•°ï¼Œå¹¶å°†stateè®¾ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">savedState</span> <span class="o">=</span> <span class="n">fullyRelease</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">interruptMode</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(!</span><span class="n">isOnSyncQueue</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">interruptMode</span> <span class="o">=</span> <span class="n">checkInterruptWhileWaiting</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acquireQueued</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">savedState</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">interruptMode</span> <span class="o">!=</span> <span class="n">THROW_IE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">interruptMode</span> <span class="o">=</span> <span class="n">REINTERRUPT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// clean up if cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">unlinkCancelledWaiters</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">interruptMode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">reportInterruptAfterWait</span><span class="o">(</span><span class="n">interruptMode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†Thread-0æ”¾å…¥ConditionObjectçš„WaiteråŒå‘é“¾è¡¨ä¸­ï¼Œå¹¶å°†NodeçŠ¶æ€è®¾ç½®ä¸º-2</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627180030683.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>é€šè¿‡fullyReleaseï¼Œå°†åŸæœ¬çš„Thread-0çš„é”(ä¸ç®¡æ˜¯å¦é‡å…¥)ç»™é‡Šæ”¾ï¼ŒåŒæ—¶å°†Thread-1å”¤é†’ï¼Œä½¿ç”¨é”</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627181750914.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>Thread-0é˜»å¡</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627181807434.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="signal">signal</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">signal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">isHeldExclusively</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">doSignal</span><span class="o">(</span><span class="n">first</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å”¤é†’ConditionObjectä¸­çš„<strong>ç¬¬ä¸€ä¸ªçº¿ç¨‹</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627182247140.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doSignal</span><span class="o">(</span><span class="n">Node</span> <span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span> <span class="o">(</span><span class="n">firstWaiter</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">transferForSignal</span><span class="o">(</span><span class="n">first</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">             <span class="o">(</span><span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†ç¬¬ä¸€ä¸ªNodeä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œ<strong>åŒæ—¶è½¬æ¢åˆ°é”çš„é˜»å¡é˜Ÿåˆ—ä¸­</strong>ï¼Œè½¬æ¢å¤±è´¥çš„è¯(æœ‰å¯èƒ½æ˜¯è¢«å¤–ç•Œçº¿ç¨‹æ‰“æ–­å”¤é†’)ï¼Œåˆ™å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹èŠ‚ç‚¹ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627182407119.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>å½“æˆåŠŸåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­æ—¶ï¼Œå°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çš„çŠ¶æ€è®¾ç½®ä¸º-1</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627202714677.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="144-reentrantreadwritelock">14.4 ReentrantReadWriteLock</h3>
<p>**é”çš„åœºæ™¯ï¼š**åœ¨è¯»å–æ“ä½œå¤šäºå†™æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå¯¹å¤§é‡è¯»æ“ä½œçš„åŠ é”ï¼Œåè€Œä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œäºæ˜¯ä¾¿å°†è¯»å†™é”åˆ†ç¦»ï¼Œæ¥è¿›è¡Œè®¾è®¡</p>
<h4 id="ç‰¹æ€§">ç‰¹æ€§ï¼š</h4>
<ul>
<li>**åŸºæœ¬åŸåˆ™ï¼š**è¯»è¯»å…±äº«ï¼Œè¯»å†™äº’æ–¥ï¼Œå†™çº¿ç¨‹åªå…è®¸å­˜åœ¨ä¸€ä¸ª</li>
<li>è¯»é”æ²¡æœ‰æ¡ä»¶å˜é‡ï¼Œå†™é”æ‹¥æœ‰æ¡ä»¶å˜é‡</li>
<li>è¯»é”ä¸å¯ä»¥å‡çº§ä¸ºå†™é”(ä¸èƒ½è¿›è¡Œé”å‡çº§)ï¼Œå†™é”å¯ä»¥é™çº§ä¸ºè¯»é”(èƒ½è¿›è¡Œé”é™çº§)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">cacheInvalid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockLevelDown</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(!</span><span class="n">cacheInvalid</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">           <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span><span class="o">(!</span><span class="n">cacheInvalid</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                   <span class="n">data</span> <span class="o">=</span> <span class="s">&#34;Genius&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                   <span class="n">cacheInvalid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">//è¿›è¡Œé”é™çº§ï¼Œå½“å†™é”é‡Šæ”¾å¼€åï¼Œå…¶ä»–è¯»é”å¯ä»¥å…±äº«ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;data {}&#34;</span><span class="o">,</span><span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åº”ç”¨ç¼“å­˜æ›´æ–°">åº”ç”¨ï¼šç¼“å­˜æ›´æ–°</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628160551021.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628160830658.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628203354099.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="åŸç†-2">åŸç†ï¼š</h4>
<p>ReentrantReadWriteLockæœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªåŒæ­¥å™¨ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šè®¾è®¡çš„ä¸€ç‚¹ï¼Œ<strong>read lockå’Œwrite lockä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªstateï¼Œå³read lockä½¿ç”¨stateçš„é«˜16ä½ï¼Œwrite lockä½¿ç”¨stateçš„ä½16ä½</strong></p>
<blockquote>
<p><strong>readLockè·å–é”çš„çŠ¶æ€æ˜¯ï¼š state &raquo;&gt;16 æ— çŠ¶æ€å³ç§»åŠ¨16ä½</strong></p>
<p><strong>writeLockè·å–é”çš„çŠ¶æ€æ˜¯ï¼šstate &amp; (1&laquo;16-1)ï¼Œå°†é«˜ä½è¡¥0</strong></p>
</blockquote>
<h5 id="t1-wlock-t2-rlock">t1 w.lock t2 r.lock</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Walkthrough:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 1. If read count nonzero or write count nonzero
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and owner is a different thread, fail.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 2. If count would saturate, fail. (This can only
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    happen if count is already nonzero.)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 3. Otherwise, this thread is eligible for lock if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    it is either a reentrant acquire or
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    queue policy allows it. If so, update state
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and set owner.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>  <span class="c1">//è·å–å½“å‰çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="c1">//ä¸ä½15ä½1 å³c&amp;(1&lt;&lt;16)-1ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå†™é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span><span class="c1">//çŠ¶æ€ä¸ä¸º0ï¼Œå³å·²ç»è¢«åŠ é”ï¼Œè¿›å…¥åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">            1ï¼Œw==0 ä»£è¡¨åŠ çš„æ˜¯è¯»é”ï¼Œè¯»å†™äº’æ–¥ï¼Œè¿”å›false
</span></span></span><span class="line"><span class="cl"><span class="cm">            2ï¼Œw!=0 ä»£è¡¨åŠ çš„æ˜¯å†™é”ï¼Œåˆ¤æ–­æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºæœ¬çº¿ç¨‹ï¼Œè‹¥ä¸ºæœ¬çº¿ç¨‹ï¼Œåˆ™é”å¯é‡å…¥åŠ é”æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="cm">            **/</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">acquires</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">MAX_COUNT</span><span class="o">)</span><span class="c1">// å¯é‡å…¥é”æ˜¯å¦è¾¾åˆ°ä¸Šé™åˆ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Reentrant acquire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setState</span><span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//c==0çš„è¯ä»£è¡¨æ²¡æœ‰äººåŠ é”ï¼Œæ­¤æ—¶ç”±äºéå…¬å¹³é”ï¼ŒwriterShouldBlock()å§‹ç»ˆè¿”å›falseï¼Œåˆ¤æ–­æ˜¯å¦èƒ½æ­£å¸¸CASï¼Œå¦‚æœå¯ä»¥è¯´æ˜æ²¡æœ‰ç«äº‰ï¼Œå ç”¨é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*state=0æ‰èƒ½èµ°åˆ°æ­¤å¤„ï¼ŒwriterShouldBlock()æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ’é˜Ÿ
</span></span></span><span class="line"><span class="cl"><span class="cm">            éå…¬å¹³é”ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">                ç›´æ¥è¿”å›falseï¼Œç„¶åä½¿ç”¨CASæ¥ä¿®æ”¹stateï¼Œå¦‚æœä¿®æ”¹æˆåŠŸåˆ™è¯´æ˜æ‹¿åˆ°é”äº†
</span></span></span><span class="line"><span class="cl"><span class="cm">                é‚£ä¹ˆå¯ä»¥ç»§ç»­å°†ç‹¬å é”çš„æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">            å…¬å¹³é”ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">                å…¬å¹³é”ä¼šè°ƒç”¨hasQueuedPredecessors()ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆ¤æ–­å…¥å£ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="cm">                ä¸­æ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…é”ã€‚å¦‚æœæ²¡æœ‰çº¿ç¨‹ç­‰å¾…æˆ–è€…ç­‰å¾…é˜Ÿåˆ—ä¸­æ’åœ¨æœ€å‰è¾¹çš„æ˜¯å½“å‰
</span></span></span><span class="line"><span class="cl"><span class="cm">                çº¿ç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥ç»§ç»­è¿›è¡Œåè¾¹çš„CASæ“ä½œï¼Œå¦åˆ™è¿”å›falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">writerShouldBlock</span><span class="o">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>1ï¼‰ t1ç”³è¯·Wé”ï¼Œæ­¤æ—¶stateä¸º0æ‰€ä»¥è‡ªç„¶è€Œç„¶å¯ä»¥ç”³è¯·åˆ°Wé”</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629152144091.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<blockquote>
<p>tryAcquireShared è¿”å›å€¼</p>
<p>val=-1 ä»£è¡¨è·å–é”å¤±è´¥</p>
<p>val=1ä»£è¡¨è·å–é”æˆåŠŸ</p>
<p>val&gt;1 ä»£è¡¨è·å–é”æˆåŠŸå¹¶å”¤é†’valæ•°é‡çš„çº¿ç¨‹</p>
</blockquote>
<p>æ³¨ï¼š</p>
<blockquote>
<p>å…±äº«é”ä¼šä¸ºæ¯ä¸ªè·å–ReadLockçš„çº¿ç¨‹åˆ›å»ºä¸€ä¸ªHoldCounteræ¥è®°å½•è¯¥çº¿ç¨‹çš„çº¿ç¨‹IDå’Œè·å–ReadLockçš„æ¬¡æ•°(åŒ…æ‹¬é‡å…¥)ã€‚å¹¶å°†è¿™ä¸ªHoldCounterå¯¹è±¡ä¿å­˜åœ¨çº¿ç¨‹è‡ªå·±çš„ThreadLocalä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ThreadLocalHoldCounter</span> <span class="n">readHolds</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HoldCounter</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tryAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">exclusiveCount</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">getExclusiveOwnerThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">current</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//åˆ¤æ–­æ˜¯å¦ä¸ºå†™é”ï¼Œä¸”æ˜¯å¦å¯ä»¥è¿›è¡Œé”é™çº§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sharedCount</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">readerShouldBlock</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">&lt;</span> <span class="n">MAX_COUNT</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">SHARED_UNIT</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**è®¾è®¡è€…è€ƒè™‘åˆ°åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨è¯»é”é‡å…¥çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™ä¸ä½¿ç”¨ThreadLocalé‡Œé¢çš„HoldCounterè¿™æ ·ä¼šæ¶ˆè€—æ€§èƒ½ï¼Œä¾¿ä½¿ç”¨reentrantLockä¸­çš„firstReaderHoldCountæ¥è®°å½•**/</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReader</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">firstReader</span> <span class="o">==</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å¤šä¸ªçº¿ç¨‹æ¥ç”³è¯·è¯»é”ä¼šåˆ°è¿™ä¸€æ­¥ï¼Œä»cacheHoldCounterä¸­æ‹¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HoldCounter</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">              1,å¦‚æœrh.tid == getThreadId(current) è¯´æ˜æ‹¿è¿‡ä¸¤æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="cm">              2,å¦‚æœrh.tid != getThreadId(current) è¯´æ˜ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°ä»ThreadLocalé‡Œé¢å–å‡ºHoldCounterï¼Œå¹¶ä¸”ä¿®æ”¹ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="cm">              **/</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">rh</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rh</span><span class="o">.</span><span class="na">tid</span> <span class="o">!=</span> <span class="n">getThreadId</span><span class="o">(</span><span class="n">current</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">cachedHoldCounter</span> <span class="o">=</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">readHolds</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">rh</span><span class="o">.</span><span class="na">count</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">readHolds</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">rh</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">fullTryAcquireShared</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ï¼‰æ­¤æ—¶t2ç”³è¯·Ré”ï¼Œæ­¤æ—¶stateä½ä½16ä¸ä¸º0ï¼Œä»£è¡¨å·²ç»æœ‰å†™é”ï¼Œä¸”ä¸ä¸ºè‡ªå·±åŠ çš„å†™é”ï¼Œæ­¤æ—¶è¿”å›-1è¿›å…¥é˜»å¡é˜Ÿåˆ—</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629162813304.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">SHARED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tryAcquireShared</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">setHeadAndPropagate</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4ï¼‰æ·»åŠ ä¸¤ä¸ªSHAREDèŠ‚ç‚¹ï¼Œä¸”å†æ¬¡è¿›è¡ŒtryAcquireï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™é˜»å¡</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629163024140.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t3-rlock-t4-wlock">t3 r.lock t4 w.lock</h5>
<p>5ï¼‰è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰t3åŠ è¯»é”å’Œt4åŠ å†™é”ï¼Œæ­¤æ—¶t1ä»ç„¶æŒæœ‰é”ï¼Œå°±ä¼šè¿›å…¥å¦‚ä¸‹çŠ¶æ€</p>
<blockquote>
<p>æ³¨ï¼š</p>
<p>å†™é”åŠ çš„æ˜¯EX NodeèŠ‚ç‚¹</p>
<p>è¯»é”åŠ çš„æ˜¯ Shared NodeèŠ‚ç‚¹</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629165342912.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t1-wunlock">t1 w.unlock</h5>
<p>6ï¼‰æ­¤æ—¶t1ä¼šé‡Šæ”¾é”ï¼Œå¦‚æœé‡Šæ”¾æˆåŠŸï¼Œåˆ™ä¼šå”¤é†’åç»­çº¿ç¨‹(å’ŒreentrantLockåŸç†ä¸€è‡´s)</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629165743754.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>7ï¼‰æ­¤æ—¶t2è¢«t1å”¤é†’åæŠ¢å åˆ°é”(æ— ç«äº‰çš„æƒ…å†µä¸‹)ï¼Œæ­¤æ—¶å°†è‡ªå·±çš„èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰ç»“æŸï¼Œ<strong>ä»–ä¼šè°ƒç”¨</strong></p>
<p><strong>setHeadAndPropagate(node, r)æ–¹æ³•ï¼Œæ¥å”¤é†’åç»­æ‰€æœ‰ä¸ºsharedç»“ç‚¹çš„çº¿ç¨‹</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setHeadAndPropagate</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">propagate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span> <span class="c1">// Record old head for check below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">propagate</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">isShared</span><span class="o">())</span><span class="c1">//å”¤é†’åç»­ä¸º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">doReleaseShared</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172132623.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doReleaseShared</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">,</span> <span class="n">0</span><span class="o">))</span> <span class="c1">//æ­¤æ—¶å°†èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º0ï¼ˆç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢æœ‰å…¶ä»–çº¿ç¨‹å¹²æ‰°ï¼Œå¦‚æœæœ‰çº¿ç¨‹è¿›æ¥å‘ç°æ˜¯-1ä¼šå†å”¤é†’ä¸€æ¬¡) ä¸æ˜¯å¾ˆæ‡‚???
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">continue</span><span class="o">;</span>            <span class="c1">// loop to recheck cases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">unparkSuccessor</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                         <span class="o">!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">PROPAGATE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>                <span class="c1">// loop on failed CAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">head</span><span class="o">)</span>                   <span class="c1">// loop if head changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>8ï¼‰<strong>æ­¤æ—¶t2çš„èŠ‚ç‚¹çŠ¶æ€è¢«è®¾ç½®ä¸º0ï¼Œä¸”t3è¢«t2å”¤é†’ï¼Œt3é‡å¤t2çš„è¿‡ç¨‹è·å–é”å¹¶ä¸”å”¤é†’åç»§sharedèŠ‚ç‚¹</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172159274.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>9ï¼‰åç»§èŠ‚ç‚¹ä¸ºEx æ‰€ä»¥å”¤é†’ç»“æŸï¼Œt2ï¼Œt3å æœ‰é”ï¼Œä¸”çŠ¶æ€ä¸º2_0</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172523758.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t2-runlock-t3-runlock">t2 r.unlock() t3 r.unlock()</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryReleaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//é‡å…¥è¯»é”è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">firstReader</span> <span class="o">==</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// assert firstReaderHoldCount &gt; 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">firstReaderHoldCount</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HoldCounter</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">rh</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rh</span><span class="o">.</span><span class="na">tid</span> <span class="o">!=</span> <span class="n">getThreadId</span><span class="o">(</span><span class="n">current</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">rh</span> <span class="o">=</span> <span class="n">readHolds</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">readHolds</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="n">unmatchedUnlockException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">--</span><span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">SHARED_UNIT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">nextc</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å¯é‡å…¥é”å…¨éƒ¨è§£é”åˆ™è¿”å›true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="n">nextc</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>10ï¼‰æ­¤æ—¶t3è§£é”ï¼ˆæ­£å¸¸æµç¨‹è§£é”ï¼‰ï¼Œstateå‡ä¸º1ï¼Œread lockå¹¶æ²¡æœ‰è¢«å…¨éƒ¨è§£é”ï¼Œä¸å”¤é†’åç»­çº¿ç¨‹</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172219244.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>11ï¼‰æ­¤æ—¶t2è§£é”ï¼Œstateå‡ä¸º0ï¼Œread lockè¢«å…¨éƒ¨è§£é”ï¼Œå”¤é†’åç»­çº¿ç¨‹</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172601718.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>12ï¼‰t4èŠ‚ç‚¹è¢«å”¤é†’æˆåŠŸï¼Œè·å–è¯»é”</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172813609.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="æµç¨‹å›¾-1">æµç¨‹å›¾</h4>
<h5 id="è¯»é”">è¯»é”</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629175402029.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="å†™é”">å†™é”</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629175424219.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="145-stampedlock">14.5 StampedLock</h3>
<p>ç”±äºReentrantReadWriteLockçš„éœ€è¦åŠ é”æ¥å®ç°è¯»è¯»å¹¶å‘ï¼Œè¯»å†™å¹¶å‘ï¼Œæ€§èƒ½è‚¯å®šä¸å¦‚ä¸åŠ é”çš„å¹¶å‘çŠ¶æ€ï¼Œæ­¤æ—¶StampedLockå¯ä»¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»–æ‹¥æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œæ¯ä¸€æ¬¡ä½¿ç”¨è¯»é”å’Œå†™é”éƒ½å¿…é¡»è¦é…åˆä¸€ä¸ªã€æˆ³ã€‘</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629180846760.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630101437965.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="stampedlockæ€§èƒ½æ¯”readwritelockå¥½çš„åŸå› ">StampedLockæ€§èƒ½æ¯”ReadWriteLockå¥½çš„åŸå› </h4>
<ul>
<li><strong>ReadWriteLockï¼Œæœ‰å¤§é‡è¯»æ“ä½œæ—¶ï¼Œä¼šå¯¼è‡´å†™æ“ä½œé¥¥é¥¿ï¼Œä¸€ç›´è·å–ä¸åˆ°é”ï¼Œè€ŒStampedLocké‡‡ç”¨ä¹è§‚è¯»çš„æ–¹å¼ï¼Œå³ä½¿åœ¨å¤§é‡è¯»æ“ä½œä¸‹ä¹Ÿæ˜¯å¯ä»¥è·å–å†™é”çš„</strong></li>
<li><strong>ReadWriteLockçš„è¯»æ“ä½œï¼Œæ¯ä¸€æ¬¡éƒ½éœ€è¦CASæ›´æ”¹stateï¼Œä½†æ˜¯StampedLockä¹è§‚è¯»çš„æ–¹å¼æ— éœ€ä½¿ç”¨CASï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½</strong></li>
</ul>
<h4 id="åŸç†-3">åŸç†</h4>
<h5 id="stampedlockçš„çŠ¶æ€">StampedLockçš„çŠ¶æ€</h5>
<blockquote>
<p>StampedLockå’ŒReadWriteLockçš„çŠ¶æ€å½¢å¼å·®ä¸å¤šï¼Œä¹Ÿæ˜¯é‡‡ç”¨<strong>åŒæ­¥çŠ¶æ€æŒ‰ä½åˆ‡åˆ†</strong></p>
<p><strong>64ä½state çŠ¶æ€åˆ‡åˆ†</strong></p>
<p>0~7ä½ï¼šè¯»é”è·å–æ•°é‡å³çŠ¶æ€ ï¼ˆå¯å­˜æ”¾128ä¸ªè¯»é”ï¼Œè¶…è¿‡ä¸Šé™ç”¨readOverFlowæ¥å­˜å‚¨)</p>
<p>8ä½ï¼šå†™é”çš„çŠ¶æ€</p>
<p>8~64ä½ï¼šå†™é”çš„æ•°é‡</p>
<p><strong>å†™é”ä½¿ç”¨çŠ¶æ€</strong></p>
<blockquote>
<p>æ­¤å¤„è€ƒè™‘åˆ°äº†ABAé—®é¢˜</p>
<ol>
<li>æ£€æŸ¥æ˜¯å¦æœ‰å†™é”ï¼Œstate ç¬¬ 8 ä½ä¸º 0ï¼Œæ²¡æœ‰å†™é”ï¼Œæ‹·è´æ•°æ®ï¼›</li>
<li>æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹è·å–è¿‡å†™é”ï¼Œstate ç¬¬ 8 ä½ä¸º 0ï¼Œæ²¡æœ‰çº¿ç¨‹è·å–è¿‡ï¼Œç›´æ¥ä½¿ç”¨åŸæ¥æ‹·è´çš„æ•°æ®ã€‚</li>
</ol>
<p>ç¬¬ä¸€æ¬¡æ£€æŸ¥ state ç¬¬ 8 ä½ä¸º 0 ä¹‹åï¼Œæœ‰çº¿ç¨‹è·å–å†™é”ä¿®æ”¹æ•°æ®å¹¶é‡Šæ”¾äº†å†™é”ï¼Œé‚£ä¹ˆä¹‹ååœ¨æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹è·å–è¿‡å†™é”æ—¶ state ç¬¬ 8 ä½è¿˜æ˜¯ 0ï¼Œè®¤ä¸ºæ²¡æœ‰çº¿ç¨‹è·å–è¿‡å†™é”ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>
</blockquote>
<p>å› æ­¤å†™é”çš„çŠ¶æ€ååˆ†å·§å¦™ï¼Œå½“è·å–å†™é”æ—¶ï¼Œå°†stateçš„ç¬¬8ä½è®¾ç½®ä¸º1ï¼Œé‡Šæ”¾å†™é”æ—¶åœ¨stateç¬¬8ä½+1ï¼Œæ­¤æ—¶å³åŒæ­¥äº†å†™é”æ•°é‡ï¼Œåˆæ”¹å˜äº†å†™é”çŠ¶æ€</p>
</blockquote>
<h4 id="é”çŠ¶æ€ç›¸å…³å±æ€§">é”çŠ¶æ€ç›¸å…³å±æ€§</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ä¸€ä¸ªå•ä½çš„è¯»é”        0000... 0000 0000 0001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RUNIT</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>   
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸€ä¸ªå•ä½çš„å†™é”        0000... 0000 1000 0000                
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">WBIT</span> <span class="o">=</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">LG_READERS</span><span class="o">;</span>   
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// è¯»çŠ¶æ€æ ‡è¯†            0000... 0000 0111 1111  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RBITS</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// è¯»é”æœ€å¤§æ•°é‡          0000... 0000 0111 1110           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RFULL</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span>    
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ç”¨äºè·å–è¯»å†™çŠ¶æ€      0000... 0000 1111 1111       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ABITS</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">|</span> <span class="n">WBIT</span><span class="o">;</span>  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">//                       1111... 1111 1000 0000       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">SBITS</span> <span class="o">=</span> <span class="o">~</span><span class="n">RBITS</span><span class="o">;</span>               
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// é”stateåˆå§‹å€¼ï¼Œ0000... 0001 0000 0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** é”é˜Ÿåˆ—çŠ¶æ€ï¼Œ å½“å¤„äºå†™æ¨¡å¼æ—¶ç¬¬8ä½ä¸º1ï¼Œè¯»æ¨¡å¼æ—¶å‰7ä¸ºä¸º1-126
</span></span></span><span class="line"><span class="cl"><span class="cm">ï¼ˆé™„åŠ çš„readerOverflowç”¨äºå½“è¯»è€…è¶…è¿‡126æ—¶ï¼‰ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** å°†stateè¶…è¿‡ RFULL=126çš„å€¼æ”¾åˆ°readerOverflowå­—æ®µä¸­ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kt">int</span> <span class="n">readerOverflow</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="èŠ‚ç‚¹">èŠ‚ç‚¹</h4>
<p>StampedLockdçš„ç­‰å¾…é˜Ÿåˆ—å’ŒAQSå·®ä¸å¤šï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªæ ˆæ¥ä¿å­˜è¯»çº¿ç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ç»“ç‚¹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WAITING</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CANCELLED</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ç»“ç‚¹çš„è¯»å†™æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RMODE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WMODE</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** Wait nodes */</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WNode</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">cowait</span><span class="o">;</span> <span class="c1">// è¯»æ¨¡å¼ä½¿ç”¨è¯¥ç»“ç‚¹å½¢æˆæ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">volatile</span> <span class="n">Thread</span> <span class="n">thread</span><span class="o">;</span> <span class="c1">// non-null while possibly parked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// 0, WAITING, or CANCELLED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">;</span> <span class="c1">// RMODE or WMODE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">    <span class="n">WNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">WNode</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** CLHé˜Ÿå¤´ç»“ç‚¹ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">whead</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** CLHé˜Ÿå°¾ç»“ç‚¹ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">wtail</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è‡ªæ—‹æ¬¡æ•°ä¼˜åŒ–">è‡ªæ—‹æ¬¡æ•°ä¼˜åŒ–</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630103039693.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="æ³¨æ„">æ³¨æ„</h4>
<ol>
<li>éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œé‚£å°±æ˜¯ï¼šå¦‚æœçº¿ç¨‹é˜»å¡åœ¨ StampedLock çš„ readLock() æˆ–è€… writeLock() ä¸Šæ—¶ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥é˜»å¡çº¿ç¨‹çš„ interrupt() æ–¹æ³•ï¼Œä¼šå¯¼è‡´ CPU é£™å‡ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œçº¿ç¨‹ T1 è·å–å†™é”ä¹‹åå°†è‡ªå·±é˜»å¡ï¼Œçº¿ç¨‹ T2 å°è¯•è·å–æ‚²è§‚è¯»é”ï¼Œä¹Ÿä¼šé˜»å¡ï¼›å¦‚æœæ­¤æ—¶è°ƒç”¨çº¿ç¨‹ T2 çš„ interrupt() æ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ T2 çš„è¯ï¼Œä½ ä¼šå‘ç°çº¿ç¨‹ T2 æ‰€åœ¨ CPU ä¼šé£™å‡åˆ° 100%ã€‚</li>
<li>StampedLock æ”¯æŒé”çš„é™çº§ï¼ˆé€šè¿‡ tryConvertToReadLock() æ–¹æ³•å®ç°ï¼‰å’Œå‡çº§ï¼ˆé€šè¿‡ tryConvertToWriteLock() æ–¹æ³•å®ç°ï¼‰ï¼Œä½†æ˜¯å»ºè®®ä½ è¦æ…é‡ä½¿ç”¨ã€‚ä¸‹é¢çš„ä»£ç ä¹Ÿæºè‡ª Java çš„å®˜æ–¹ç¤ºä¾‹ï¼Œéšè—äº†ä¸€ä¸ª Bugï¼Œå°±æ˜¯åœ¨é”å‡çº§æˆåŠŸçš„æ—¶å€™ï¼Œæœ€åæ²¡æœ‰é‡Šæ”¾æœ€æ–°çš„å†™é”ï¼Œå¯ä»¥åœ¨ifå—çš„breakä¸ŠåŠ ä¸ªstamp=wsè¿›è¡Œé‡Šæ”¾ã€‚</li>
</ol>
<h3 id="146-semaphore">14.6 Semaphore</h3>
<p>ä¿¡å·é‡ï¼Œç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Thread {}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="semaphoreåº”ç”¨">Semaphoreåº”ç”¨</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630141110941.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><em><strong>åœ¨é™æµæ–¹é¢å¹¶ä¸å’‹æ ·ï¼Œæœ€å¥½è¿˜æ˜¯é‡‡ç”¨åˆ†å¸ƒå¼é”</strong></em>g</p>
<h5 id="æ›´æ”¹æ•°æ®åº“è¿æ¥æ± ">æ›´æ”¹æ•°æ®åº“è¿æ¥æ± </h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConn2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;get {}&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">free2</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} free&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åŸç†-4">åŸç†</h4>
<p>Semaphoreå°±ç±»ä¼¼äºåœè½¦åœºï¼Œå¼€æ”¾å¤šå°‘èµ„æºï¼Œstateå°±æœ‰å¤šå°‘ï¼Œæ¯æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–èµ„æºæ—¶ï¼Œstateå‡1ï¼Œç›´åˆ°&lt;0çš„æ—¶å€™ï¼Œçº¿ç¨‹åœ¨è·å–å³è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œæ€»ä½“çš„è§£é”å’ŒåŠ é”è¿‡ç¨‹è¿˜æ˜¯å’ŒReadWriteLockä¸€æ ·ã€‚</p>
<p>åŠ é”ï¼ŒCAS stateï¼Œä¸ä¸º0æ‹¿åˆ°é”ï¼Œä¸º0è¿›å…¥é˜»å¡ã€‚</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630141908241.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>è§£é”ï¼Œé‡Šæ”¾èµ„æºï¼ŒstateåŠ ä¸€ï¼Œå¹¶ä¸”å”¤é†’åç»§çº¿ç¨‹</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630151849964.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="147-countdownlatch">14.7 CountdownLatch</h3>
<p>ç”¨äºç­‰å¾…å¤šä¸ªçº¿ç¨‹ä»»åŠ¡å…±åŒæ‰§è¡Œç»“æŸï¼Œè¿›è¡ŒåŒæ­¥çš„ä¸€ä¸ªé”ï¼Œstate=nï¼Œåˆ™ä»£è¡¨æœ‰nä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œçº¿ç¨‹æ‰§è¡Œå®Œæ¯•è°ƒç”¨CountDown()æ–¹æ³•æ¥å°†state-1ï¼Œå½“stateä¸º0æ—¶ï¼Œç­‰å¾…çº¿ç¨‹ç»“æŸç­‰å¾…ï¼Œè¢«å”¤é†’ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆä¸ç”¨join">ä¸ºä»€ä¹ˆä¸ç”¨Join</h4>
<p>Joinéœ€è¦ç­‰å¾…çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œæ‰ä¼šå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½è¦å®Œæˆå¤šé¡¹ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦åŒæ­¥çš„è¿‡ç¨‹å‘ç”Ÿåœ¨ä¸­é€”ï¼Œæ­¤æ—¶å°±æ— æ³•ä½¿ç”¨Join</p>
<h4 id="åº”ç”¨-1">åº”ç”¨</h4>
<h5 id="ç­‰å¾…å¤šä¸ªçº¿ç¨‹å‡†å¤‡å®Œæ¯•">ç­‰å¾…å¤šä¸ªçº¿ç¨‹å‡†å¤‡å®Œæ¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span><span class="o">[]</span> <span class="n">all</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">10</span><span class="o">];</span>
</span></span><span class="line"><span class="cl"><span class="n">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">10</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span><span class="n">100</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">100</span><span class="o">)+</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">all</span><span class="o">[</span><span class="n">flag</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="s">&#34;%&#34;</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;\r&#34;</span><span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">all</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Game Start&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ">ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</h5>
<h3 id="148-cyclicbarrier">14.8 CyclicBarrier</h3>
<p>åˆ©ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¥è®°å½•é˜»å¡çš„çº¿ç¨‹æ•°ï¼Œæ¯æœ‰ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹è¿›å…¥ï¼Œå°†ä¼šå‡å°‘countï¼Œå½“countå‡å°‘ä¸º0æ—¶ï¼Œåˆ™å°†å”¤é†’æ‰€æœ‰é˜»å¡çº¿ç¨‹ï¼Œä»¥åŠè°ƒç”¨è‡ªèº«çš„Runnableçº¿ç¨‹(å¦‚æœæœ‰çš„è¯)ï¼Œå…±åŒå‘ä¸‹æ‰§è¡Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="nf">dowait</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">timed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanos</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">BrokenBarrierException</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Generation</span> <span class="n">g</span> <span class="o">=</span> <span class="n">generation</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">BrokenBarrierException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">--</span><span class="n">count</span><span class="o">;</span><span class="c1">//è‡ªå‡åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//å½“index==0;å”¤é†’æ‰€æœ‰çš„é˜»å¡çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">ranAction</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">command</span> <span class="o">=</span> <span class="n">barrierCommand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">command</span><span class="o">.</span><span class="na">run</span><span class="o">();</span><span class="c1">//æ‰§è¡ŒCyclicBarrierçš„ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ranAction</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">nextGeneration</span><span class="o">();</span><span class="c1">//å°†countæ¢å¤ï¼Œå¹¶ä¸”å”¤é†’æ‰€æœ‰çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">ranAction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è‡ªæ—‹é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">timed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">trip</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">0L</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nanos</span> <span class="o">=</span> <span class="n">trip</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="n">ie</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">BrokenBarrierException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">!=</span> <span class="n">generation</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">timed</span> <span class="o">&amp;&amp;</span> <span class="n">nanos</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åº”ç”¨-2">åº”ç”¨</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">CyclicBarrier</span> <span class="n">cyclicBarrier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CyclicBarrier</span><span class="o">(</span><span class="n">2</span><span class="o">,()-&gt;{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;GO GO GO&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">3</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} start&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">cyclicBarrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} end&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">BrokenBarrierException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} start&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cyclicBarrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} end&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">BrokenBarrierException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/juc/">JUC</a>
        
            <a href="/tags/java/">Java</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed Genius 1942</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/innodb/">
        
        
            <div class="article-image">
                <img src="/p/innodb/_hu8c1e6e7c956faffb6e0fe62077ace01b_532582_3a6d5485b7dbe4b83eee044c2bee2f17.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post InnoDB"
                        
                        data-hash="md5-Tsd9OVywVPg9MBHescMPmQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">InnoDB</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Genius
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#1-å¹¶å‘ç¼–ç¨‹">1 å¹¶å‘ç¼–ç¨‹</a>
      <ol>
        <li><a href="#11-å¹¶å‘ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹">1.1 å¹¶å‘ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹</a>
          <ol>
            <li><a href="#ä¼˜ç‚¹">ä¼˜ç‚¹ï¼š</a></li>
            <li><a href="#ç¼ºç‚¹">ç¼ºç‚¹ï¼š</a></li>
          </ol>
        </li>
        <li><a href="#12-å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ">1.2 å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ </a>
          <ol>
            <li><a href="#å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ">å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ </a></li>
            <li><a href="#å‡ºç°å®‰å…¨é—®é¢˜çš„åŸå› ">å‡ºç°å®‰å…¨é—®é¢˜çš„åŸå› ï¼š</a></li>
            <li><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li>
          </ol>
        </li>
        <li><a href="#13-ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹">1.3 ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹</a></li>
      </ol>
    </li>
    <li><a href="#2-è¿›ç¨‹ä¸çº¿ç¨‹çš„ä»‹ç»">2 è¿›ç¨‹ä¸çº¿ç¨‹çš„ä»‹ç»</a>
      <ol>
        <li><a href="#21-è¿›ç¨‹ä¸çº¿ç¨‹">2.1 è¿›ç¨‹ä¸çº¿ç¨‹</a>
          <ol>
            <li><a href="#è¿›ç¨‹">è¿›ç¨‹</a></li>
            <li><a href="#çº¿ç¨‹">çº¿ç¨‹</a></li>
            <li><a href="#è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«">è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«</a></li>
            <li><a href="#äºŒè€…å¯¹æ¯”">äºŒè€…å¯¹æ¯”</a></li>
          </ol>
        </li>
        <li><a href="#22-å¹¶è¡Œå’Œå¹¶å‘">2.2 å¹¶è¡Œå’Œå¹¶å‘</a>
          <ol>
            <li><a href="#å¹¶è¡Œ">å¹¶è¡Œ</a></li>
            <li><a href="#å¹¶å‘">å¹¶å‘</a></li>
          </ol>
        </li>
        <li><a href="#23-åŒæ­¥ä¸å¼‚æ­¥">2.3 åŒæ­¥ä¸å¼‚æ­¥</a>
          <ol>
            <li><a href="#åŒæ­¥">åŒæ­¥</a></li>
            <li><a href="#å¼‚æ­¥">å¼‚æ­¥</a></li>
          </ol>
        </li>
        <li><a href="#24-æ€è€ƒ">2.4 æ€è€ƒ</a>
          <ol>
            <li><a href="#å¤šçº¿ç¨‹ä¸€å®šèƒ½æå‡ç¨‹åºè¿è¡Œæ•ˆç‡å—">å¤šçº¿ç¨‹ä¸€å®šèƒ½æå‡ç¨‹åºè¿è¡Œæ•ˆç‡å—ï¼Ÿ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#3-javaçº¿ç¨‹">3 Javaçº¿ç¨‹</a>
      <ol>
        <li><a href="#31-åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹">3.1 åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</a>
          <ol>
            <li><a href="#threadåˆ›å»º">Threadåˆ›å»º</a></li>
            <li><a href="#runnableåˆ›å»º">Runnableåˆ›å»º</a></li>
            <li><a href="#lambdaç®€åŒ–">Lambdaç®€åŒ–</a></li>
            <li><a href="#futuretaskåˆ›å»º">FutureTaskåˆ›å»º</a></li>
            <li><a href="#runnableå’Œcallableçš„åŒºåˆ«">Runnableå’ŒCallableçš„åŒºåˆ«</a></li>
          </ol>
        </li>
        <li><a href="#32-threadrunnableæºç åŸç†">3.2 Threadï¼ŒRunnableæºç åŸç†</a>
          <ol>
            <li><a href="#new-thread">new Thread()</a></li>
          </ol>
        </li>
        <li><a href="#33-javaè¿›ç¨‹æŸ¥çœ‹">3.3 Javaè¿›ç¨‹æŸ¥çœ‹</a>
          <ol>
            <li><a href="#windowsè¿›ç¨‹æŸ¥çœ‹å‘½ä»¤">Windowsè¿›ç¨‹æŸ¥çœ‹å‘½ä»¤</a></li>
            <li><a href="#ä½¿ç”¨jconsoleæ¥è¿›è¡Œè¿›ç¨‹æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯">ä½¿ç”¨Jconsoleæ¥è¿›è¡Œè¿›ç¨‹æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯</a></li>
          </ol>
        </li>
        <li><a href="#34-çº¿ç¨‹è¿è¡ŒåŸç†">3.4 çº¿ç¨‹è¿è¡ŒåŸç†</a>
          <ol>
            <li><a href="#æ ˆå¸§ä¸å¤šè¯´äº†csdnæœ‰ç¬”è®°">æ ˆå¸§ä¸å¤šè¯´äº†ï¼ŒCSDNæœ‰ç¬”è®°</a></li>
            <li><a href="#çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢">çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li>
          </ol>
        </li>
        <li><a href="#35-çº¿ç¨‹æ–¹æ³•è¯¦è§£start--run">3.5 çº¿ç¨‹æ–¹æ³•è¯¦è§£:start &amp; run</a>
          <ol>
            <li><a href="#runæ–¹æ³•">runæ–¹æ³•</a></li>
            <li><a href="#startæ–¹æ³•">startæ–¹æ³•</a></li>
            <li><a href="#start0åº•å±‚æºç "><strong>start0åº•å±‚æºç </strong></a></li>
          </ol>
        </li>
        <li><a href="#36-çº¿ç¨‹æ–¹æ³•è¯¦è§£-sleepä¸yield">3.6 çº¿ç¨‹æ–¹æ³•è¯¦è§£: sleepä¸yield</a>
          <ol>
            <li><a href="#sleep-æºç è§£æ">sleep æºç è§£æ</a></li>
            <li><a href="#yield-æºç è§£æ">yield æºç è§£æ</a></li>
            <li><a href="#åœ¨javaä¸­sleepå’Œyieldçš„åŒºåˆ«"><strong>åœ¨Javaä¸­Sleepå’Œyieldçš„åŒºåˆ«</strong></a></li>
            <li><a href="#çº¿ç¨‹ä¼˜å…ˆçº§">çº¿ç¨‹ä¼˜å…ˆçº§</a></li>
          </ol>
        </li>
        <li><a href="#37-æ¡ˆä¾‹-é˜²æ­¢cpuå ç”¨100">3.7 æ¡ˆä¾‹-é˜²æ­¢CPUå ç”¨100%</a></li>
        <li><a href="#38-join">3.8 Join</a>
          <ol>
            <li><a href="#èƒ½ä¸èƒ½ç”¨sleepä¸ºä»€ä¹ˆ">èƒ½ä¸èƒ½ç”¨sleepï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</a></li>
            <li><a href="#join">Join</a></li>
            <li><a href="#joinåŸç†">JoinåŸç†</a></li>
          </ol>
        </li>
        <li><a href="#39-interrupt-æ–¹æ³•è¯¦è§£">3.9 interrupt æ–¹æ³•è¯¦è§£</a>
          <ol>
            <li><a href="#æ‰“æ–­sleepwaitjoinçº¿ç¨‹">æ‰“æ–­sleepï¼Œwaitï¼Œjoinçº¿ç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#310-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼">3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</a>
          <ol>
            <li><a href="#é”™è¯¯æ€è·¯">é”™è¯¯æ€è·¯</a></li>
            <li><a href="#æ­£ç¡®æ€è·¯">æ­£ç¡®æ€è·¯</a></li>
          </ol>
        </li>
        <li><a href="#311-parkunpark">3.11 Park&amp;UnPark</a>
          <ol>
            <li><a href="#ç‰¹ç‚¹">ç‰¹ç‚¹</a></li>
            <li><a href="#åŸç†">åŸç†</a></li>
            <li><a href="#æµç¨‹å›¾">æµç¨‹å›¾</a></li>
          </ol>
        </li>
        <li><a href="#312-å®ˆæŠ¤çº¿ç¨‹">3.12 å®ˆæŠ¤çº¿ç¨‹</a>
          <ol>
            <li></li>
            <li><a href="#å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢">å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</a></li>
          </ol>
        </li>
        <li><a href="#313-çº¿ç¨‹çŠ¶æ€">3.13 çº¿ç¨‹çŠ¶æ€</a>
          <ol>
            <li><a href="#äº”ç§çŠ¶æ€">äº”ç§çŠ¶æ€</a></li>
            <li><a href="#å…­ç§çŠ¶æ€">å…­ç§çŠ¶æ€</a></li>
            <li><a href="#javaé‡‡ç”¨çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•">Javaé‡‡ç”¨çš„çº¿ç¨‹è°ƒåº¦ç®—æ³•</a></li>
            <li><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨thread-schedulerå’Œæ—¶é—´åˆ†ç‰‡time-slicing-">ä»€ä¹ˆæ˜¯çº¿ç¨‹è°ƒåº¦å™¨(Thread Scheduler)å’Œæ—¶é—´åˆ†ç‰‡(Time Slicing )ï¼Ÿ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#4-å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹">4 å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</a>
      <ol>
        <li><a href="#41-ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜">4.1 ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</a></li>
        <li><a href="#42-ä¸´ç•ŒåŒºcritical-section">4.2 ä¸´ç•ŒåŒºCritical Section</a>
          <ol>
            <li><a href="#ç«æ€æ¡ä»¶">ç«æ€æ¡ä»¶</a></li>
          </ol>
        </li>
        <li><a href="#43-synchronized-è§£å†³æ–¹æ¡ˆ">4.3 synchronized è§£å†³æ–¹æ¡ˆ</a>
          <ol>
            <li></li>
          </ol>
        </li>
        <li><a href="#44-å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ">4.4 å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</a>
          <ol>
            <li><a href="#å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ">å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ</a></li>
          </ol>
        </li>
        <li><a href="#45-å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»">4.5 å¸¸è§çš„çº¿ç¨‹å®‰å…¨ç±»</a>
          <ol>
            <li><a href="#ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§">ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§</a></li>
          </ol>
        </li>
        <li><a href="#46-æ¡ˆä¾‹">4.6 æ¡ˆä¾‹</a>
          <ol>
            <li><a href="#é“¶è¡Œè½¬é’±">é“¶è¡Œè½¬é’±</a></li>
          </ol>
        </li>
        <li><a href="#47-monitoræ¦‚å¿µ">4.7 Monitoræ¦‚å¿µ</a>
          <ol>
            <li><a href="#javaå¯¹è±¡å¤´">Javaå¯¹è±¡å¤´</a></li>
            <li><a href="#monitoré”">Monitor(é”)</a></li>
            <li><a href="#synchronizedå­—èŠ‚ç è§£æ">synchronizedå­—èŠ‚ç è§£æ</a></li>
          </ol>
        </li>
        <li><a href="#48-è½»é‡çº§é”">4.8 è½»é‡çº§é”</a></li>
        <li><a href="#49-é”è†¨èƒ€">4.9 é”è†¨èƒ€</a></li>
        <li><a href="#410-è‡ªæ—‹ä¼˜åŒ–å¤šæ ¸cpu">4.10 è‡ªæ—‹ä¼˜åŒ–(å¤šæ ¸CPU)</a></li>
        <li><a href="#411-åå‘é”">4.11 åå‘é”</a>
          <ol>
            <li><a href="#åå‘é”è·å–è¿‡ç¨‹">åå‘é”è·å–è¿‡ç¨‹</a></li>
            <li><a href="#åå‘çŠ¶æ€">åå‘çŠ¶æ€</a></li>
            <li><a href="#åå‘é”æ’¤é”€">åå‘é”æ’¤é”€</a></li>
            <li><a href="#æ‰¹é‡é‡åå‘">æ‰¹é‡é‡åå‘</a></li>
            <li><a href="#æ‰¹é‡æ’¤é”€">æ‰¹é‡æ’¤é”€</a></li>
          </ol>
        </li>
        <li><a href="#412-é”ç²—åŒ–">4.12 é”ç²—åŒ–</a></li>
        <li><a href="#413-é”æ¶ˆé™¤">4.13 é”æ¶ˆé™¤</a></li>
        <li><a href="#414-æ´»è·ƒæ€§">4.14 æ´»è·ƒæ€§</a>
          <ol>
            <li><a href="#æ­»é”">æ­»é”</a></li>
            <li><a href="#å“²å­¦å®¶é—®é¢˜">å“²å­¦å®¶é—®é¢˜</a></li>
            <li><a href="#æ´»é”">æ´»é”</a></li>
            <li><a href="#é¥¥é¥¿">é¥¥é¥¿</a></li>
          </ol>
        </li>
        <li><a href="#415-ä»æºç å»çœ‹synchronized">4.15 ä»æºç å»çœ‹synchronized</a>
          <ol>
            <li><a href="#monitorç»“æ„">monitorç»“æ„</a></li>
            <li><a href="#monitorenterinterpeterruntimecpp">monitorenter(interpeterRuntime.cpp)</a></li>
            <li><a href="#åå‘é”ç¯èŠ‚">åå‘é”ç¯èŠ‚</a></li>
            <li><a href="#è½»é‡çº§é”ç¯èŠ‚">è½»é‡çº§é”ç¯èŠ‚</a></li>
            <li><a href="#é‡é‡çº§é”ç¯èŠ‚">é‡é‡çº§é”ç¯èŠ‚</a></li>
          </ol>
        </li>
        <li><a href="#51-åŸç†ä¹‹-wait--notify">5.1 åŸç†ä¹‹ wait / notify</a>
          <ol>
            <li><a href="#apiä»‹ç»åªèƒ½åœ¨åŒæ­¥ä»£ç å—ä½¿ç”¨">APIä»‹ç»ï¼ˆåªèƒ½åœ¨åŒæ­¥ä»£ç å—ä½¿ç”¨ï¼‰</a></li>
            <li><a href="#ä¸ºä»€ä¹ˆ-wait-notifyå’Œ-notifyallå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨">ä¸ºä»€ä¹ˆ wait(), notify()å’Œ notifyAll()å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ</a></li>
          </ol>
        </li>
        <li><a href="#52-wait-notifyçš„æ­£ç¡®å§¿åŠ¿">5.2 wait notifyçš„æ­£ç¡®å§¿åŠ¿</a>
          <ol>
            <li><a href="#sleep-å’Œ-wait-çš„åŒºåˆ«">sleep() å’Œ wait() çš„åŒºåˆ«</a></li>
            <li><a href="#å…±åŒç‚¹">å…±åŒç‚¹ï¼š</a></li>
            <li><a href="#step1">step1:</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ">åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</a>
      <ol>
        <li><a href="#å®šä¹‰">å®šä¹‰</a>
          <ol>
            <li><a href="#è¦ç‚¹">è¦ç‚¹</a></li>
          </ol>
        </li>
        <li><a href="#å®ç°">å®ç°</a>
          <ol>
            <li><a href="#guardedobjectç±»å®ç°">GuardedObjectç±»å®ç°</a></li>
            <li><a href="#ä¿æŠ¤æ€§æš‚åœæ¨¡å¼å®ç°">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼å®ç°</a></li>
            <li><a href="#ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–</a></li>
            <li><a href="#ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–2">ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ä¼˜åŒ–2</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…">å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…</a>
      <ol>
        <li><a href="#å®šä¹‰-1">å®šä¹‰</a>
          <ol>
            <li><a href="#è¦ç‚¹-1">è¦ç‚¹</a></li>
            <li><a href="#å®ç°-1">å®ç°</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#6-çº¿ç¨‹åˆ‡æ¢">6 çº¿ç¨‹åˆ‡æ¢</a>
      <ol>
        <li><a href="#61-é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢">6.1 é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</a>
          <ol>
            <li><a href="#æƒ…å†µ1-new----runnable">æƒ…å†µ1 NEW &ndash;&gt; RUNNABLE</a></li>
            <li><a href="#æƒ…å†µ2-runnable-----waiting">æƒ…å†µ2 RUNNABLE &lt;&mdash;&gt; WAITING</a></li>
            <li><a href="#æƒ…å†µ3-runnable-----waiting">æƒ…å†µ3 RUNNABLE &lt;&mdash;&gt; WAITING</a></li>
            <li><a href="#æƒ…å†µ4-runnable----waiting">æƒ…å†µ4 RUNNABLE &lt;&ndash;&gt; WAITING</a></li>
            <li><a href="#æƒ…å†µ5-runnable----timed_waiting">æƒ…å†µ5 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#æƒ…å†µ6-runnable----timed_waiting">æƒ…å†µ6 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#æƒ…å†µ7-runnable----timed_waiting">æƒ…å†µ7 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#æƒ…å†µ8-runnable----timed_waiting">æƒ…å†µ8 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#æƒ…å†µ9-runnable----terminated">æƒ…å†µ9 RUNNABLE &lt;&ndash;&gt; TERMINATED</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#8-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶">8 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</a>
      <ol>
        <li>
          <ol>
            <li><a href="#å›ºå®šè¿è¡Œé¡ºåº">å›ºå®šè¿è¡Œé¡ºåº</a></li>
            <li><a href="#äº¤æ›¿è¾“å‡º">äº¤æ›¿è¾“å‡º</a></li>
            <li><a href="#wait-notifyç‰ˆæœ¬">wait-notifyç‰ˆæœ¬</a></li>
            <li><a href="#await-signalç‰ˆæœ¬">await-signalç‰ˆæœ¬</a></li>
            <li><a href="#park-unparkç‰ˆæœ¬">park-unparkç‰ˆæœ¬</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#9-å…±äº«æ¨¡å‹ä¹‹å†…å­˜">9 å…±äº«æ¨¡å‹ä¹‹å†…å­˜</a>
      <ol>
        <li><a href="#91-javaå†…å­˜æ¨¡å‹">9.1 Javaå†…å­˜æ¨¡å‹</a>
          <ol>
            <li><a href="#ç®€ä»‹">ç®€ä»‹</a></li>
          </ol>
        </li>
        <li><a href="#92-å¯è§æ€§">9.2 å¯è§æ€§</a>
          <ol>
            <li><a href="#ç®€ä»‹-1"><strong>ç®€ä»‹ï¼š</strong></a></li>
            <li><a href="#å®šä¹‰-2">å®šä¹‰:</a></li>
            <li><a href="#é—®é¢˜">é—®é¢˜</a></li>
            <li><a href="#ç»“æœ">ç»“æœ</a></li>
            <li><a href="#åŸç†-1">åŸç†</a></li>
            <li><a href="#è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</a></li>
            <li><a href="#synchronized-vs-volatile">Synchronized vs Volatile</a></li>
            <li><a href="#ä½¿ç”¨volatileçš„ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼">ä½¿ç”¨volatileçš„ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</a></li>
            <li><a href="#åŒæ­¥æ¨¡å¼ä¹‹balking">åŒæ­¥æ¨¡å¼ä¹‹Balking</a></li>
          </ol>
        </li>
        <li><a href="#93-æœ‰åºæ€§">9.3 æœ‰åºæ€§</a>
          <ol>
            <li><a href="#ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’">ä»€ä¹ˆæ˜¯ã€æŒ‡ä»¤é‡æ’ã€‘ï¼Ÿ</a></li>
            <li><a href="#ä¸ºä»€ä¹ˆè¦æœ‰æŒ‡ä»¤é‡æ’è¿™ä¸€ç‰¹æ€§å‘¢">ä¸ºä»€ä¹ˆè¦æœ‰ã€æŒ‡ä»¤é‡æ’ã€‘è¿™ä¸€ç‰¹æ€§å‘¢ï¼Ÿ</a></li>
            <li><a href="#è¯¡å¼‚çš„ç»“æœ">è¯¡å¼‚çš„ç»“æœ</a></li>
          </ol>
        </li>
        <li><a href="#94-volatile-åŸç†">9.4 volatile åŸç†</a>
          <ol>
            <li><a href="#å¦‚ä½•ä¿è¯å¯è§æ€§">å¦‚ä½•ä¿è¯å¯è§æ€§</a></li>
            <li><a href="#å¦‚ä½•ä¿è¯æœ‰åºæ€§">å¦‚ä½•ä¿è¯æœ‰åºæ€§</a></li>
            <li><a href="#double-checked-locking-é—®é¢˜">double-checked locking é—®é¢˜</a></li>
            <li><a href="#happens-before">happens-before</a></li>
          </ol>
        </li>
        <li><a href="#95-çº¿ç¨‹å®‰å…¨å•ä¾‹">9.5 çº¿ç¨‹å®‰å…¨å•ä¾‹</a>
          <ol>
            <li></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#10-ä¿æŠ¤å…±äº«èµ„æº-æ— é”å®ç°">10 ä¿æŠ¤å…±äº«èµ„æº-æ— é”å®ç°</a>
      <ol>
        <li><a href="#101-atomicinteger">10.1 AtomicInteger</a>
          <ol>
            <li></li>
            <li><a href="#æœ‰é”æŠ€æœ¯å®ç°èµ„æºå…±äº«">æœ‰é”æŠ€æœ¯å®ç°èµ„æºå…±äº«</a></li>
            <li><a href="#æ— æ‰€æŠ€æœ¯å®ç°èµ„æºå…±äº«">æ— æ‰€æŠ€æœ¯å®ç°èµ„æºå…±äº«</a></li>
            <li><a href="#ç»“æœæ¯”è¾ƒ">ç»“æœæ¯”è¾ƒ</a></li>
          </ol>
        </li>
        <li><a href="#102-casä¸volatile">10.2 CASä¸volatile</a>
          <ol>
            <li><a href="#ä¸ºä»€ä¹ˆ-compareandset-å¯ä»¥å®ç°ä¸åŠ é”ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜">ä¸ºä»€ä¹ˆ compareAndSet å¯ä»¥å®ç°ä¸åŠ é”ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</a></li>
            <li><a href="#volatile-ä¸-casä¹‹é—´çš„å…³ç³»">volatile ä¸ CASä¹‹é—´çš„å…³ç³»</a></li>
            <li><a href="#ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜">ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜ï¼Ÿ</a></li>
            <li><a href="#casçš„ç‰¹ç‚¹">CASçš„ç‰¹ç‚¹</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#11-åŸå­">11 åŸå­</a>
      <ol>
        <li><a href="#111-åŸå­æ•´æ•°">11.1 åŸå­æ•´æ•°</a>
          <ol>
            <li><a href="#ä¾‹atomicinteger">ä¾‹ï¼šAtomicInteger</a></li>
          </ol>
        </li>
        <li><a href="#112-åŸå­å¼•ç”¨">11.2 åŸå­å¼•ç”¨</a>
          <ol>
            <li><a href="#abaé—®é¢˜">ABAé—®é¢˜</a></li>
            <li><a href="#atomicstampedreference">AtomicStampedReference</a></li>
            <li><a href="#atomicmarkablereference">AtomicMarkableReference</a></li>
          </ol>
        </li>
        <li><a href="#113-åŸå­æ•°ç»„">11.3 åŸå­æ•°ç»„</a></li>
        <li><a href="#114-åŸå­æ›´æ–°å™¨">11.4 åŸå­æ›´æ–°å™¨</a></li>
        <li><a href="#115-åŸå­ç´¯åŠ å™¨">11.5 åŸå­ç´¯åŠ å™¨</a>
          <ol>
            <li><a href="#æºç ä¹‹longadder">æºç ä¹‹LongAdder</a></li>
          </ol>
        </li>
        <li><a href="#116-unsafe">11.6 Unsafe</a>
          <ol>
            <li><a href="#æ¦‚è¿°">æ¦‚è¿°</a></li>
            <li><a href="#unsafe-casæ“ä½œ">Unsafe CASæ“ä½œ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#12-ä¸å¯å˜ç±»">12 ä¸å¯å˜ç±»</a>
      <ol>
        <li><a href="#121-ä¸å¯å˜ç±»çš„è®¾è®¡">12.1 ä¸å¯å˜ç±»çš„è®¾è®¡</a>
          <ol>
            <li><a href="#1-finalçš„ä½¿ç”¨">1. finalçš„ä½¿ç”¨</a></li>
            <li><a href="#2ä¿æŠ¤æ€§æ‹·è´">2.ä¿æŠ¤æ€§æ‹·è´</a></li>
          </ol>
        </li>
        <li><a href="#122-äº«å…ƒæ¨¡å¼">12.2 äº«å…ƒæ¨¡å¼</a></li>
        <li><a href="#123-è‡ªå®šä¹‰è¿æ¥æ± ">12.3 è‡ªå®šä¹‰è¿æ¥æ± </a>
          <ol>
            <li><a href="#è¿æ¥æ± åŠŸèƒ½">è¿æ¥æ± åŠŸèƒ½ï¼š</a></li>
          </ol>
        </li>
        <li><a href="#124-finalåŸç†">12.4 finalåŸç†</a>
          <ol>
            <li><a href="#1è®¾ç½®finalå˜é‡çš„åŸç†">1ï¼Œè®¾ç½®finalå˜é‡çš„åŸç†</a></li>
            <li><a href="#2è·å–finalå˜é‡çš„åŸç†">2ï¼Œè·å–finalå˜é‡çš„åŸç†</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#13-çº¿ç¨‹æ± ">13 çº¿ç¨‹æ± </a>
      <ol>
        <li><a href="#131-æ‰‹å†™çº¿ç¨‹æ± ">13.1 æ‰‹å†™çº¿ç¨‹æ± </a>
          <ol>
            <li><a href="#1blockingqueue-é˜»å¡é˜Ÿåˆ—">1,BlockingQueue é˜»å¡é˜Ÿåˆ—</a></li>
            <li><a href="#2threadpool-çº¿ç¨‹æ± ">2ï¼ŒThreadPool çº¿ç¨‹æ± </a></li>
          </ol>
        </li>
        <li><a href="#132-threadpoolexecutor">13.2 ThreadPoolExecutor</a>
          <ol>
            <li><a href="#1çº¿ç¨‹æ± çŠ¶æ€">1ï¼Œçº¿ç¨‹æ± çŠ¶æ€</a></li>
            <li><a href="#2æ„é€ æ–¹æ³•">2ï¼Œæ„é€ æ–¹æ³•</a></li>
            <li><a href="#3å·¥å‚æ–¹æ³•æ„é€ çº¿ç¨‹æ± ">3ï¼Œå·¥å‚æ–¹æ³•æ„é€ çº¿ç¨‹æ± </a></li>
            <li><a href="#4æäº¤ä»»åŠ¡">4ï¼Œæäº¤ä»»åŠ¡</a></li>
            <li><a href="#5å…³é—­çº¿ç¨‹æ± ">5ï¼Œ<strong>å…³é—­çº¿ç¨‹æ± </strong></a></li>
          </ol>
        </li>
        <li><a href="#133-åˆ›å»ºçº¿ç¨‹æ± å¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚å‘¢">13.3 åˆ›å»ºçº¿ç¨‹æ± å¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚å‘¢</a>
          <ol>
            <li><a href="#1cpuå¯†é›†å‹è¿ç®—">1ï¼ŒCPUå¯†é›†å‹è¿ç®—</a></li>
            <li><a href="#2ioå¯†é›†å‹è¿ç®—">2ï¼ŒI/Oå¯†é›†å‹è¿ç®—</a></li>
          </ol>
        </li>
        <li><a href="#134-tomcatçº¿ç¨‹æ± ">13.4 Tomcatçº¿ç¨‹æ± </a></li>
        <li><a href="#135-forkjoin">13.5 Fork/Join</a>
          <ol>
            <li><a href="#1æ¦‚å¿µ">1ï¼Œæ¦‚å¿µ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#14-juc">14 JUC</a>
      <ol>
        <li><a href="#141-aqs">14.1 AQS</a>
          <ol>
            <li><a href="#1æ¦‚è¿°">1,æ¦‚è¿°</a></li>
          </ol>
        </li>
        <li><a href="#142reentrantlock">14.2ï¼ŒReentrantLock</a>
          <ol>
            <li></li>
            <li><a href="#å¯é‡å…¥">å¯é‡å…¥</a></li>
            <li><a href="#å¯æ‰“æ–­">å¯æ‰“æ–­</a></li>
            <li><a href="#é”è¶…æ—¶">é”è¶…æ—¶</a></li>
            <li><a href="#å…¬å¹³é”">å…¬å¹³é”</a></li>
            <li><a href="#æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</a></li>
          </ol>
        </li>
        <li><a href="#143-åŸç†">14.3 åŸç†</a>
          <ol>
            <li><a href="#1åŠ é”ä»¥åŠç«äº‰é”">1ï¼ŒåŠ é”ä»¥åŠç«äº‰é”</a></li>
            <li><a href="#2è§£é”æµç¨‹">2ï¼Œè§£é”æµç¨‹</a></li>
            <li><a href="#3å¯é‡å…¥">3ï¼Œå¯é‡å…¥</a></li>
            <li><a href="#4å¯æ‰“æ–­">4ï¼Œå¯æ‰“æ–­</a></li>
            <li><a href="#5å…¬å¹³é”">5ï¼Œ<strong>å…¬å¹³é”</strong></a></li>
            <li><a href="#6æ¡ä»¶å˜é‡å®ç°åŸç†">6ï¼Œæ¡ä»¶å˜é‡å®ç°åŸç†</a></li>
          </ol>
        </li>
        <li><a href="#144-reentrantreadwritelock">14.4 ReentrantReadWriteLock</a>
          <ol>
            <li><a href="#ç‰¹æ€§">ç‰¹æ€§ï¼š</a></li>
            <li><a href="#åº”ç”¨ç¼“å­˜æ›´æ–°">åº”ç”¨ï¼šç¼“å­˜æ›´æ–°</a></li>
            <li><a href="#åŸç†-2">åŸç†ï¼š</a></li>
            <li><a href="#æµç¨‹å›¾-1">æµç¨‹å›¾</a></li>
          </ol>
        </li>
        <li><a href="#145-stampedlock">14.5 StampedLock</a>
          <ol>
            <li><a href="#stampedlockæ€§èƒ½æ¯”readwritelockå¥½çš„åŸå› ">StampedLockæ€§èƒ½æ¯”ReadWriteLockå¥½çš„åŸå› </a></li>
            <li><a href="#åŸç†-3">åŸç†</a></li>
            <li><a href="#é”çŠ¶æ€ç›¸å…³å±æ€§">é”çŠ¶æ€ç›¸å…³å±æ€§</a></li>
            <li><a href="#èŠ‚ç‚¹">èŠ‚ç‚¹</a></li>
            <li><a href="#è‡ªæ—‹æ¬¡æ•°ä¼˜åŒ–">è‡ªæ—‹æ¬¡æ•°ä¼˜åŒ–</a></li>
            <li><a href="#æ³¨æ„">æ³¨æ„</a></li>
          </ol>
        </li>
        <li><a href="#146-semaphore">14.6 Semaphore</a>
          <ol>
            <li><a href="#semaphoreåº”ç”¨">Semaphoreåº”ç”¨</a></li>
            <li><a href="#åŸç†-4">åŸç†</a></li>
          </ol>
        </li>
        <li><a href="#147-countdownlatch">14.7 CountdownLatch</a>
          <ol>
            <li><a href="#ä¸ºä»€ä¹ˆä¸ç”¨join">ä¸ºä»€ä¹ˆä¸ç”¨Join</a></li>
            <li><a href="#åº”ç”¨-1">åº”ç”¨</a></li>
          </ol>
        </li>
        <li><a href="#148-cyclicbarrier">14.8 CyclicBarrier</a>
          <ol>
            <li><a href="#åº”ç”¨-2">åº”ç”¨</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
